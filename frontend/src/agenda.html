<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda - ParoquiaON</title>
    <link rel="icon" type="image/png" href="assets/images/logo2.png">
    <link rel="stylesheet" href="styles/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Reset e configurações básicas */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            overflow-x: hidden;
        }

        /* Layout principal */
        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* Barra superior ocupando toda a largura */
        .top-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: #1e3a8a;
            color: white;
            padding: 0 30px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Sidebar esquerda */
        .left-sidebar {
            width: 300px;
            background: #f8f9fa;
            border-right: none;
            display: flex;
            flex-direction: column;
            position: fixed;
            left: 0;
            top: 80px;
            height: calc(100vh - 80px);
            z-index: 100;
            padding: 0;
            overflow-y: auto;
        }

        /* Container lateral para o calendário */
        .sidebar-content {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 0;
        }


        /* Botão Criar */
        .create-button {
            margin: 20px 20px 15px 20px;
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(30, 58, 138, 0.25);
            position: relative;
            z-index: 10;
            width: calc(100% - 40px);
        }

        .create-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 58, 138, 0.35);
        }

        /* Botão Multplus */
        .multplus-btn {
            margin: 0 20px 15px 20px;
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(30, 58, 138, 0.25);
            position: relative;
            z-index: 10;
            width: calc(100% - 40px);
        }

        .multplus-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 58, 138, 0.35);
        }

        /* CSS do Multplus removido - modal não disponível */

        /* Modal de Evento */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(6px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(0, 0, 0, 0.1);
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
            display: flex;
            flex-direction: column;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: scale(0.95) translateY(-20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e5e7eb;
            flex-shrink: 0;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
            color: #1e3a8a;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-title i {
            color: #1e3a8a;
        }

        /* CSS mais específico para o título do modal */
        .modal-header h2 {
            font-size: 24px;
            font-weight: 600;
            color: #1e3a8a !important;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-header h2 i {
            color: #1e3a8a !important;
        }

        #modalTitle {
            color: #1e3a8a !important;
        }

        .modal-body {
            overflow-y: auto;
            flex: 1;
            padding-right: 10px;
        }

        /* Garantir que o modal-body não corte o checkbox */
        .modal-body .form-group:has(.checkbox-group) {
            overflow: visible !important;
            max-height: none !important;
        }

        /* Scrollbar personalizado para o modal */
        .modal-body::-webkit-scrollbar {
            width: 6px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .modal-body::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            border-color: #1e3a8a;
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }

        .form-input::placeholder {
            color: #9ca3af;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 58, 138, 0.35);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 2px solid #e5e7eb;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
            transform: translateY(-1px);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #6b7280;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: #f5f5f5;
            color: #333;
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .modal-content {
                margin: 20px;
                max-width: calc(100% - 40px);
            padding: 20px;
            }
            
            .modal-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Estilos das Seções do Formulário */
        .form-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .section-title {
            margin: 0 0 20px 0;
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #1e3a8a;
        }

        .section-title i {
            color: #1e3a8a;
            font-size: 1.1em;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: flex-start;
        }

        .form-group {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group label i {
            margin-right: 5px;
            color: #1e3a8a;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        /* Estilos específicos para selects */
        .form-group select {
            max-height: 200px !important;
            overflow-y: auto !important;
            background-color: white;
            cursor: pointer;
            height: auto !important;
        }

        /* Forçar altura máxima para todos os selects do modal */
        #eventModal select {
            max-height: 200px !important;
            overflow-y: auto !important;
            height: auto !important;
        }

        /* Estilo específico para selects com muitas opções */
        select[size] {
            max-height: 200px !important;
            overflow-y: auto !important;
        }

        /* Scrollbar personalizado para selects */
        .form-group select::-webkit-scrollbar {
            width: 8px;
        }

        .form-group select::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .form-group select::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .form-group select::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Limitar altura das opções do select */
        .form-group select option {
            padding: 8px 12px;
            max-height: 40px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Melhorar aparência do select quando focado */
        .form-group select:focus {
            border-color: #1e3a8a;
            outline: none;
            box-shadow: 0 0 0 2px rgba(30, 58, 138, 0.1);
        }

        /* Estilo para select quando tem muitas opções */
        .form-group select[size] {
            max-height: 200px;
            overflow-y: auto;
        }

        /* Forçar estilos para selects do modal de evento */
        #eventModal .form-group select,
        #eventModal select {
            max-height: 200px !important;
            overflow-y: auto !important;
            height: auto !important;
            min-height: 40px !important;
        }

        /* Excluir checkbox-group das regras de altura */
        #eventModal .checkbox-group {
            max-height: none !important;
            overflow: visible !important;
            height: auto !important;
            width: 100% !important;
            position: relative !important;
        }

        /* Garantir que o form-group do checkbox não tenha limitações */
        #eventModal .form-group:has(.checkbox-group) {
            overflow: visible !important;
            max-height: none !important;
            height: auto !important;
            width: 100% !important;
        }

        /* Garantir que o form-row do checkbox não tenha limitações */
        #eventModal .form-row:has(.checkbox-group) {
            overflow: visible !important;
            max-height: none !important;
            height: auto !important;
        }

        /* CSS específico para o checkbox do evento paroquial */
        #eventModal #eventParoquial {
            position: relative !important;
            z-index: 10 !important;
        }

        /* Garantir que o texto do checkbox não seja cortado */
        #eventModal .checkbox-label {
            white-space: nowrap !important;
            overflow: visible !important;
            text-overflow: unset !important;
        }

        /* CSS específico para checkbox de largura completa */
        .checkbox-full-width {
            width: 100% !important;
            flex: 1 1 100% !important;
            min-width: 0 !important;
            overflow: visible !important;
        }

        .checkbox-full-width .checkbox-group {
            width: 100% !important;
            overflow: visible !important;
        }

        .checkbox-full-width .checkbox-label {
            width: 100% !important;
            overflow: visible !important;
            display: flex !important;
            align-items: center !important;
        }

        /* Garantir que campos de hora sejam visíveis */
        #eventModal input[type="time"] {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* Garantir que campos de data sejam visíveis */
        #eventModal input[type="date"] {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* Select customizado com busca (apenas dentro do modal) */
        /* Campo de busca/seleção direto (substitui o select) */
        #eventModal .search-select-field {
            position: relative;
            width: 100%;
        }

        #eventModal .search-select-field input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff;
            color: #333;
            font-size: 14px;
        }

        #eventModal .search-select-field input:hover {
            border-color: #1e3a8a;
        }

        #eventModal .search-select-field input:focus {
            border-color: #1e3a8a;
            outline: none;
            box-shadow: 0 0 0 2px rgba(30, 58, 138, 0.1);
        }

        #eventModal .search-select-menu {
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            z-index: 10;
            display: none;
        }

        #eventModal .search-select-field.open .search-select-menu {
            display: block;
        }

        #eventModal .search-select-list {
            max-height: 220px;
            overflow-y: auto;
        }

        #eventModal .search-select-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f8f8f8;
        }

        #eventModal .search-select-item:hover {
            background: #f8f9fa;
        }

        #eventModal .search-select-item.is-selected {
            background: #eff6ff;
            color: #1e3a8a;
        }

        /* Mini-calendário */
        #eventModal .mini-calendar {
            padding: 16px;
            font-size: 14px;
        }

        #eventModal .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-weight: 600;
        }

        #eventModal .calendar-nav {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        #eventModal .calendar-nav:hover {
            background: #f0f0f0;
        }

        #eventModal .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 8px;
            font-weight: 600;
            color: #666;
            text-align: center;
        }

        #eventModal .calendar-weekdays > div {
            padding: 8px 4px;
            font-size: 12px;
        }

        #eventModal .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        #eventModal .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
            font-size: 13px;
        }

        #eventModal .calendar-day:hover {
            background: #f0f0f0;
        }

        #eventModal .calendar-day.today {
            background: #1e3a8a;
            color: white;
            font-weight: 600;
        }

        #eventModal .calendar-day.selected {
            background: #1e3a8a;
            color: white;
            font-weight: 600;
        }

        #eventModal .calendar-day.other-month {
            color: #ccc;
            cursor: default;
        }

        #eventModal .calendar-day.other-month:hover {
            background: transparent;
        }

        /* Responsivo para selects */
        @media (max-width: 768px) {
            .form-group select,
            #eventModal select {
                max-height: 150px !important;
            }
        }

        /* Estilo adicional para garantir scroll */
        select {
            max-height: 200px !important;
            overflow-y: auto !important;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            border-color: #1e3a8a;
            outline: none;
            box-shadow: 0 0 0 2px rgba(30, 58, 138, 0.1);
        }

        .form-group input[readonly] {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            flex-shrink: 0;
        }

        .btn-primary,
        .btn-secondary {
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            border: none;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 58, 138, 0.35);
        }

        .btn-secondary {
            background-color: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
        }

        .btn-secondary:hover {
            background-color: #e0e0e0;
        }

        /* Toggle de Status */
        .status-toggle-modal {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .status-label-modal {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        /* Modal Header Actions */
        .modal-header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5em;
            color: #666;
            cursor: pointer;
            padding: 5px;
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: #333;
        }

        /* Checkbox personalizado */
        .checkbox-group {
            margin-top: 8px;
            padding: 12px 0;
            min-height: 50px;
            display: flex;
            align-items: center;
            width: 100%;
            overflow: visible;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
            color: #555;
            padding: 8px 0;
            min-height: 40px;
            width: 100%;
            overflow: visible;
        }

        .checkbox-label input[type="checkbox"] {
            display: none;
        }

        .checkmark {
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
            position: relative;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .checkbox-label input[type="checkbox"]:checked + .checkmark {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            border-color: #1e3a8a;
        }

        .checkbox-label input[type="checkbox"]:checked + .checkmark::after {
            content: "✓";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        /* Estilos para campos de arquivo */
        .file-info {
            margin-top: 5px;
        }

        .file-info small {
            color: #666;
            font-size: 12px;
        }

        input[type="file"] {
            width: 100%;
            padding: 8px;
            border: 2px dashed #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        input[type="file"]:hover {
            border-color: #1e3a8a;
            background-color: #f0f8ff;
        }

        input[type="file"]:focus {
            outline: none;
            border-color: #1e3a8a;
            box-shadow: 0 0 0 2px rgba(30, 58, 138, 0.1);
        }

        /* Responsivo para formulário */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .form-section {
                padding: 15px;
            }
            
            .modal-header-actions {
                flex-direction: column;
                gap: 10px;
            }
        }










        /* Container lateral do calendário */
        .calendar-sidebar-container {
            margin: 20px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #f0f0f0;
            position: relative;
            z-index: 10;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .calendar-sidebar-header {
            background: white;
            color: #333;
            padding: 20px 15px 15px 15px;
            text-align: center;
            font-weight: 600;
            font-size: 16px;
            border-bottom: none;
        }

        /* Mini calendário */
        .mini-calendar {
            margin: 0;
            background: white;
            border-radius: 0;
            overflow: hidden;
            box-shadow: none;
            border: none;
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
            max-height: 280px;
        }

        .mini-calendar-header {
            background: white;
            color: #333;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: none;
            font-weight: 500;
        }

        .mini-calendar-title {
            font-weight: 500;
            font-size: 14px;
            color: #333;
        }

        .mini-calendar-nav {
            display: flex;
            gap: 8px;
        }

        .mini-nav-btn {
            background: transparent;
            border: none;
            color: #333;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 500;
            transition: background 0.2s ease;
        }

        .mini-nav-btn:hover {
            background: #f8f9fa;
        }

        .mini-calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: white;
            border-bottom: none;
        }

        .mini-weekday {
            padding: 6px 4px;
            text-align: center;
            font-size: 11px;
            font-weight: 500;
            color: #333;
        }

        .mini-calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0;
            background: white;
            flex: 0 0 auto;
            min-height: 0;
        }

        .mini-day {
            background: white;
            padding: 6px 4px;
            text-align: center;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            font-weight: 400;
        }

        .mini-day:hover {
            background: #f8f9fa;
        }

        .mini-day.selected {
            background: #007bff;
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mini-day.has-events {
            background: white;
            position: relative;
        }

        .mini-day.has-events::after {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 3px;
            height: 3px;
            background: #007bff;
            border-radius: 50%;
        }

        .mini-day.other-month {
            color: #999;
        }

        /* Seção de Últimos Agendamentos */
        .recent-appointments {
            margin: 20px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #f0f0f0;
            flex: 0 0 auto;
        }

        .recent-appointments-header {
            background: white;
            color: #333;
            padding: 15px 20px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            border-bottom: 1px solid #f0f0f0;
        }

        .appointments-list {
            padding: 0;
            margin: 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .appointment-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f8f9fa;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s ease;
        }

        .appointment-item:last-child {
            border-bottom: none;
        }

        .appointment-item:hover {
            background: #f8f9fa;
        }

        .appointment-time {
            background: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            min-width: 50px;
            text-align: center;
        }

        .appointment-details {
            flex: 1;
        }

        .appointment-title {
            font-size: 12px;
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .appointment-type {
            font-size: 10px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .appointment-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .status-confirmed {
            background: #28a745;
        }

        .status-pending {
            background: #ffc107;
        }

        .status-cancelled {
            background: #dc3545;
        }


        /* Área principal */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
            margin-top: 80px; /* Compensar altura da barra fixa */
            margin-left: 300px;
            width: calc(100vw - 300px);
            min-height: calc(100vh - 80px);
        }


        .header-left {
            display: flex;
            align-items: center;
            gap: 60px;
            flex: 1;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }


        .nav-links {
            display: flex;
            gap: 30px;
            justify-content: center;
            flex: 1;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 12px 0;
            position: relative;
            transition: opacity 0.2s ease;
            font-size: 16px;
        }

        .nav-link:hover {
            opacity: 0.8;
        }

        .nav-link.active {
            opacity: 1;
        }

        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            right: 0;
            height: 3px;
            background: #4caf50;
            border-radius: 2px;
        }

        /* Dropdown styles */
        .nav-dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-trigger {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .dropdown-trigger i {
            font-size: 12px;
            transition: transform 0.2s ease;
        }

        .nav-dropdown:hover .dropdown-trigger i {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 180px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            z-index: 1000;
            border: 1px solid #e0e0e0;
        }

        .nav-dropdown:hover .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            display: block;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s ease;
            border-bottom: 1px solid #f0f0f0;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: #f8f9fa;
            color: #1976d2;
        }

        .beta-tag {
            background: #ff9800;
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
            text-transform: uppercase;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-shrink: 0;
        }

        .header-icon {
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s ease;
            position: relative;
            font-size: 16px;
        }

        .header-icon:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #f44336;
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .user-avatar {
            width: 44px;
            height: 44px;
            background: #4caf50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
        }

        /* Área de conteúdo principal */
        .content-area {
            flex: 1;
            padding: 0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            position: relative;
            background: transparent;
        }


        /* Container de informações acima do calendário */
        .calendar-info-container {
            background: white;
            border-radius: 12px;
            padding: 25px 30px;
            position: relative;
            margin: 20px 20px 15px 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 25px;
            border: 1px solid #f0f0f0;
            min-height: 80px;
            position: relative;
            z-index: 10;
        }

        .info-left {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .info-location {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-location-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .info-location-label {
            font-size: 15px;
            color: #333;
            font-weight: 600;
            white-space: nowrap;
        }

        .info-location-name {
            font-size: 18px;
            color: #333;
            font-weight: 700;
        }

        .info-location-select {
            font-size: 15px;
            color: #333;
            font-weight: 600;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 180px;
            outline: none;
        }

        .info-location-select:hover {
            border-color: #1976d2;
            background: #f8f9fa;
        }

        .info-location-select:focus {
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }

        .info-agenda {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .info-agenda-label {
            font-size: 15px;
            color: #333;
            font-weight: 600;
        }

        .info-agenda-avatar {
            width: 36px;
            height: 36px;
            background: #1976d2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        .info-agenda-name {
            font-size: 15px;
            color: #333;
            font-weight: 600;
        }

        .info-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .info-date {
            font-size: 18px;
            color: #333;
            font-weight: 700;
            text-align: center;
            padding: 8px 16px;
        }

        .info-today-btn {
            background: #1976d2;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
            font-size: 15px;
            box-shadow: 0 2px 4px rgba(25, 118, 210, 0.3);
        }

        .info-today-btn:hover {
            background: #1565c0;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(25, 118, 210, 0.4);
        }

        /* View Dropdown styles (igual ao dropdown de relatórios) */
        .view-dropdown {
            position: relative;
            display: inline-block;
        }

        .view-dropdown-trigger {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            min-width: 120px;
            font-size: 15px;
            transition: all 0.2s ease;
        }

        .view-dropdown-trigger:hover {
            border-color: #1976d2;
            background: #f8f9fa;
        }

        .view-dropdown-trigger i {
            font-size: 12px;
            transition: transform 0.2s ease;
        }

        .view-dropdown:hover .view-dropdown-trigger i {
            transform: rotate(180deg);
        }

        .view-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            width: 100%;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            z-index: 1000;
            border: 1px solid #e0e0e0;
        }

        .view-dropdown:hover .view-dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .view-dropdown-item {
            display: block;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s ease;
            border-bottom: 1px solid #f0f0f0;
        }

        .view-dropdown-item:last-child {
            border-bottom: none;
        }

        .view-dropdown-item:hover {
            background: #f8f9fa;
            color: #1976d2;
        }

        /* Estilos para visualização de dia */
        .day-month {
            font-size: 12px;
            color: #666;
            font-weight: 400;
            margin-top: 2px;
        }

        .info-online-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            color: #666;
            font-weight: 500;
        }

        /* Community Dropdown styles (igual ao dropdown de visualização) */
        .community-dropdown {
            position: relative;
            display: inline-block;
        }

        .community-dropdown-trigger {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            min-width: 200px;
            font-size: 15px;
            transition: all 0.2s ease;
        }

        .community-dropdown-trigger:hover {
            border-color: #1976d2;
            background: #f8f9fa;
        }

        .community-dropdown-trigger i {
            font-size: 12px;
            transition: transform 0.2s ease;
        }

        .community-dropdown:hover .community-dropdown-trigger i {
            transform: rotate(180deg);
        }

        .community-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            width: 100%;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            z-index: 1000;
            border: 1px solid #e0e0e0;
            max-height: 200px;
            overflow-y: auto;
        }

        .community-dropdown:hover .community-dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .community-dropdown-item {
            display: block;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s ease;
            border-bottom: 1px solid #f0f0f0;
        }

        .community-dropdown-item:last-child {
            border-bottom: none;
        }

        .community-dropdown-item:hover {
            background: #f8f9fa;
            color: #1976d2;
        }

        /* Calendário semanal */
        .weekly-calendar {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            flex: 1;
            display: flex;
            flex-direction: column;
            margin: 0 20px 20px 20px;
            border: 1px solid #f0f0f0;
            position: relative;
            z-index: 5;
            max-height: calc(100vh - 200px);
        }

        .calendar-header {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }

        .time-column-header {
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
            color: #666;
            border-right: none; /* remove linha vertical no título da coluna de horas */
        }

        .day-header {
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
            color: #333;
            border-right: none; /* remove linha vertical nos títulos dos dias */
            position: relative;
        }

        .day-header:last-child {
            border-right: none;
        }

        .day-header.today { background: transparent; color: inherit; }
        .day-header.today::after { display: none; }
        .day-header.today .day-number {
            background: #1976d2;
            color: #fff;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            font-weight: 700;
        }

        .day-name {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .day-number {
            font-size: 18px;
            font-weight: bold;
        }

        .calendar-body {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            max-height: calc(100vh - 300px);
        }

        /* Estilização do scroll */
        .calendar-body::-webkit-scrollbar {
            width: 8px;
        }

        .calendar-body::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .calendar-body::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .calendar-body::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .time-column {
            border-right: 1px solid #e0e0e0;
        }

        .time-slot {
            height: 60px;
            padding: 8px;
            text-align: center;
            font-size: 12px;
            color: #666;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .day-column {
            border-right: 1px solid #e0e0e0;
            position: relative;
        }

        .day-column:last-child {
            border-right: none;
        }

        .day-column.today {
            background: #f8f9ff;
        }

        .day-slot {
            height: 60px;
            border-bottom: 1px solid #f0f0f0;
            position: relative;
            cursor: pointer;
            transition: background 0.2s ease;
            /* Separação vertical entre dias */
            border-left: 1px solid #e0e0e0;
        }

        .day-slot:hover {
            background: #f0f8ff;
        }

        .day-slot.today { background: transparent; }

        /* Badge para número do dia no modo mensal */
        .day-badge {
            position:absolute; top:4px; right:6px; font-size:11px; color:#666;
        }
        .day-badge.today-badge {
            right: 6px; top: 6px;
            background: #1976d2; color: #fff; border-radius: 50%;
            width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 11px;
        }

        /* Eventos */
        .event-block {
            position: absolute;
            left: 2px;
            right: 2px;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 500;
            color: white;
            cursor: pointer;
            z-index: 10;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }

        .event-block:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        /* Cores dos eventos */
        .event-missa {
            background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
        }

        .event-batizado {
            background: linear-gradient(135deg, #2196f3 0%, #42a5f5 100%);
        }

        .event-casamento {
            background: linear-gradient(135deg, #e91e63 0%, #f06292 100%);
        }

        .event-comunhao {
            background: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%);
        }

        .event-crisma {
            background: linear-gradient(135deg, #9c27b0 0%, #ba68c8 100%);
        }

        .event-funeral {
            background: linear-gradient(135deg, #607d8b 0%, #90a4ae 100%);
        }

        .event-reuniao {
            background: linear-gradient(135deg, #795548 0%, #a1887f 100%);
        }

        .event-outro {
            background: linear-gradient(135deg, #1976d2 0%, #42a5f5 100%);
        }

        /* Status dos eventos */
        .event-confirmado {
            border-left: 4px solid #4caf50;
        }

        .event-pendente {
            border-left: 4px solid #ff9800;
        }

        .event-cancelado {
            border-left: 4px solid #f44336;
            opacity: 0.7;
        }



        /* Spinner de carregamento - cobre área de conteúdo mas não o menu superior */
        .loader-overlay-main {
            display: none;
            position: fixed;
            top: 80px; /* Deixar espaço para o menu superior (80px) */
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.95);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .spinner-main {
            border: 8px solid #e3f2fd;
            border-top: 8px solid #1976D2;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            margin-top: 20px;
            color: #1976D2;
            font-size: 1.1rem;
            font-weight: 500;
            text-align: center;
        }


        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 5px;
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .close-btn:hover {
            background: #f5f5f5;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #1976d2;
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(25, 118, 210, 0.4);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #e0e0e0;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        /* Responsivo */
        @media (max-width: 1200px) {
            .left-sidebar {
                width: 250px;
            }
            
            .main-area {
                width: calc(100vw - 250px);
                margin-left: 250px;
            }
            
            .nav-links {
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .left-sidebar {
                display: none;
            }
            
            .main-area {
                margin-left: 0;
                width: 100vw;
            }
            
            .top-header {
                padding: 0 15px;
                height: 70px;
            }
            
            .main-area {
                margin-top: 70px;
            }
            
            .nav-links {
                display: none;
            }
            
            .nav-dropdown .dropdown-menu {
                position: static;
                opacity: 1;
                visibility: visible;
                transform: none;
                box-shadow: none;
                border: none;
                background: transparent;
            }
            
            .header-left {
                gap: 30px;
            }
            
            .content-area {
                padding: 0;
            }


            .calendar-info-container {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
                padding: 15px 20px;
            }

            .info-left {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .info-right {
                flex-wrap: wrap;
                gap: 10px;
            }

            .calendar-body {
                min-height: 400px;
            }

            .time-slot, .day-slot {
                height: 40px;
            }
        }

        @media (max-width: 480px) {
            .left-sidebar {
                flex-direction: column;
                height: auto;
                margin-top: 70px;
            }
            
            .calendar-sidebar-container {
                margin: 10px;
                min-width: 200px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }
            
            .content-header {
                margin-bottom: 20px;
            }
            
            .calendar-header {
                font-size: 12px;
            }

            .day-header {
                padding: 10px 5px;
            }
            
            .day-number {
                font-size: 14px;
            }

            .time-slot, .day-slot {
                height: 30px;
                font-size: 10px;
            }

            .event-block {
                font-size: 9px;
                padding: 2px 4px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Spinner Centralizado de Carregamento -->
        <div id="loader-agenda" class="loader-overlay-main">
            <div class="spinner-main"></div>
            <div class="loading-text">Carregando agenda...</div>
        </div>

        <!-- Sidebar Esquerda -->
        <div class="left-sidebar">
            <div class="sidebar-content">
                <!-- Container Lateral do Calendário -->
                <div class="calendar-sidebar-container">
                    <!-- Botão Criar -->
                    <button class="create-button" onclick="openEventModal()">
                        <i class="fas fa-plus"></i>
                        Criar
                    </button>

                    <button class="multplus-btn" onclick="openMultplusModal()">
                        <i class="fas fa-layer-group"></i>
                        Multplus
                    </button>

                    <div class="calendar-sidebar-header">
                        <i class="fas fa-calendar-alt"></i> Calendário
                    </div>
                    
                    <!-- Mini Calendário -->
                    <div class="mini-calendar">
                        <div class="mini-calendar-header">
                            <div class="mini-calendar-title" id="miniCalendarTitle">Agosto 2024</div>
                            <div class="mini-calendar-nav">
                                <button class="mini-nav-btn" onclick="navigateMiniCalendar(-1)">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button class="mini-nav-btn" onclick="navigateMiniCalendar(1)">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mini-calendar-weekdays">
                            <div class="mini-weekday">D</div>
                            <div class="mini-weekday">S</div>
                            <div class="mini-weekday">T</div>
                            <div class="mini-weekday">Q</div>
                            <div class="mini-weekday">Q</div>
                            <div class="mini-weekday">S</div>
                            <div class="mini-weekday">S</div>
                        </div>
                        <div class="mini-calendar-days" id="miniCalendarDays">
                            <!-- Dias serão inseridos via JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Seção de Últimos Agendamentos -->
                    <div class="recent-appointments">
                        <div class="recent-appointments-header">
                            <i class="fas fa-clock"></i> Últimos Agendamentos
                        </div>
                        <div class="appointments-list" id="recentAppointmentsList">
                            <!-- Agendamentos serão inseridos via JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Espaço em branco para não ocupar todo o container -->
                    <div style="flex: 1;"></div>
                </div>
            </div>
        </div>

        <!-- Área Principal -->
        <div class="main-area">
            <!-- Header Superior -->
            <div class="top-header">
                <div class="header-left">
                    <div class="logo-section">
                        <span style="font-size: 20px; font-weight: 600;">ParoquiaON</span>
        </div>
                    <div class="nav-links">
                        <a href="index.html" class="nav-link">Minha Comunidade</a>
                        <a href="agenda.html" class="nav-link active">Agenda</a>
                        <a href="comunidades.html" class="nav-link">Comunidades</a>
                        <a href="pastorais.html" class="nav-link">Pastorais</a>
                        <a href="pilares.html" class="nav-link">Pilares</a>
                        <a href="locais.html" class="nav-link">Locais</a>
                        <a href="acoes.html" class="nav-link">Ações</a>
                        <a href="pessoas.html" class="nav-link">Pessoas</a>
                        <a href="usuarios.html" class="nav-link">Usuários</a>
                        <a href="perfil.html" class="nav-link">Perfil</a>
                        <div class="nav-dropdown">
                            <a href="#" class="nav-link dropdown-trigger">Relatórios <i class="fas fa-chevron-down"></i></a>
                            <div class="dropdown-menu">
                                <a href="recebimento.html" class="dropdown-item">Recebimento</a>
                                <a href="conferencia.html" class="dropdown-item">Conferência</a>
                                <a href="dinamico.html" class="dropdown-item">Dinâmico <span class="beta-tag">beta</span></a>
                            </div>
                        </div>
    </div>
            </div>
                <div class="header-right">
                    <div class="header-icon">
                    <i class="fas fa-bell"></i>
                        <span class="notification-badge">3</span>
                    </div>
                <div class="user-avatar">A</div>
            </div>
        </div>

            <!-- Área de Conteúdo -->
            <div class="content-area">
                <!-- Container de Informações -->
                <div class="calendar-info-container">
                    <div class="info-left">
                        <div class="info-location">
                            <div class="info-location-container">
                            <div class="info-location-label">Você está em:</div>
                                <div class="community-dropdown">
                                    <div class="community-dropdown-trigger">
                                        <span id="currentCommunityText">Carregando comunidades...</span>
                                        <i class="fas fa-chevron-down"></i>
                        </div>
                                    <div class="community-dropdown-menu">
                                        <a href="#" class="community-dropdown-item" data-community-id="">Todas as comunidades</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="info-right">
                        <div class="info-date">12 - 18 outubro de 2025</div>
                        <button class="info-today-btn" onclick="goToToday()">Hoje</button>
                        
                        <div class="view-dropdown">
                            <div class="view-dropdown-trigger">
                                <span id="currentViewText">Semana</span>
                            <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="view-dropdown-menu">
                                <a href="#" class="view-dropdown-item" data-view="dia">Dia</a>
                                <a href="#" class="view-dropdown-item" data-view="semana">Semana</a>
                                <a href="#" class="view-dropdown-item" data-view="mês">Mês</a>
                                <a href="#" class="view-dropdown-item" data-view="ano">Ano</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Calendário Semanal -->
                <div class="weekly-calendar">
                    <div class="calendar-header">
                        <div class="time-column-header">Hora</div>
                        <div class="day-header" id="day0">
                            <div class="day-name">DOM</div>
                            <div class="day-number">24</div>
                    </div>
                        <div class="day-header" id="day1">
                            <div class="day-name">SEG</div>
                            <div class="day-number">25</div>
                    </div>
                        <div class="day-header" id="day2">
                            <div class="day-name">TER</div>
                            <div class="day-number">26</div>
                </div>
                        <div class="day-header today" id="day3">
                            <div class="day-name">QUA</div>
                            <div class="day-number">27</div>
                    </div>
                        <div class="day-header" id="day4">
                            <div class="day-name">QUI</div>
                            <div class="day-number">28</div>
                    </div>
                        <div class="day-header" id="day5">
                            <div class="day-name">SEX</div>
                            <div class="day-number">29</div>
                </div>
                        <div class="day-header" id="day6">
                            <div class="day-name">SAB</div>
                            <div class="day-number">30</div>
                    </div>
                </div>
                    <div class="calendar-body" id="calendarBody">
                        <!-- Horários e eventos serão inseridos via JavaScript -->
        </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Container de modais removido - modais não disponíveis -->

    <!-- Scripts -->
    <script src="scripts/auth-guard.js"></script>
    <script src="scripts/apply-auth-protection.js"></script>
    <script src="scripts/navigation.js"></script>
    
    <!-- Carregar modais dinamicamente -->
    <script>
        // Carregamento de modais removido - modais não disponíveis
    </script>
    <script src="scripts/config/api.js"></script>
    
    <script>
        // Variáveis globais
        let currentDate = new Date();
        let events = [];
        let allEvents = []; // Todos os eventos (sem filtro)
        let editingEvent = null;
        let miniCalendarDate = new Date();
        let currentView = 'semana'; // 'semana' | 'mês'
        let selectedCommunityId = null; // ID da comunidade selecionada

        // Funções para controlar o spinner da agenda
        function mostrarSpinnerAgenda() {
            const spinner = document.getElementById('loader-agenda');
            if (spinner) {
                spinner.style.display = 'flex';
            }
        }
        
        function ocultarSpinnerAgenda() {
            const spinner = document.getElementById('loader-agenda');
            if (spinner) {
                spinner.style.display = 'none';
            }
        }

        // Inicializar aplicação
        document.addEventListener('DOMContentLoaded', async function() {
            // Mostrar spinner ao iniciar carregamento
            mostrarSpinnerAgenda();
            
            initializeApp();
            
            // Carregar dados em paralelo para otimizar performance
            console.log('🔄 Carregando dados da agenda em paralelo...');
            try {
                await Promise.all([
                    loadCommunities(),
                    loadEventsFromApi(),
                    loadEventCommunities(),
                    loadEventPastorals(),
                    loadEventPilares(),
                    loadEventAcoes(),
                    loadEventLocais()
                ]);
                console.log('✅ Todos os dados foram carregados em paralelo');
            } catch (error) {
                console.error('❌ Erro ao carregar dados:', error);
            } finally {
                // Ocultar spinner após carregamento (sucesso ou erro)
                ocultarSpinnerAgenda();
            }
            
            setupEventListeners();
        });

        function initializeApp() {
            updateMiniCalendar();
            renderCalendar();
            updateCurrentWeekRange();
            updateRecentAppointments();
        }

        function renderCalendar() {
            if (currentView === 'dia') {
                updateDailyCalendar();
            } else if (currentView === 'mês') {
                updateMonthlyCalendar();
            } else if (currentView === 'ano') {
                updateYearlyCalendar();
            } else {
                updateWeeklyCalendar();
            }
        }

        function setupEventListeners() {
            // Toggle online removido

            // Seletor de visualização (dropdown igual ao de relatórios)
            const viewDropdownItems = document.querySelectorAll('.view-dropdown-item');
            viewDropdownItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const selectedView = this.getAttribute('data-view');
                    console.log('Visualização alterada para:', selectedView);
                    
                    // Atualizar texto do trigger
                    const currentViewText = document.getElementById('currentViewText');
                    if (currentViewText) {
                        currentViewText.textContent = selectedView.charAt(0).toUpperCase() + selectedView.slice(1);
                    }
                    
                    // Atualizar visualização
                    currentView = selectedView;
                    renderCalendar();
                    updateCurrentWeekRange();
                    
                    if (typeof showToast === 'function') {
                        showToast(`Visualização alterada para ${selectedView}`, 'info');
                    }
                });
            });

            // Formulário de evento - Removido (modal não disponível)

            // Event listeners removidos - modais não disponíveis

            // Fechar modal ao clicar fora - Removido (modal não disponível)

            // Presets de duração removidos - modal não disponível

            // Event listeners de status e horários removidos - modal não disponível
        }

        function updateMiniCalendar() {
            const title = document.getElementById('miniCalendarTitle');
            const daysContainer = document.getElementById('miniCalendarDays');
            
            title.textContent = miniCalendarDate.toLocaleDateString('pt-BR', { 
                month: 'long', 
                year: 'numeric' 
            });

            daysContainer.innerHTML = '';

            const year = miniCalendarDate.getFullYear();
            const month = miniCalendarDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'mini-day';
                
                if (date.getMonth() !== month) {
                    dayElement.classList.add('other-month');
                }
                
                if (isToday(date)) {
                    dayElement.classList.add('selected');
                }
                
                if (hasEventsOnDate(date)) {
                    dayElement.classList.add('has-events');
                }
                
                dayElement.textContent = date.getDate();
                dayElement.addEventListener('click', () => {
                    currentDate = new Date(date);
                    renderCalendar();
                });
                
                daysContainer.appendChild(dayElement);
            }
        }

        function navigateMiniCalendar(direction) {
            miniCalendarDate.setMonth(miniCalendarDate.getMonth() + direction);
            updateMiniCalendar();
        }

        function updateWeeklyCalendar() {
            const calendarBody = document.getElementById('calendarBody');
            calendarBody.innerHTML = '';

            // Reconstruir cabeçalhos dos dias (DOM-SAB) com IDs esperados
            const header = document.querySelector('.calendar-header');
            if (header) {
                header.innerHTML = `
                    <div class="time-column-header">Hora</div>
                    <div class="day-header" id="day0"><div class="day-name">DOM</div><div class="day-number">-</div></div>
                    <div class="day-header" id="day1"><div class="day-name">SEG</div><div class="day-number">-</div></div>
                    <div class="day-header" id="day2"><div class="day-name">TER</div><div class="day-number">-</div></div>
                    <div class="day-header" id="day3"><div class="day-name">QUA</div><div class="day-number">-</div></div>
                    <div class="day-header" id="day4"><div class="day-name">QUI</div><div class="day-number">-</div></div>
                    <div class="day-header" id="day5"><div class="day-name">SEX</div><div class="day-number">-</div></div>
                    <div class="day-header" id="day6"><div class="day-name">SAB</div><div class="day-number">-</div></div>
                `;
            }

            // Calcular início da semana (domingo = 0)
            const weekStart = new Date(currentDate);
            weekStart.setDate(currentDate.getDate() - currentDate.getDay());

            // Atualizar cabeçalhos dos dias
            const dayNames = ['DOM', 'SEG', 'TER', 'QUA', 'QUI', 'SEX', 'SAB'];
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(weekStart);
                dayDate.setDate(weekStart.getDate() + i);
                const dayHeader = document.getElementById(`day${i}`);
                
                dayHeader.querySelector('.day-name').textContent = dayNames[i];
                dayHeader.querySelector('.day-number').textContent = dayDate.getDate();
                
                // Remover classe today de todos
                dayHeader.classList.remove('today');
                // Adicionar classe today se for hoje
                if (isToday(dayDate)) {
                    dayHeader.classList.add('today');
                }
            }

            // Gerar horários (06:00 - 22:00)
            for (let hour = 6; hour <= 22; hour++) {
                // Coluna de hora
                const timeSlot = document.createElement('div');
                timeSlot.className = 'time-slot';
                timeSlot.textContent = `${hour.toString().padStart(2, '0')}:00`;
                calendarBody.appendChild(timeSlot);

                // Colunas dos dias
                for (let day = 0; day < 7; day++) {
                    const dayDate = new Date(weekStart);
                    dayDate.setDate(weekStart.getDate() + day);
                    
                    const daySlot = document.createElement('div');
                    daySlot.className = 'day-slot';
                    
                    if (isToday(dayDate)) {
                        daySlot.classList.add('today');
                    }
                    
                    // Adicionar eventos para este horário
                    const hourEvents = getEventsForHour(dayDate, hour);
                    hourEvents.forEach(event => {
                        const eventElement = document.createElement('div');
                        eventElement.className = `event-block event-${event.type}`;
                        eventElement.textContent = event.title;
                        
                        // Calcular posição e altura baseada no horário
                        const startTime = new Date(event.startTime);
                        const endTime = new Date(event.endTime);
                        const startMinutes = startTime.getMinutes();
                        const durationMinutes = (endTime.getTime() - startTime.getTime()) / (1000 * 60);
                        
                        eventElement.style.top = `${(startMinutes / 60) * 100}%`;
                        eventElement.style.height = `${(durationMinutes / 60) * 100}%`;
                        
                        eventElement.addEventListener('click', (e) => {
                            e.stopPropagation();
                            editEvent(event);
                        });
                        
                        daySlot.appendChild(eventElement);
                    });
                    
                    daySlot.addEventListener('click', () => {
                        dayDate.setHours(hour, 0, 0, 0);
                        console.log('Modal de novo agendamento não está disponível');
                    });
                    
                    calendarBody.appendChild(daySlot);
                }
            }
        }

        function updateMonthlyCalendar() {
            const calendarBody = document.getElementById('calendarBody');
            calendarBody.innerHTML = '';

            // Cabeçalhos dos dias (Dom-Sáb)
            const dayNames = ['DOM','SEG','TER','QUA','QUI','SEX','SAB'];
            const header = document.querySelector('.calendar-header');
            if (header) {
                header.innerHTML = '<div class="time-column-header">Dia</div>' + dayNames.map(n => `<div class="day-header"><div class="day-name">${n}</div></div>`).join('');
            }

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const start = new Date(firstDay);
            start.setDate(1 - firstDay.getDay()); // iniciar no domingo

            // 6 semanas (máximo)
            for (let week = 0; week < 6; week++) {
                // Coluna "hora" vira coluna do número da semana (ou vazia)
                const weekCell = document.createElement('div');
                weekCell.className = 'time-slot';
                weekCell.textContent = '';
                calendarBody.appendChild(weekCell);

                for (let day = 0; day < 7; day++) {
                    const date = new Date(start);
                    date.setDate(start.getDate() + week * 7 + day);

                    const cell = document.createElement('div');
                    cell.className = 'day-slot';
                    if (date.getMonth() !== month) cell.style.background = '#f9fafb';
                    if (isToday(date)) cell.classList.add('today');

                    // Cabeçalho interno: número do dia
                    const label = document.createElement('div');
                    const isTodayFlag = isToday(date);
                    label.className = isTodayFlag ? 'day-badge today-badge' : 'day-badge';
                    label.textContent = date.getDate();
                    cell.appendChild(label);

                    // Eventos do dia (mostrar como chips no topo)
                    const dayEvents = events.filter(ev => {
                        const d = new Date(ev.startTime);
                        return d.toDateString() === date.toDateString();
                    });
                    dayEvents.slice(0, 3).forEach(ev => {
                        const chip = document.createElement('div');
                        chip.style.cssText = 'margin:4px; padding:2px 6px; border-radius:10px; font-size:10px; color:#fff; display:inline-block; background:#1976d2;';
                        chip.textContent = ev.title || 'Evento';
                        cell.appendChild(chip);
                    });

                    cell.addEventListener('click', () => console.log('Modal de novo agendamento não está disponível'));
                    calendarBody.appendChild(cell);
                }
            }
        }

        function updateYearlyCalendar() {
            const calendarBody = document.getElementById('calendarBody');
            calendarBody.innerHTML = '';

            // Cabeçalho simples - apenas o ano
            const header = document.querySelector('.calendar-header');
            if (header) {
                header.innerHTML = `
                    <div class="time-column-header"></div>
                    <div class="day-header" style="grid-column: span 3;"><div class="day-name">${currentDate.getFullYear()}</div></div>
                `;
            }

            const year = currentDate.getFullYear();
            const months = [
                'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];

            // Criar grid 3x4 (3 colunas, 4 linhas) como Google Calendar
            for (let row = 0; row < 4; row++) {
                // Linha vazia para espaçamento
                const emptyCell = document.createElement('div');
                emptyCell.className = 'time-slot';
                emptyCell.textContent = '';
                calendarBody.appendChild(emptyCell);

                // 3 meses da linha
                for (let col = 0; col < 3; col++) {
                    const monthIndex = row * 3 + col;
                    const monthDate = new Date(year, monthIndex, 1);
                    
                    const monthCell = document.createElement('div');
                    monthCell.className = 'day-slot';
                    monthCell.style.height = '140px';
                    monthCell.style.padding = '12px';
                    monthCell.style.border = '1px solid #e0e0e0';
                    monthCell.style.cursor = 'pointer';
                    monthCell.style.transition = 'all 0.2s ease';
                    monthCell.style.display = 'flex';
                    monthCell.style.flexDirection = 'column';
                    monthCell.style.position = 'relative';

                    // Título do mês (estilo Google Calendar)
                    const monthTitle = document.createElement('div');
                    monthTitle.style.fontWeight = '500';
                    monthTitle.style.fontSize = '14px';
                    monthTitle.style.marginBottom = '8px';
                    monthTitle.style.color = '#333';
                    monthTitle.style.textAlign = 'left';
                    monthTitle.textContent = months[monthIndex];
                    monthCell.appendChild(monthTitle);

                    // Grid de dias do mês (estilo Google Calendar)
                    const daysGrid = document.createElement('div');
                    daysGrid.style.display = 'grid';
                    daysGrid.style.gridTemplateColumns = 'repeat(7, 1fr)';
                    daysGrid.style.gap = '2px';
                    daysGrid.style.flex = '1';
                    daysGrid.style.fontSize = '11px';

                    // Cabeçalhos dos dias da semana (D S T Q Q S S)
                    const weekDays = ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'];
                    weekDays.forEach(day => {
                        const dayHeader = document.createElement('div');
                        dayHeader.style.textAlign = 'center';
                        dayHeader.style.fontWeight = '500';
                        dayHeader.style.color = '#666';
                        dayHeader.style.padding = '2px';
                        dayHeader.textContent = day;
                        daysGrid.appendChild(dayHeader);
                    });

                    // Dias do mês
                    const firstDay = new Date(year, monthIndex, 1);
                    const lastDay = new Date(year, monthIndex + 1, 0);
                    const startDate = new Date(firstDay);
                    startDate.setDate(startDate.getDate() - firstDay.getDay()); // Começar no domingo

                    for (let i = 0; i < 42; i++) {
                        const date = new Date(startDate);
                        date.setDate(startDate.getDate() + i);
                        
                        const dayCell = document.createElement('div');
                        dayCell.style.textAlign = 'center';
                        dayCell.style.padding = '2px';
                        dayCell.style.cursor = 'pointer';
                        dayCell.style.borderRadius = '2px';
                        dayCell.style.fontSize = '11px';
                        
                        if (date.getMonth() !== monthIndex) {
                            dayCell.style.color = '#ccc';
                        } else {
                            dayCell.style.color = '#333';
                        }
                        
                        if (isToday(date)) {
                            dayCell.style.background = '#1976d2';
                            dayCell.style.color = 'white';
                            dayCell.style.fontWeight = 'bold';
                        }
                        
                        dayCell.textContent = date.getDate();
                        daysGrid.appendChild(dayCell);
                    }

                    monthCell.appendChild(daysGrid);

                    // Contador de eventos (estilo Google Calendar)
                    const monthEvents = events.filter(event => {
                        const eventDate = new Date(event.startTime);
                        return eventDate.getFullYear() === year && eventDate.getMonth() === monthIndex;
                    });

                    if (monthEvents.length > 0) {
                        const eventIndicator = document.createElement('div');
                        eventIndicator.style.cssText = `
                            position: absolute;
                            bottom: 8px;
                            left: 12px;
                            right: 12px;
                            font-size: 10px;
                            color: #1976d2;
                            font-weight: 500;
                            text-align: center;
                            background: rgba(25, 118, 210, 0.1);
                            padding: 2px 4px;
                            border-radius: 4px;
                        `;
                        eventIndicator.textContent = `${monthEvents.length} evento${monthEvents.length !== 1 ? 's' : ''}`;
                        monthCell.appendChild(eventIndicator);
                    }

                    // Hover effect (estilo Google Calendar)
                    monthCell.addEventListener('mouseenter', function() {
                        this.style.background = '#f8f9fa';
                        this.style.borderColor = '#1976d2';
                    });

                    monthCell.addEventListener('mouseleave', function() {
                        this.style.background = 'white';
                        this.style.borderColor = '#e0e0e0';
                    });

                    // Click para ir para o mês
                    monthCell.addEventListener('click', function() {
                        currentDate = new Date(year, monthIndex, 1);
                        currentView = 'mês';
                        renderCalendar();
                        updateCurrentWeekRange();
                    });

                    calendarBody.appendChild(monthCell);
                }
            }
        }

        function updateCurrentWeekRange() {
            const rangeElement = document.getElementById('currentWeekRange');
            if (!rangeElement) return; // Evita erro se o elemento não existir no layout
            
            // Atualizar texto do dropdown
            const currentViewText = document.getElementById('currentViewText');
            if (currentViewText) {
                currentViewText.textContent = currentView.charAt(0).toUpperCase() + currentView.slice(1);
            }
            
            if (currentView === 'dia') {
                rangeElement.textContent = currentDate.toLocaleDateString('pt-BR', { 
                    weekday: 'long',
                    day: 'numeric',
                    month: 'long', 
                    year: 'numeric' 
                });
            } else if (currentView === 'mês') {
                rangeElement.textContent = currentDate.toLocaleDateString('pt-BR', { 
                    month: 'long', 
                    year: 'numeric' 
                });
            } else if (currentView === 'ano') {
                rangeElement.textContent = currentDate.getFullYear().toString();
            } else {
            const weekStart = new Date(currentDate);
                weekStart.setDate(currentDate.getDate() - currentDate.getDay()); // Domingo = 0
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            rangeElement.textContent = `${weekStart.getDate()} - ${weekEnd.getDate()} ${weekStart.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })}`;
            }
        }

        function navigateWeek(direction) {
            if (currentView === 'dia') {
                currentDate.setDate(currentDate.getDate() + direction);
            } else if (currentView === 'mês') {
                currentDate.setMonth(currentDate.getMonth() + direction);
            } else if (currentView === 'ano') {
                currentDate.setFullYear(currentDate.getFullYear() + direction);
            } else {
            currentDate.setDate(currentDate.getDate() + (direction * 7));
            }
            renderCalendar();
            updateCurrentWeekRange();
        }

        function goToToday() {
            currentDate = new Date();
            renderCalendar();
            updateCurrentWeekRange();
        }

        function isToday(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        function hasEventsOnDate(date) {
            return events.some(event => {
                const eventDate = new Date(event.startTime);
                return eventDate.toDateString() === date.toDateString();
            });
        }

        function getEventsForHour(date, hour) {
            return events.filter(event => {
                const eventDate = new Date(event.startTime);
                return eventDate.toDateString() === date.toDateString() && 
                       eventDate.getHours() === hour;
            });
        }

        function openEventModal(date = null) {
            console.log('🚀 Abrindo modal de novo agendamento...');
            
            // Mostrar spinner durante criação do modal
            mostrarSpinnerAgenda();
            
            // Criar modal dinamicamente baseado no modal de comunidade
            const modalHTML = `
                <div id="eventModal" class="modal active">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2><i class="fas fa-calendar-plus"></i> <span id="modalTitle">Novo Agendamento</span></h2>
                            <div class="modal-header-actions">
                                <div class="status-toggle-modal">
                                    <label class="switch">
                                        <input type="checkbox" class="status-toggle" checked>
                                        <span class="slider"></span>
                                    </label>
                                    <span class="status-label-modal">Ativo</span>
                                </div>
                                <button class="close-modal" onclick="closeEventModal()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="modal-body">
                            <form id="eventForm">
                                <!-- Seção: Informações Básicas do Evento -->
                                <div class="form-section">
                                    <h3 class="section-title"><i class="fas fa-info-circle"></i> Informações Básicas do Evento</h3>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label><i class="fas fa-heading"></i> Título do Evento</label>
                                            <input type="text" id="eventTitle" name="titulo" required placeholder="Digite o título do evento">
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label><i class="fas fa-church"></i> Comunidade</label>
                                            <select id="eventCommunity" name="comunidade" required style="max-height: 200px; overflow-y: auto;">
                                                <option value="">Selecione a comunidade</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label><i class="fas fa-cross"></i> Pastoral</label>
                                            <select id="eventPastoral" name="pastoral" required style="max-height: 200px; overflow-y: auto;">
                                                <option value="">Selecione a pastoral</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label><i class="fas fa-layer-group"></i> Pilares</label>
                                            <select id="eventPilares" name="pilares" required style="max-height: 200px; overflow-y: auto;">
                                                <option value="">Selecione o pilar</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label><i class="fas fa-map-marker-alt"></i> Local</label>
                                            <select id="eventLocation" name="local" required style="max-height: 200px; overflow-y: auto;">
                                                <option value="">Selecione o local</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label><i class="fas fa-tasks"></i> Ação</label>
                                            <select id="eventAcao" name="acao" required style="max-height: 200px; overflow-y: auto;">
                                                <option value="">Selecione a ação</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label><i class="fas fa-bullseye"></i> Objetivo</label>
                                            <input type="text" id="eventObjetivo" name="objetivo" placeholder="Digite o objetivo do evento">
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label><i class="fas fa-calendar-alt"></i> Data de Início</label>
                                            <input type="date" id="eventDateStart" name="data_inicio" required>
                                        </div>
                                        <div class="form-group">
                                            <label><i class="fas fa-clock"></i> Hora de Início</label>
                                            <input type="time" id="eventTimeStart" name="hora_inicio" required>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label><i class="fas fa-calendar-alt"></i> Data de Fim</label>
                                            <input type="date" id="eventDateEnd" name="data_fim" required>
                                        </div>
                                        <div class="form-group">
                                            <label><i class="fas fa-clock"></i> Hora de Fim</label>
                                            <input type="time" id="eventTimeEnd" name="hora_fim" required>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row checkbox-full-width">
                                        <div class="form-group checkbox-full-width">
                                            <label><i class="fas fa-church"></i> Evento Paroquial</label>
                                            <div class="checkbox-group checkbox-full-width">
                                                <label class="checkbox-label checkbox-full-width">
                                                    <input type="checkbox" id="eventParoquial" name="evento_paroquial">
                                                    <span class="checkmark"></span>
                                                    Marcar como evento paroquial
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label><i class="fas fa-paperclip"></i> Anexos de Documento</label>
                                            <input type="file" id="eventAttachments" name="anexos" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                                            <div class="file-info">
                                                <small>Formatos aceitos: PDF, DOC, DOCX, JPG, PNG (máx. 10MB cada)</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>


                                <!-- Seção: Configurações Adicionais -->
                                <div class="form-section">
                                    <h3 class="section-title"><i class="fas fa-cog"></i> Configurações Adicionais</h3>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label><i class="fas fa-exclamation-circle"></i> Status</label>
                                            <select id="eventStatus" name="status" required>
                                                <option value="agendado">Agendado</option>
                                                <option value="confirmado">Confirmado</option>
                                                <option value="pendente">Pendente</option>
                                                <option value="cancelado">Cancelado</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label><i class="fas fa-eye"></i> Visibilidade</label>
                                            <select id="eventVisibility" name="visibilidade">
                                                <option value="publico">Público</option>
                                                <option value="privado">Privado</option>
                                                <option value="interno">Interno</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label><i class="fas fa-bell"></i> Lembrete</label>
                                            <select id="eventReminder" name="lembrete">
                                                <option value="nenhum">Nenhum</option>
                                                <option value="15min">15 minutos antes</option>
                                                <option value="30min">30 minutos antes</option>
                                                <option value="1hora">1 hora antes</option>
                                                <option value="1dia">1 dia antes</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label><i class="fas fa-users"></i> Capacidade Máxima</label>
                                            <input type="number" id="eventCapacity" name="capacidade" placeholder="Número de pessoas" min="1">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-actions">
                                    <button type="button" class="btn-secondary" onclick="closeEventModal()">
                                        <i class="fas fa-times"></i> Cancelar
                                    </button>
                                    <button type="submit" class="btn-primary">
                                        <i class="fas fa-save"></i> Salvar Evento
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            // Inserir modal no body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Configurar data se fornecida
            if (date) {
                const dateInput = document.getElementById('eventDateStart');
                if (dateInput) {
                    dateInput.value = date;
                }
            }
            
            // Adicionar event listener para o formulário
            const form = document.getElementById('eventForm');
            if (form) {
                form.addEventListener('submit', handleEventSubmit);
            }
            
            // Adicionar event listener para fechar ao clicar fora
            const modal = document.getElementById('eventModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeEventModal();
                    }
                });
            }
            
            // Adicionar event listener para o toggle de status
            const statusToggle = document.querySelector('.status-toggle');
            const statusLabel = document.querySelector('.status-label-modal');
            if (statusToggle && statusLabel) {
                statusToggle.addEventListener('change', function() {
                    statusLabel.textContent = this.checked ? 'Ativo' : 'Inativo';
                });
            }
            
            // Dados já foram carregados antecipadamente
            console.log('✅ Dados dos selects já carregados previamente');
            
            // Popular selects com dados do cache
            populateSelectsFromCache();
            
            // Aplicar estilos de altura máxima aos selects
            const selects = document.querySelectorAll('#eventModal select');
            selects.forEach(select => {
                select.style.maxHeight = '200px';
                select.style.overflowY = 'auto';
                select.style.height = 'auto';
            });

            // Inicializar selects customizados IMEDIATAMENTE (sem delays)
            console.log('🔄 Inicializando dropdowns customizados...');
            initializeCustomSelects('#eventModal');
            
            // Recarregar selects imediatamente após inicialização
            console.log('🔄 Recarregando selects após carregamento de dados...');
            reloadCustomSelects('#eventModal');
            
            // Ocultar spinner quando modal estiver pronto
            ocultarSpinnerAgenda();
            
            console.log('✅ Modal de novo agendamento criado e exibido');
        }

        // Utilitário: inicializa selects customizados com busca no container
        function initializeCustomSelects(containerSelector) {
            const container = document.querySelector(containerSelector);
            if (!container) {
                console.log('❌ Container não encontrado:', containerSelector);
                return;
            }

            // Aplicar aos selects
            const nativeSelects = container.querySelectorAll('select');
            console.log(`🔍 Encontrados ${nativeSelects.length} selects no container`);
            nativeSelects.forEach(select => {
                console.log(`📋 Processando select: ${select.id}`);
                makeCustomSelect(select);
            });
            
            // NÃO aplicar aos campos de data - deixar como inputs nativos
            // const dateInputs = container.querySelectorAll('input[type="date"]');
            // dateInputs.forEach(input => makeCustomDateField(input));
            
            // NÃO aplicar aos campos de hora - deixar como inputs nativos
            // const timeInputs = container.querySelectorAll('input[type="time"]');
            // timeInputs.forEach(input => makeCustomTimeField(input));
        }

        // Função para recarregar todos os selects customizados
        function reloadCustomSelects(containerSelector) {
            const container = document.querySelector(containerSelector);
            if (!container) return;
            
            console.log('🔄 Recarregando todos os selects customizados...');
            
            // Recarregar todos os campos customizados
            const customFields = container.querySelectorAll('.search-select-field');
            customFields.forEach(field => {
                if (field.reloadItems) {
                    field.reloadItems();
                }
            });
        }

        // Função para popular selects do modal usando dados do cache
        function populateSelectsFromCache() {
            console.log('🔄 Populando selects do modal com dados do cache...');
            
            // Popular select de comunidades
            const communitySelect = document.getElementById('eventCommunity');
            if (communitySelect && modalDataCache.comunidades.length > 0) {
                communitySelect.innerHTML = '<option value="">Selecione a comunidade</option>';
                modalDataCache.comunidades.forEach(comunidade => {
                    const option = document.createElement('option');
                    option.value = comunidade.id;
                    option.textContent = comunidade.nome;
                    communitySelect.appendChild(option);
                });
                console.log(`✅ ${modalDataCache.comunidades.length} comunidades adicionadas do cache`);
            }
            
            // Popular select de pastorais
            const pastoralSelect = document.getElementById('eventPastoral');
            if (pastoralSelect && modalDataCache.pastorais.length > 0) {
                pastoralSelect.innerHTML = '<option value="">Selecione a pastoral</option>';
                modalDataCache.pastorais.forEach(pastoral => {
                    const option = document.createElement('option');
                    option.value = pastoral.id;
                    option.textContent = pastoral.nome;
                    pastoralSelect.appendChild(option);
                });
                console.log(`✅ ${modalDataCache.pastorais.length} pastorais adicionadas do cache`);
            }
            
            // Popular select de pilares
            const pilarSelect = document.getElementById('eventPilares');
            if (pilarSelect && modalDataCache.pilares.length > 0) {
                pilarSelect.innerHTML = '<option value="">Selecione o pilar</option>';
                modalDataCache.pilares.forEach(pilar => {
                    const option = document.createElement('option');
                    option.value = pilar.id;
                    option.textContent = pilar.nome;
                    pilarSelect.appendChild(option);
                });
                console.log(`✅ ${modalDataCache.pilares.length} pilares adicionados do cache`);
            }
            
            // Popular select de ações
            const acaoSelect = document.getElementById('eventAcao');
            if (acaoSelect && modalDataCache.acoes.length > 0) {
                acaoSelect.innerHTML = '<option value="">Selecione a ação</option>';
                modalDataCache.acoes.forEach(acao => {
                    const option = document.createElement('option');
                    option.value = acao.id;
                    option.textContent = acao.nome;
                    acaoSelect.appendChild(option);
                });
                console.log(`✅ ${modalDataCache.acoes.length} ações adicionadas do cache`);
            }
            
            // Popular select de locais
            const localSelect = document.getElementById('eventLocation');
            if (localSelect && modalDataCache.locais.length > 0) {
                localSelect.innerHTML = '<option value="">Selecione o local</option>';
                modalDataCache.locais.forEach(local => {
                    const option = document.createElement('option');
                    option.value = local.id;
                    option.textContent = local.nome;
                    localSelect.appendChild(option);
                });
                console.log(`✅ ${modalDataCache.locais.length} locais adicionados do cache`);
            }
        }

        // Cria um campo de busca/seleção direto (substitui o select)
        function makeCustomSelect(nativeSelect) {
            if (!nativeSelect || nativeSelect.dataset.enhanced === 'true') return;
            
            console.log(`🔧 Criando select customizado para: ${nativeSelect.id}`);

            // Campo de busca direto
            const field = document.createElement('div');
            field.className = 'search-select-field';

            const input = document.createElement('input');
            input.type = 'text';
            const firstOptionText = (nativeSelect.options && nativeSelect.options[0] && nativeSelect.options[0].textContent) || 'Selecione';
            input.placeholder = firstOptionText;
            const selectedOpt = nativeSelect.selectedOptions && nativeSelect.selectedOptions[0];
            input.value = selectedOpt && selectedOpt.value !== '' ? (selectedOpt.textContent || '') : '';

            // Menu de opções
            const menu = document.createElement('div');
            menu.className = 'search-select-menu';

            const list = document.createElement('div');
            list.className = 'search-select-list';

            // Monta itens iniciais
            const buildItems = () => {
                list.innerHTML = '';
                const options = Array.from(nativeSelect.options);
                console.log(`🔍 BuildItems para ${nativeSelect.id}: ${options.length} opções encontradas`);
                
                if (options.length <= 1) {
                    // Se não há opções além do placeholder, mostrar mensagem
                    const item = document.createElement('div');
                    item.className = 'search-select-item no-options';
                    item.textContent = 'Nenhuma opção disponível';
                    list.appendChild(item);
                    return;
                }
                
                options.forEach((opt) => {
                    const text = (opt.textContent || '').trim();
                    const isPlaceholder = opt.value === '' || /^\s*selecione/i.test(text);
                    if (isPlaceholder) return;

                    const item = document.createElement('div');
                    item.className = 'search-select-item' + (opt.selected ? ' is-selected' : '');
                    item.dataset.value = opt.value;
                    item.textContent = text;
                    item.addEventListener('click', () => {
                        // Atualiza select nativo
                        nativeSelect.value = opt.value;
                        nativeSelect.dispatchEvent(new Event('change'));
                        // Atualiza UI
                        list.querySelectorAll('.search-select-item').forEach(el => el.classList.remove('is-selected'));
                        item.classList.add('is-selected');
                        input.value = opt.textContent || '';
                        field.classList.remove('open');
                    });
                    list.appendChild(item);
                });
            };
            
            // Aguardar um pouco para garantir que os dados foram carregados
            setTimeout(() => {
                console.log(`🔄 Executando buildItems para ${nativeSelect.id}`);
                buildItems();
            }, 200);
            
            // Função para recarregar itens (chamada quando dados são carregados)
            const reloadItems = () => {
                console.log(`🔄 Recarregando itens para ${nativeSelect.id}`);
                buildItems();
            };
            
            // Expor função para recarregamento externo
            field.reloadItems = reloadItems;

            // Máscara de formatação e filtragem
            input.addEventListener('input', (e) => {
                let value = e.target.value;
                
                // Aplicar máscara HH:MM apenas se estiver digitando números
                if (value.length > 0 && /^\d/.test(value)) {
                    // Remover caracteres não numéricos
                    value = value.replace(/\D/g, '');
                    
                    // Aplicar máscara HH:MM
                    if (value.length >= 2) {
                        value = value.substring(0, 2) + ':' + value.substring(2, 4);
                    }
                    
                    // Limitar a 5 caracteres (HH:MM)
                    if (value.length > 5) {
                        value = value.substring(0, 5);
                    }
                    
                    e.target.value = value;
                }
                
                // Filtragem por texto para a lista de horários
                const term = value.trim().toLowerCase();
                list.querySelectorAll('.search-select-item').forEach(item => {
                    const text = item.textContent.toLowerCase();
                    const match = text.includes(term);
                    item.style.display = match ? '' : 'none';
                });
            });

            // Abrir menu
            const openMenu = () => {
                document.querySelectorAll('#eventModal .search-select-field.open').forEach(f => {
                    if (f !== field) f.classList.remove('open');
                });
                if (!field.classList.contains('open')) {
                    field.classList.add('open');
                    list.querySelectorAll('.search-select-item').forEach(item => { item.style.display = ''; });
                    setTimeout(() => input.focus(), 0);
                }
            };

            input.addEventListener('focus', openMenu);
            input.addEventListener('click', (e) => {
                e.stopPropagation();
                openMenu();
            });

            // Fechar ao clicar fora
            document.addEventListener('click', (e) => {
                if (!field.contains(e.target)) {
                    field.classList.remove('open');
                }
            });

            // Sincronizar mudanças
            nativeSelect.addEventListener('change', () => {
                const selectedText = getSelectedOptionText(nativeSelect) || '';
                input.value = selectedText;
                list.querySelectorAll('.search-select-item').forEach(el => {
                    el.classList.toggle('is-selected', el.dataset.value === nativeSelect.value);
                });
            });

            // Substituir o select na DOM
            nativeSelect.parentNode.insertBefore(field, nativeSelect);
            field.appendChild(input);
            menu.appendChild(list);
            field.appendChild(menu);
            
            // Ocultar select original
            nativeSelect.style.display = 'none';
            nativeSelect.dataset.enhanced = 'true';
        }

        // Cria um campo de data customizado com calendário
        function makeCustomDateField(dateInput) {
            if (!dateInput || dateInput.dataset.enhanced === 'true') return;

            // Campo de busca direto
            const field = document.createElement('div');
            field.className = 'search-select-field';

            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'Selecione uma data';
            input.value = dateInput.value ? formatDateForDisplay(dateInput.value) : '';

            // Menu com calendário
            const menu = document.createElement('div');
            menu.className = 'search-select-menu';
            menu.style.width = '320px';

            const calendar = document.createElement('div');
            calendar.className = 'mini-calendar';

            // Gerar calendário
            const buildCalendar = () => {
                calendar.innerHTML = '';
                const today = new Date();
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();
                
                // Cabeçalho do calendário
                const header = document.createElement('div');
                header.className = 'calendar-header';
                
                const prevBtn = document.createElement('button');
                prevBtn.className = 'calendar-nav';
                prevBtn.type = 'button';
                prevBtn.innerHTML = '‹';
                
                const title = document.createElement('span');
                title.className = 'calendar-title';
                title.textContent = `${getMonthName(currentMonth)} ${currentYear}`;
                
                const nextBtn = document.createElement('button');
                nextBtn.className = 'calendar-nav';
                nextBtn.type = 'button';
                nextBtn.innerHTML = '›';
                
                // Navegação de mês
                let currentDisplayMonth = currentMonth;
                let currentDisplayYear = currentYear;
                
                const updateCalendar = () => {
                    title.textContent = `${getMonthName(currentDisplayMonth)} ${currentDisplayYear}`;
                    // Recriar os dias do calendário
                    const daysContainer = calendar.querySelector('.calendar-days');
                    if (daysContainer) {
                        daysContainer.innerHTML = '';
                        
                        const firstDay = new Date(currentDisplayYear, currentDisplayMonth, 1);
                        const startDate = new Date(firstDay);
                        startDate.setDate(startDate.getDate() - firstDay.getDay());

                        for (let i = 0; i < 42; i++) {
                            const day = new Date(startDate);
                            day.setDate(startDate.getDate() + i);
                            
                            const dayElement = document.createElement('div');
                            dayElement.className = 'calendar-day';
                            
                            if (day.getMonth() === currentDisplayMonth) {
                                dayElement.textContent = day.getDate();
                                dayElement.dataset.date = day.toISOString().split('T')[0];
                                
                                // Marcar hoje
                                if (day.toDateString() === today.toDateString()) {
                                    dayElement.classList.add('today');
                                }
                                
                                // Marcar selecionado
                                if (day.toISOString().split('T')[0] === dateInput.value) {
                                    dayElement.classList.add('selected');
                                }
                                
                                // Adicionar evento de clique
                                dayElement.addEventListener('click', () => {
                                    const selectedDate = dayElement.dataset.date;
                                    dateInput.value = selectedDate;
                                    dateInput.dispatchEvent(new Event('change'));
                                    input.value = formatDateForDisplay(selectedDate);
                                    field.classList.remove('open');
                                });
                            } else {
                                dayElement.classList.add('other-month');
                            }
                            
                            daysContainer.appendChild(dayElement);
                        }
                    }
                };
                
                prevBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    currentDisplayMonth--;
                    if (currentDisplayMonth < 0) {
                        currentDisplayMonth = 11;
                        currentDisplayYear--;
                    }
                    updateCalendar();
                });
                
                nextBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    currentDisplayMonth++;
                    if (currentDisplayMonth > 11) {
                        currentDisplayMonth = 0;
                        currentDisplayYear++;
                    }
                    updateCalendar();
                });
                
                header.appendChild(prevBtn);
                header.appendChild(title);
                header.appendChild(nextBtn);
                calendar.appendChild(header);

                // Dias da semana
                const weekdays = document.createElement('div');
                weekdays.className = 'calendar-weekdays';
                weekdays.innerHTML = `
                    <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div>
                    <div>Qui</div><div>Sex</div><div>Sáb</div>
                `;
                calendar.appendChild(weekdays);

                // Dias do mês
                const daysContainer = document.createElement('div');
                daysContainer.className = 'calendar-days';
                
                const firstDay = new Date(currentYear, currentMonth, 1);
                const lastDay = new Date(currentYear, currentMonth + 1, 0);
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - firstDay.getDay());

                for (let i = 0; i < 42; i++) {
                    const day = new Date(startDate);
                    day.setDate(startDate.getDate() + i);
                    
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day';
                    
                    if (day.getMonth() === currentMonth) {
                        dayElement.textContent = day.getDate();
                        dayElement.dataset.date = day.toISOString().split('T')[0];
                        
                        // Marcar hoje
                        if (day.toDateString() === today.toDateString()) {
                            dayElement.classList.add('today');
                        }
                        
                        // Marcar selecionado
                        if (day.toISOString().split('T')[0] === dateInput.value) {
                            dayElement.classList.add('selected');
                        }
                        
                        // Adicionar evento de clique
                        dayElement.addEventListener('click', () => {
                            const selectedDate = dayElement.dataset.date;
                            dateInput.value = selectedDate;
                            dateInput.dispatchEvent(new Event('change'));
                            input.value = formatDateForDisplay(selectedDate);
                            field.classList.remove('open');
                        });
                    } else {
                        dayElement.classList.add('other-month');
                    }
                    
                    daysContainer.appendChild(dayElement);
                }
                
                calendar.appendChild(daysContainer);
            };
            buildCalendar();

            // Máscara de formatação e navegação do calendário
            input.addEventListener('input', (e) => {
                let value = e.target.value;
                
                // Aplicar máscara DD/MM/AAAA apenas se estiver digitando números
                if (value.length > 0 && /^\d/.test(value)) {
                    // Remover caracteres não numéricos
                    value = value.replace(/\D/g, '');
                    
                    // Aplicar máscara DD/MM/AAAA
                    if (value.length >= 2) {
                        value = value.substring(0, 2) + '/' + value.substring(2);
                    }
                    if (value.length >= 5) {
                        value = value.substring(0, 5) + '/' + value.substring(5, 9);
                    }
                    
                    // Limitar a 10 caracteres (DD/MM/AAAA)
                    if (value.length > 10) {
                        value = value.substring(0, 10);
                    }
                    
                    e.target.value = value;
                }
                
                // Se for uma data completa, navegar para ela no calendário
                if (value.length === 10 && /^\d{2}\/\d{2}\/\d{4}$/.test(value)) {
                    const [day, month, year] = value.split('/');
                    const dayNum = parseInt(day);
                    const monthNum = parseInt(month);
                    const yearNum = parseInt(year);
                    
                    // Verificar se é uma data válida
                    if (dayNum >= 1 && dayNum <= 31 && monthNum >= 1 && monthNum <= 12 && yearNum >= 1900 && yearNum <= 2100) {
                        const dateObj = new Date(yearNum, monthNum - 1, dayNum);
                        
                        // Verificar se a data é realmente válida
                        if (dateObj.getDate() === dayNum && dateObj.getMonth() === monthNum - 1 && dateObj.getFullYear() === yearNum) {
                            // Navegar para a data no calendário
                            navigateToDate(calendar, yearNum, monthNum - 1);
                            
                            // Atualizar o input de data original
                            const isoDate = dateObj.toISOString().split('T')[0];
                            dateInput.value = isoDate;
                            dateInput.dispatchEvent(new Event('change'));
                            
                            // Atualizar seleção no calendário
                            calendar.querySelectorAll('.calendar-day').forEach(day => {
                                day.classList.toggle('selected', day.dataset.date === isoDate);
                            });
                            
                            return;
                        }
                    }
                }
                
                // Filtragem por texto para o calendário
                const term = value.trim().toLowerCase();
                const days = calendar.querySelectorAll('.calendar-day');
                days.forEach(day => {
                    if (day.dataset.date) {
                        const dayText = formatDateForDisplay(day.dataset.date).toLowerCase();
                        const match = dayText.includes(term);
                        day.style.display = match ? '' : 'none';
                    }
                });
            });

            // Abrir menu
            const openMenu = () => {
                document.querySelectorAll('#eventModal .search-select-field.open').forEach(f => {
                    if (f !== field) f.classList.remove('open');
                });
                if (!field.classList.contains('open')) {
                    field.classList.add('open');
                    // Mostrar todos os dias ao abrir
                    calendar.querySelectorAll('.calendar-day').forEach(day => { day.style.display = ''; });
                    setTimeout(() => input.focus(), 0);
                }
            };

            input.addEventListener('focus', openMenu);
            input.addEventListener('click', (e) => {
                e.stopPropagation();
                openMenu();
            });

            // Fechar ao clicar fora
            document.addEventListener('click', (e) => {
                if (!field.contains(e.target)) {
                    field.classList.remove('open');
                }
            });

            // Sincronizar mudanças simples
            dateInput.addEventListener('change', () => {
                const displayValue = dateInput.value ? formatDateForDisplay(dateInput.value) : '';
                input.value = displayValue;
                // Atualizar seleção no calendário
                calendar.querySelectorAll('.calendar-day').forEach(day => {
                    day.classList.toggle('selected', day.dataset.date === dateInput.value);
                });
            });

            // Substituir o input de data na DOM
            dateInput.parentNode.insertBefore(field, dateInput);
            field.appendChild(input);
            menu.appendChild(calendar);
            field.appendChild(menu);
            
            // Ocultar input original
            dateInput.style.display = 'none';
            dateInput.dataset.enhanced = 'true';
        }

        function formatDateForDisplay(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function getSelectedOptionText(selectEl) {
            const opt = selectEl.selectedOptions && selectEl.selectedOptions[0];
            return opt ? opt.textContent : '';
        }

        // Cria um campo de hora customizado com busca/seleção
        function makeCustomTimeField(timeInput) {
            if (!timeInput || timeInput.dataset.enhanced === 'true') return;

            // Campo de busca direto
            const field = document.createElement('div');
            field.className = 'search-select-field';

            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'Selecione um horário';
            input.value = timeInput.value ? formatTimeForDisplay(timeInput.value) : '';

            // Menu de opções (horários sugeridos)
            const menu = document.createElement('div');
            menu.className = 'search-select-menu';

            const list = document.createElement('div');
            list.className = 'search-select-list';

            // Gerar opções de horário
            const buildTimeOptions = () => {
                list.innerHTML = '';
                const options = [];
                
                // Gerar horários de 06:00 às 22:00 em intervalos de 30 minutos
                for (let hour = 6; hour <= 22; hour++) {
                    for (let minute = 0; minute < 60; minute += 30) {
                        const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                        options.push({
                            value: timeString,
                            text: formatTimeForDisplay(timeString)
                        });
                    }
                }

                options.forEach(opt => {
                    const item = document.createElement('div');
                    item.className = 'search-select-item' + (opt.value === timeInput.value ? ' is-selected' : '');
                    item.dataset.value = opt.value;
                    item.textContent = opt.text;
                    item.addEventListener('click', () => {
                        // Atualiza input de hora original
                        timeInput.value = opt.value;
                        timeInput.dispatchEvent(new Event('change'));
                        // Atualiza UI
                        list.querySelectorAll('.search-select-item').forEach(el => el.classList.remove('is-selected'));
                        item.classList.add('is-selected');
                        input.value = opt.text;
                        field.classList.remove('open');
                    });
                    list.appendChild(item);
                });
            };
            buildTimeOptions();

            // Máscara de formatação e filtragem
            input.addEventListener('input', (e) => {
                let value = e.target.value;
                
                // Aplicar máscara HH:MM apenas se estiver digitando números
                if (value.length > 0 && /^\d/.test(value)) {
                    // Remover caracteres não numéricos
                    value = value.replace(/\D/g, '');
                    
                    // Aplicar máscara HH:MM
                    if (value.length >= 2) {
                        value = value.substring(0, 2) + ':' + value.substring(2, 4);
                    }
                    
                    // Limitar a 5 caracteres (HH:MM)
                    if (value.length > 5) {
                        value = value.substring(0, 5);
                    }
                    
                    e.target.value = value;
                }
                
                // Filtragem por texto para a lista de horários
                const term = value.trim().toLowerCase();
                list.querySelectorAll('.search-select-item').forEach(item => {
                    const text = item.textContent.toLowerCase();
                    const match = text.includes(term);
                    item.style.display = match ? '' : 'none';
                });
            });

            // Abrir menu
            const openMenu = () => {
                document.querySelectorAll('#eventModal .search-select-field.open').forEach(f => {
                    if (f !== field) f.classList.remove('open');
                });
                if (!field.classList.contains('open')) {
                    field.classList.add('open');
                    list.querySelectorAll('.search-select-item').forEach(item => { item.style.display = ''; });
                    setTimeout(() => input.focus(), 0);
                }
            };

            input.addEventListener('focus', openMenu);
            input.addEventListener('click', (e) => {
                e.stopPropagation();
                openMenu();
            });

            // Fechar ao clicar fora
            document.addEventListener('click', (e) => {
                if (!field.contains(e.target)) {
                    field.classList.remove('open');
                }
            });

            // Sincronizar mudanças
            timeInput.addEventListener('change', () => {
                const displayValue = timeInput.value ? formatTimeForDisplay(timeInput.value) : '';
                input.value = displayValue;
                list.querySelectorAll('.search-select-item').forEach(el => {
                    el.classList.toggle('is-selected', el.dataset.value === timeInput.value);
                });
            });

            // Substituir o input de hora na DOM
            timeInput.parentNode.insertBefore(field, timeInput);
            field.appendChild(input);
            menu.appendChild(list);
            field.appendChild(menu);
            
            // Ocultar input original
            timeInput.style.display = 'none';
            timeInput.dataset.enhanced = 'true';
        }

        function formatTimeForDisplay(timeString) {
            if (!timeString) return '';
            const [hours, minutes] = timeString.split(':');
            const hour = parseInt(hours);
            const minute = parseInt(minutes);
            
            if (hour === 0 && minute === 0) return 'Meia-noite';
            if (hour === 12 && minute === 0) return 'Meio-dia';
            
            const period = hour < 12 ? 'AM' : 'PM';
            const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
            const displayMinute = minute === 0 ? '' : `:${minutes}`;
            
            return `${displayHour}${displayMinute} ${period}`;
        }

        function getMonthName(monthIndex) {
            const months = [
                'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];
            return months[monthIndex];
        }

        // Navegar para uma data específica no calendário
        function navigateToDate(calendar, year, month) {
            const header = calendar.querySelector('.calendar-header');
            const title = header.querySelector('.calendar-title');
            const daysContainer = calendar.querySelector('.calendar-days');
            
            if (!header || !title || !daysContainer) return;
            
            // Atualizar título
            title.textContent = `${getMonthName(month)} ${year}`;
            
            // Recriar os dias do calendário
            daysContainer.innerHTML = '';
            
            const firstDay = new Date(year, month, 1);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            for (let i = 0; i < 42; i++) {
                const day = new Date(startDate);
                day.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                if (day.getMonth() === month) {
                    dayElement.textContent = day.getDate();
                    dayElement.dataset.date = day.toISOString().split('T')[0];
                    
                    // Marcar hoje
                    const today = new Date();
                    if (day.toDateString() === today.toDateString()) {
                        dayElement.classList.add('today');
                    }
                    
                    // Adicionar evento de clique
                    dayElement.addEventListener('click', () => {
                        const selectedDate = dayElement.dataset.date;
                        const dateInput = calendar.closest('.search-select-field').querySelector('input[type="date"]');
                        if (dateInput) {
                            dateInput.value = selectedDate;
                            dateInput.dispatchEvent(new Event('change'));
                        }
                        calendar.closest('.search-select-field').classList.remove('open');
                    });
                } else {
                    dayElement.classList.add('other-month');
                }
                
                daysContainer.appendChild(dayElement);
            }
        }


        function loadEventModalData() {
            console.log('Modal de novo agendamento não está disponível');
        }

        // Cache para dados dos selects
        let modalDataCache = {
            comunidades: [],
            pastorais: [],
            pilares: [],
            acoes: [],
            locais: []
        };

        // Função para carregar comunidades (com cache)
        async function loadEventCommunities() {
            // Verificar se já temos dados no cache
            if (modalDataCache.comunidades.length > 0) {
                console.log('✅ Comunidades já carregadas do cache:', modalDataCache.comunidades.length);
                return;
            }
            
            try {
                console.log('🔄 Carregando comunidades...');
                const { data, error } = await window.api.get(window.endpoints.comunidades.list);
                if (error) throw error;
                
                const comunidades = Array.isArray(data) ? data : [];
                console.log(`📋 ${comunidades.length} comunidades carregadas da API`);
                
                // Armazenar no cache
                modalDataCache.comunidades = comunidades;
                
                const select = document.getElementById('eventCommunity');
                if (select) {
                    // Limpar opções existentes (exceto a primeira)
                    select.innerHTML = '<option value="">Selecione a comunidade</option>';
                    
                    // Adicionar opções das comunidades
                    comunidades.forEach(comunidade => {
                        const option = document.createElement('option');
                        option.value = comunidade.id;
                        option.textContent = comunidade.nome;
                        select.appendChild(option);
                    });
                    
                    console.log(`✅ ${comunidades.length} opções adicionadas ao select eventCommunity`);
                    console.log('🔍 Opções do select:', Array.from(select.options).map(opt => opt.textContent));
                }
            } catch (error) {
                console.error('❌ Erro ao carregar comunidades:', error);
                const select = document.getElementById('eventCommunity');
                if (select) {
                    select.innerHTML = '<option value="">Erro ao carregar comunidades</option>';
                }
            }
        }

        // Função para carregar pastorais (com cache)
        async function loadEventPastorals() {
            // Verificar se já temos dados no cache
            if (modalDataCache.pastorais.length > 0) {
                console.log('✅ Pastorais já carregadas do cache:', modalDataCache.pastorais.length);
                return;
            }
            
            try {
                console.log('🔄 Carregando pastorais...');
                const { data, error } = await window.api.get(window.endpoints.pastorais.list);
                if (error) throw error;
                
                const pastorais = Array.isArray(data) ? data : [];
                // Armazenar no cache
                modalDataCache.pastorais = pastorais;
                
                const select = document.getElementById('eventPastoral');
                if (select) {
                    // Limpar opções existentes (exceto a primeira)
                    select.innerHTML = '<option value="">Selecione a pastoral</option>';
                    
                    // Adicionar opções das pastorais
                    pastorais.forEach(pastoral => {
                        const option = document.createElement('option');
                        option.value = pastoral.id;
                        option.textContent = pastoral.nome;
                        select.appendChild(option);
                    });
                    
                    console.log('✅ Pastorais carregadas:', pastorais.length);
                }
            } catch (error) {
                console.error('❌ Erro ao carregar pastorais:', error);
                const select = document.getElementById('eventPastoral');
                if (select) {
                    select.innerHTML = '<option value="">Erro ao carregar pastorais</option>';
                }
            }
        }

        // Função para carregar pilares (com cache)
        async function loadEventPilares() {
            // Verificar se já temos dados no cache
            if (modalDataCache.pilares.length > 0) {
                console.log('✅ Pilares já carregados do cache:', modalDataCache.pilares.length);
                return;
            }
            
            try {
                console.log('🔄 Carregando pilares...');
                const { data, error } = await window.api.get(window.endpoints.pilares.list);
                if (error) throw error;
                
                const pilares = Array.isArray(data) ? data : [];
                
                // Armazenar no cache
                modalDataCache.pilares = pilares;
                console.log('✅ Pilares carregados e armazenados no cache:', pilares.length);
                
            } catch (error) {
                console.error('❌ Erro ao carregar pilares:', error);
                modalDataCache.pilares = [];
            }
        }

        // Função para carregar ações (com cache)
        async function loadEventAcoes() {
            // Verificar se já temos dados no cache
            if (modalDataCache.acoes.length > 0) {
                console.log('✅ Ações já carregadas do cache:', modalDataCache.acoes.length);
                return;
            }
            
            try {
                console.log('🔄 Carregando ações...');
                const { data, error } = await window.api.get(window.endpoints.acoes.list);
                if (error) throw error;
                
                const acoes = Array.isArray(data) ? data : [];
                
                // Armazenar no cache
                modalDataCache.acoes = acoes;
                console.log('✅ Ações carregadas e armazenadas no cache:', acoes.length);
                
            } catch (error) {
                console.error('❌ Erro ao carregar ações:', error);
                modalDataCache.acoes = [];
            }
        }

        // Função para carregar locais (com cache)
        async function loadEventLocais() {
            // Verificar se já temos dados no cache
            if (modalDataCache.locais.length > 0) {
                console.log('✅ Locais já carregados do cache:', modalDataCache.locais.length);
                return;
            }
            
            try {
                console.log('🔄 Carregando locais...');
                const { data, error } = await window.api.get(window.endpoints.locais.list);
                if (error) throw error;
                
                const locais = Array.isArray(data) ? data : [];
                
                // Armazenar no cache
                modalDataCache.locais = locais;
                console.log('✅ Locais carregados e armazenados no cache:', locais.length);
                
            } catch (error) {
                console.error('❌ Erro ao carregar locais:', error);
                modalDataCache.locais = [];
            }
        }

        function closeEventModal() {
            console.log('🔒 Fechando modal de novo agendamento...');
            
            const modal = document.getElementById('eventModal');
            if (modal) {
                modal.remove();
                console.log('✅ Modal removido com sucesso');
            } else {
                console.log('⚠️ Modal não encontrado');
            }
        }

        function clearEventForm() {
            // Limpar todos os campos do formulário
            const form = document.getElementById('eventForm');
            if (form) {
                form.reset();
                
                // Limpar campos específicos
                const fields = [
                    'eventTitle', 'eventCommunity', 'eventPastoral', 'eventPilares',
                    'eventLocation', 'eventAcao', 'eventObjetivo', 'eventDateStart',
                    'eventTimeStart', 'eventDateEnd', 'eventTimeEnd', 'eventStatus',
                    'eventVisibility', 'eventReminder', 'eventCapacity'
                ];
                
                fields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.value = '';
                    }
                });
                
                // Limpar checkbox
                const checkbox = document.getElementById('eventParoquial');
                if (checkbox) {
                    checkbox.checked = false;
                }
                
                // Limpar toggle de status
                const toggle = document.querySelector('.status-toggle');
                if (toggle) {
                    toggle.checked = true;
                }
            }
        }

        function editEvent(event) {
            console.log('Modal de edição não está disponível');
            alert('Modal de edição de eventos não está disponível no momento.');
        }

        async function handleEventSubmit(e) {
            e.preventDefault();
            console.log('💾 Processando formulário de novo agendamento...');
            
            // Coletar dados do formulário
            const formData = {
                titulo: document.getElementById('eventTitle').value,
                comunidade: document.getElementById('eventCommunity').value,
                pastoral: document.getElementById('eventPastoral').value,
                pilares: document.getElementById('eventPilares').value,
                local: document.getElementById('eventLocation').value,
                acao: document.getElementById('eventAcao').value,
                objetivo: document.getElementById('eventObjetivo').value,
                dataInicio: document.getElementById('eventDateStart').value,
                horaInicio: document.getElementById('eventTimeStart').value,
                dataFim: document.getElementById('eventDateEnd').value,
                horaFim: document.getElementById('eventTimeEnd').value,
                eventoParoquial: document.getElementById('eventParoquial').checked,
                anexos: document.getElementById('eventAttachments').files,
                status: document.getElementById('eventStatus').value,
                visibilidade: document.getElementById('eventVisibility').value,
                lembrete: document.getElementById('eventReminder').value,
                capacidade: document.getElementById('eventCapacity').value,
                ativo: document.querySelector('.status-toggle').checked
            };
            
            // Validação básica
            if (!formData.titulo || !formData.comunidade || !formData.pastoral || !formData.pilares || 
                !formData.local || !formData.acao || !formData.dataInicio || !formData.horaInicio || 
                !formData.dataFim || !formData.horaFim || !formData.status) {
                showToast('Por favor, preencha todos os campos obrigatórios.', 'error');
                return;
            }
            
            // Validar se data de fim é posterior à data de início
            const dataInicio = new Date(formData.dataInicio + ' ' + formData.horaInicio);
            const dataFim = new Date(formData.dataFim + ' ' + formData.horaFim);
            if (dataFim <= dataInicio) {
                showToast('A data e hora de fim devem ser posteriores à data e hora de início.', 'error');
                return;
            }
            
            // Validar se a data não é no passado
            const now = new Date();
            if (dataInicio < now) {
                showToast('A data e hora de início do evento não podem ser no passado.', 'error');
                return;
            }
            
            console.log('📋 Dados do evento:', formData);
            
            try {
                // Preparar dados para a API
                const eventData = {
                    titulo: formData.titulo,
                    descricao: formData.objetivo || '',
                    objetivo: formData.objetivo || '',
                    data_inicio: new Date(formData.dataInicio + ' ' + formData.horaInicio).toISOString(),
                    data_fim: new Date(formData.dataFim + ' ' + formData.horaFim).toISOString(),
                    local_id: parseInt(formData.local),
                    acao_id: parseInt(formData.acao),
                    responsavel_id: null, // Pode ser implementado depois
                    comunidade_id: parseInt(formData.comunidade),
                    pastoral_id: parseInt(formData.pastoral),
                    pilar_id: parseInt(formData.pilares),
                    status: formData.ativo ? 'Ativo' : 'Inativo',
                    evento_paroquial: formData.eventoParoquial || false,
                    visibilidade: formData.visibilidade || 'Publico',
                    lembrete: formData.lembrete || 'Nenhum',
                    capacidade: formData.capacidade ? parseInt(formData.capacidade) : null
                };
                
                console.log('🚀 Enviando evento para API:', eventData);
                
                // Salvar evento na API
                const { data, error } = await window.api.post(window.endpoints.agenda.create, eventData);
                
                if (error) {
                    throw error;
                }
                
                console.log('✅ Evento criado com sucesso:', data);
                showToast('Evento criado com sucesso!', 'success');
                
                // Limpar formulário
                clearEventForm();
                
                // Fechar o modal
                closeEventModal();
                
                // Recarregar eventos
                await loadEventsFromApi();
                filterEventsByCommunity();
                
            } catch (error) {
                console.error('❌ Erro ao criar evento:', error);
                showToast('Erro ao criar evento: ' + (error.message || 'Erro desconhecido'), 'error');
            }
        }

        async function deleteEvent(eventId) {
            if (!confirm('Tem certeza que deseja excluir este evento?')) return;
            try {
                const { error } = await window.api.delete(window.endpoints.agenda.delete(eventId));
                if (error) throw error;
                await loadEventsFromApi();
                filterEventsByCommunity();
                showToast('Evento excluído com sucesso!', 'success');
            } catch (err) {
                console.error('Erro ao excluir evento:', err);
                showToast('Erro ao excluir evento', 'error');
            }
        }

        async function loadCommunities() {
            try {
                const { data, error } = await window.api.get(window.endpoints.comunidades.list);
                if (error) throw error;
                const lista = Array.isArray(data) ? data : [];
                
                // Atualizar dropdown de comunidades
                const communityDropdownMenu = document.querySelector('.community-dropdown-menu');
                const currentCommunityText = document.getElementById('currentCommunityText');
                
                if (communityDropdownMenu && currentCommunityText) {
                    // Criar opção "Todas as comunidades"
                    let menuHTML = '<a href="#" class="community-dropdown-item" data-community-id="">Todas as comunidades</a>';
                    
                    // Adicionar comunidades
                    menuHTML += lista.map(comunidade => 
                        `<a href="#" class="community-dropdown-item" data-community-id="${comunidade.id}">${comunidade.nome}</a>`
                    ).join('');
                    
                    communityDropdownMenu.innerHTML = menuHTML;
                    currentCommunityText.textContent = 'Todas as comunidades';
                    
                    // Event listeners para os itens do dropdown
                    const communityItems = document.querySelectorAll('.community-dropdown-item');
                    communityItems.forEach(item => {
                        item.addEventListener('click', function(e) {
                            e.preventDefault();
                            const communityId = this.getAttribute('data-community-id');
                            const communityName = this.textContent;
                            
                            // Atualizar texto do trigger
                            currentCommunityText.textContent = communityName;
                            
                            // Atualizar filtro
                            selectedCommunityId = communityId ? parseInt(communityId) : null;
                            filterEventsByCommunity();
                            
                            if (typeof showToast === 'function') {
                                showToast(`Filtrando por: ${communityName}`, 'info');
                            }
                        });
                    });
                }
            } catch (err) {
                console.error('Erro ao carregar comunidades:', err);
                const currentCommunityText = document.getElementById('currentCommunityText');
                if (currentCommunityText) {
                    currentCommunityText.textContent = 'Erro ao carregar';
                }
            }
        }

        async function loadEventsFromApi() {
            try {
                console.log('🔄 Carregando eventos da API...');
                const { data, error } = await window.api.get(window.endpoints.agenda.list);
                if (error) throw error;
                
                const lista = Array.isArray(data) ? data : [];
                console.log('📋 Eventos recebidos da API:', lista.length);
                
                // Normalizar objetos para uso no calendário
                allEvents = lista.map(ev => {
                    // Buscar informações relacionadas
                    const localNome = ev.locais?.nome || ev.local_nome || 'Local não informado';
                    const acaoNome = ev.acoes?.nome || ev.acao_nome || 'Ação não informada';
                    const responsavelNome = ev.pessoas?.nome || ev.responsavel_nome || 'Responsável não informado';
                    const comunidadeNome = ev.comunidades?.nome || ev.comunidade_nome || 'Comunidade não informada';
                    const pastoralNome = ev.pastorais?.nome || ev.pastoral_nome || 'Pastoral não informada';
                    const pilarNome = ev.pilares?.nome || ev.pilar_nome || 'Pilar não informado';
                    const usuarioLancamento = ev.usuarios?.nome || ev.usuario_lancamento_nome || 'Sistema';
                    
                    return {
                        ...ev,
                        // Garantir compatibilidade de tipos
                        startTime: ev.startTime || ev.start_time || ev.inicio || ev.data_inicio || ev.dataHoraInicio || ev.start || ev.startedAt || ev.inicio_iso || ev.inicioISO || ev.data_inicio_iso || ev.dataInicioISO || ev.data_inicio_iso || ev.start_iso || ev.startISO || ev.startDate || ev.start_date,
                        endTime: ev.endTime || ev.end_time || ev.fim || ev.data_fim || ev.dataHoraFim || ev.end || ev.endedAt || ev.fim_iso || ev.fimISO || ev.data_fim_iso || ev.dataFimISO || ev.data_fim_iso || ev.end_iso || ev.endISO || ev.endDate || ev.end_date,
                        // Adicionar informações relacionadas
                        local_nome: localNome,
                        acao_nome: acaoNome,
                        responsavel_nome: responsavelNome,
                        comunidade_nome: comunidadeNome,
                        pastoral_nome: pastoralNome,
                        pilar_nome: pilarNome,
                        usuario_lancamento_nome: usuarioLancamento,
                        // Garantir título
                        title: ev.titulo || ev.title || 'Agendamento sem título',
                        // Garantir cor baseada no pilar da ação
                        color: ev.acoes?.pilares?.cor || ev.pilares?.cor || ev.cor || '#1e3a8a'
                    };
                });
                
                console.log('✅ Eventos processados:', allEvents.length);
                
                // Aplicar filtro inicial
                filterEventsByCommunity();
            } catch (err) {
                console.error('❌ Erro ao carregar eventos da API:', err);
                showToast('Erro ao carregar eventos: ' + (err.message || 'Erro desconhecido'), 'error');
                allEvents = [];
                events = [];
            }
        }

        function filterEventsByCommunity() {
            if (selectedCommunityId === null) {
                // Mostrar todos os eventos
                events = [...allEvents];
            } else {
                // Filtrar eventos por comunidade
                events = allEvents.filter(event => {
                    // Verificar se o evento tem vínculo com a comunidade selecionada
                    if (event.vinculos && Array.isArray(event.vinculos)) {
                        return event.vinculos.some(vinculo => 
                            vinculo.comunidade_id === selectedCommunityId
                        );
                    }
                    return false;
                });
            }
            
            // Atualizar calendário
            renderCalendar();
            updateMiniCalendar();
            updateRecentAppointments();
        }

        function updateRecentAppointments() {
            const appointmentsList = document.getElementById('recentAppointmentsList');
            appointmentsList.innerHTML = '';

            // Ordenar eventos por data (mais recentes primeiro)
            const sortedEvents = [...events].sort((a, b) => new Date(b.startTime) - new Date(a.startTime));
            
            // Pegar os últimos 5 eventos
            const recentEvents = sortedEvents.slice(0, 5);

            if (recentEvents.length === 0) {
                appointmentsList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #666; font-size: 12px;">
                        <i class="fas fa-calendar-plus" style="font-size: 24px; margin-bottom: 8px; display: block; opacity: 0.5;"></i>
                        Nenhum agendamento encontrado
                    </div>
                `;
                return;
            }

            recentEvents.forEach(event => {
                const eventDate = new Date(event.startTime);
                const timeString = eventDate.toLocaleTimeString('pt-BR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const dateString = eventDate.toLocaleDateString('pt-BR', { 
                    day: '2-digit', 
                    month: '2-digit' 
                });

                // Determinar status baseado na data
                let status = 'confirmed';
                let statusClass = 'status-confirmed';
                
                if (eventDate < new Date()) {
                    status = 'completed';
                    statusClass = 'status-confirmed';
                } else if (eventDate.toDateString() === new Date().toDateString()) {
                    status = 'today';
                    statusClass = 'status-pending';
                }

                const appointmentItem = document.createElement('div');
                appointmentItem.className = 'appointment-item';
                appointmentItem.innerHTML = `
                    <div class="appointment-time">${timeString}</div>
                    <div class="appointment-details">
                        <div class="appointment-title">${event.title}</div>
                        <div class="appointment-type">${getEventTypeLabel(event.type)} • ${dateString}</div>
                    </div>
                    <div class="appointment-status ${statusClass}"></div>
                `;
                
                appointmentItem.addEventListener('click', () => {
                    editEvent(event);
                });
                
                appointmentsList.appendChild(appointmentItem);
            });
        }

        function getEventTypeLabel(type) {
            const labels = {
                'missa': 'Missa',
                'batizado': 'Batizado',
                'casamento': 'Casamento',
                'comunhao': 'Comunhão',
                'crisma': 'Crisma',
                'funeral': 'Funeral',
                'reuniao': 'Reunião',
                'outro': 'Outro'
            };
            return labels[type] || 'Evento';
        }


        // Carregar opções dos selects (Comunidade, Pastoral, Pilar, Local, Ação)
        async function loadSelectOptions(selectId, endpoint) {
            try {
                const select = document.getElementById(selectId);
                if (!select) return;
                select.innerHTML = '<option value="">Carregando...</option>';
                const { data, error } = await window.api.get(endpoint);
                if (error) throw error;
                const lista = Array.isArray(data) ? data : [];
                const options = ['<option value="">Selecione</option>']
                    .concat(lista.map(item => `<option value="${item.id || item.codigo}">${item.nome || item.titulo || item.descricao || 'Registro'}</option>`));
                select.innerHTML = options.join('');
            } catch (e) {
                const select = document.getElementById(selectId);
                if (select) select.innerHTML = '<option value="">Erro ao carregar</option>';
                console.error('Erro ao carregar select', selectId, e);
            }
        }

        // Carregar opções para um select específico (elemento já existente)
        async function loadSelectOptionsForElement(selectEl, endpoint) {
            try {
                if (!selectEl) return;
                selectEl.innerHTML = '<option value="">Carregando...</option>';
                const { data, error } = await window.api.get(endpoint);
                if (error) throw error;
                const lista = Array.isArray(data) ? data : [];
                const options = ['<option value="">Selecione</option>']
                    .concat(lista.map(item => `<option value="${item.id || item.codigo}">${item.nome || item.titulo || item.descricao || 'Registro'}</option>`));
                selectEl.innerHTML = options.join('');
            } catch (e) {
                if (selectEl) selectEl.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }

        function loadAgendaLookups() {
            console.log('Função removida - modais não disponíveis');
        }


        async function openMultplusModal() {
            console.log('Modal Multplus não está mais disponível');
            alert('Modal de múltiplos agendamentos não está disponível no momento.');
                    return;
            
            // Carregar comunidades no select
            loadMultplusCommunities();
            
            // Carregar locais no select
            loadMultplusLocais();
            
            // Definir data inicial como hoje
            const today = new Date().toISOString().split('T')[0];
            const startDate = document.getElementById('multplusStartDate');
            if (startDate) {
                startDate.value = today;
            }
            
            // Limpar preview
            const preview = document.getElementById('multplusPreview');
            if (preview) {
                preview.innerHTML = `
                    <div class="preview-placeholder">
                        <i class="fas fa-calendar-plus"></i>
                        <p>Configure os parâmetros acima para ver o preview dos eventos</p>
                    </div>
                `;
            }
            
            // Resetar tabs
            currentTab = 'config';
            updateTabDisplay();
        }

        function closeMultplusModal() {
            console.log('Modal Multplus não está mais disponível');
        }

        async function loadMultplusCommunities() {
            try {
                const { data, error } = await window.api.get(window.endpoints.comunidades.list);
                if (error) throw error;
                const lista = Array.isArray(data) ? data : [];
                
                const select = document.getElementById('multplusCommunity');
                if (select) {
                    select.innerHTML = '<option value="">Selecione uma comunidade</option>' +
                        lista.map(comunidade => 
                            `<option value="${comunidade.id}">${comunidade.nome}</option>`
                        ).join('');
                }
            } catch (err) {
                console.error('Erro ao carregar comunidades:', err);
                const select = document.getElementById('multplusCommunity');
                if (select) {
                    select.innerHTML = '<option value="">Erro ao carregar</option>';
                }
            }
        }

        async function loadMultplusLocais() {
            try {
                const { data, error } = await window.api.get(window.endpoints.locais.list);
                if (error) throw error;
                const lista = Array.isArray(data) ? data : [];
                
                const select = document.getElementById('multplusLocation');
                if (select) {
                    select.innerHTML = '<option value="">Selecione um local</option>' +
                        lista.map(local => 
                            `<option value="${local.id}">${local.nome}</option>`
                        ).join('');
                    console.log('✅ Locais carregados no Multplus:', lista.length);
                }
            } catch (err) {
                console.error('Erro ao carregar locais no Multplus:', err);
                const select = document.getElementById('multplusLocation');
                if (select) {
                    select.innerHTML = '<option value="">Erro ao carregar</option>';
                }
            }
        }

        function addTimeItem() {
            const container = document.getElementById('multplusTimesContainer');
            const timeItem = document.createElement('div');
            timeItem.className = 'time-item';
            timeItem.innerHTML = `
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Horário</label>
                        <input type="time" class="form-input multplus-time" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Duração (min)</label>
                        <input type="number" class="form-input multplus-duration" value="60" min="15" step="15">
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn btn-danger btn-sm remove-time" onclick="removeTimeItem(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            container.appendChild(timeItem);
        }

        function removeTimeItem(button) {
            const timeItem = button.closest('.time-item');
            const container = document.getElementById('multplusTimesContainer');
            
            // Não permitir remover se só há um item
            if (container.children.length > 1) {
                timeItem.remove();
            } else {
                showToast('Deve haver pelo menos um horário', 'error');
            }
        }

        function generatePreview() {
            const title = document.getElementById('multplusTitle').value;
            const startDate = document.getElementById('multplusStartDate').value;
            const endDate = document.getElementById('multplusEndDate').value;
            const frequency = document.getElementById('multplusFrequency').value;
            const times = Array.from(document.querySelectorAll('.multplus-time')).map(input => input.value);
            const durations = Array.from(document.querySelectorAll('.multplus-duration')).map(input => input.value);
            
            if (!title || !startDate || !endDate || !frequency || times.some(t => !t)) {
                showToast('Preencha todos os campos obrigatórios', 'error');
                return;
            }
            
            const events = generateEventsList(title, startDate, endDate, frequency, times, durations);
            displayPreview(events);
        }

        function generateEventsList(title, startDate, endDate, frequency, times, durations) {
            const events = [];
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            // Mostrar/ocultar seletor de dias baseado na frequência
            const daysContainer = document.getElementById('multplusDaysContainer');
            if (frequency === 'weekly' || frequency === 'custom') {
                daysContainer.style.display = 'block';
            } else {
                daysContainer.style.display = 'none';
            }
            
            let currentDate = new Date(start);
            
            while (currentDate <= end) {
                let shouldAddEvent = false;
                
                switch (frequency) {
                    case 'daily':
                        shouldAddEvent = true;
                        break;
                    case 'weekly':
                        const selectedDays = Array.from(document.querySelectorAll('input[name="multplusDays"]:checked'))
                            .map(cb => parseInt(cb.value));
                        shouldAddEvent = selectedDays.includes(currentDate.getDay());
                        break;
                    case 'monthly':
                        shouldAddEvent = currentDate.getDate() === start.getDate();
                        break;
                    case 'custom':
                        const customDays = Array.from(document.querySelectorAll('input[name="multplusDays"]:checked'))
                            .map(cb => parseInt(cb.value));
                        shouldAddEvent = customDays.includes(currentDate.getDay());
                        break;
                }
                
                if (shouldAddEvent) {
                    times.forEach((time, index) => {
                        const event = {
                            title: title,
                            date: currentDate.toISOString().split('T')[0],
                            time: time,
                            duration: durations[index] || '60',
                            type: document.getElementById('multplusType').value,
                            location: document.getElementById('multplusLocation').value,
                            description: document.getElementById('multplusDescription').value
                        };
                        events.push(event);
                    });
                }
                
                // Avançar para próxima data baseado na frequência
                switch (frequency) {
                    case 'daily':
                        currentDate.setDate(currentDate.getDate() + 1);
                        break;
                    case 'weekly':
                        currentDate.setDate(currentDate.getDate() + 7);
                        break;
                    case 'monthly':
                        currentDate.setMonth(currentDate.getMonth() + 1);
                        break;
                    case 'custom':
                        currentDate.setDate(currentDate.getDate() + 1);
                        break;
                }
            }
            
            return events;
        }

        function displayPreview(events) {
            const preview = document.getElementById('multplusPreview');
            
            if (events.length === 0) {
                preview.innerHTML = `
                    <div class="preview-placeholder">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Nenhum evento será criado com os parâmetros atuais</p>
                    </div>
                `;
                return;
            }
            
            const eventsHTML = events.map(event => `
                <div class="preview-event">
                    <div class="preview-event-info">
                        <div class="preview-event-title">${event.title}</div>
                        <div class="preview-event-details">
                            ${event.time} - ${event.duration}min | ${event.location || 'Sem local'}
                        </div>
                    </div>
                    <div class="preview-event-date">
                        ${new Date(event.date).toLocaleDateString('pt-BR')}
                    </div>
                </div>
            `).join('');
            
            preview.innerHTML = `
                <div style="margin-bottom: 15px; font-weight: 600; color: #1e3a8a;">
                    <i class="fas fa-calendar-check"></i>
                    ${events.length} evento(s) serão criados
                </div>
                ${eventsHTML}
            `;
        }

        // Event listeners para o modal Multplus
        document.addEventListener('DOMContentLoaded', function() {
            // Frequência change
            const multplusFrequency = document.getElementById('multplusFrequency');
            if (multplusFrequency) {
                multplusFrequency.addEventListener('change', function() {
                    const daysContainer = document.getElementById('multplusDaysContainer');
                    if (this.value === 'weekly' || this.value === 'custom') {
                        daysContainer.style.display = 'block';
                    } else {
                        daysContainer.style.display = 'none';
                    }
                });
            }
            
            // Form submit
            const multplusForm = document.getElementById('multplusForm');
            if (multplusForm) {
                multplusForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await handleMultplusSubmit();
                });
            }
        });

        // Função para verificar se os modais estão carregados - Removida (modal não disponível)
        function areModalsLoaded() {
            return false; // Modal não disponível
        }

        // Função para aguardar o carregamento dos modais
        async function waitForModals(maxAttempts = 10) {
            for (let i = 0; i < maxAttempts; i++) {
                if (areModalsLoaded()) {
                    console.log('Modais carregados com sucesso');
                    return true;
                }
                console.log(`Aguardando modais... tentativa ${i + 1}/${maxAttempts}`);
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            return false;
        }

        // Variáveis dos modais removidas - modal não disponível
        let currentTab = 'config';

        // Funções do Modal de Evento removidas - modal não disponível

        // Funções do Modal Multplus (Tabs)
        function nextTab() {
            if (validateCurrentTab()) {
                const tabs = ['config', 'schedule', 'preview'];
                const currentIndex = tabs.indexOf(currentTab);
                if (currentIndex < tabs.length - 1) {
                    currentTab = tabs[currentIndex + 1];
                    updateTabDisplay();
                }
            }
        }

        function prevTab() {
            const tabs = ['config', 'schedule', 'preview'];
            const currentIndex = tabs.indexOf(currentTab);
            if (currentIndex > 0) {
                currentTab = tabs[currentIndex - 1];
                updateTabDisplay();
            }
        }

        function updateTabDisplay() {
            // Atualizar tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${currentTab}"]`).classList.add('active');

            // Mostrar/ocultar panes
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.querySelector(`[data-tab="${currentTab}"]`).classList.add('active');

            // Atualizar botões
            const prevBtn = document.getElementById('prevTabBtn');
            const nextBtn = document.getElementById('nextTabBtn');
            const submitBtn = document.getElementById('multplusSubmitBtn');

            prevBtn.style.display = currentTab !== 'config' ? 'flex' : 'none';
            nextBtn.style.display = currentTab !== 'preview' ? 'flex' : 'none';
            submitBtn.style.display = currentTab === 'preview' ? 'flex' : 'none';
        }

        function validateCurrentTab() {
            const currentTabElement = document.querySelector(`[data-tab="${currentTab}"]`);
            const requiredInputs = currentTabElement.querySelectorAll('input[required], select[required]');
            
            let isValid = true;
            requiredInputs.forEach(input => {
                if (!input.value.trim()) {
                    isValid = false;
                    showInputError(input, 'Este campo é obrigatório');
                } else {
                    clearInputError(input);
                }
            });

            return isValid;
        }

        // Funções de validação removidas - modal não disponível

        // Event listeners para tabs
        document.addEventListener('DOMContentLoaded', function() {
            // Tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tab = this.getAttribute('data-tab');
                    currentTab = tab;
                    updateTabDisplay();
                });
            });

            // Step buttons
            document.querySelectorAll('.step').forEach(step => {
                step.addEventListener('click', function() {
                    const stepNumber = parseInt(this.getAttribute('data-step'));
                    if (stepNumber <= currentStep || validateCurrentStep()) {
                        currentStep = stepNumber;
                        updateStepDisplay();
                    }
                });
            });

            // Duration change
            const eventDuration = document.getElementById('eventDuration');
            if (eventDuration) {
                eventDuration.addEventListener('change', function() {
                    const customGroup = document.getElementById('customDurationGroup');
                    if (this.value === 'custom') {
                        customGroup.style.display = 'block';
                    } else {
                        customGroup.style.display = 'none';
                    }
                });
            }
        });

        async function handleMultplusSubmit() {
            const title = document.getElementById('multplusTitle').value;
            const startDate = document.getElementById('multplusStartDate').value;
            const endDate = document.getElementById('multplusEndDate').value;
            const frequency = document.getElementById('multplusFrequency').value;
            const times = Array.from(document.querySelectorAll('.multplus-time')).map(input => input.value);
            const durations = Array.from(document.querySelectorAll('.multplus-duration')).map(input => input.value);
            
            const events = generateEventsList(title, startDate, endDate, frequency, times, durations);
            
            if (events.length === 0) {
                showToast('Nenhum evento para criar', 'error');
                return;
            }
            
            try {
                const btn = document.querySelector('#multplusForm button[type="submit"]');
                const original = btn ? btn.innerHTML : '';
                if (btn) { 
                    btn.disabled = true; 
                    btn.innerHTML = '<span style="width:14px;height:14px;border:2px solid rgba(255,255,255,.4);border-top-color:#fff;border-radius:50%;display:inline-block;animation:spin .9s linear infinite"></span>&nbsp;&nbsp;Criando eventos...'; 
                }
                
                // Criar eventos em lote
                const promises = events.map(event => {
                    const formData = new FormData();
                    formData.append('titulo', event.title);
                    formData.append('tipo', event.type);
                    formData.append('data', event.date);
                    formData.append('hora', event.time);
                    formData.append('duracao', event.duration);
                    formData.append('local', event.location || '');
                    formData.append('descricao', event.description || '');
                    formData.append('comunidade_id', document.getElementById('multplusCommunity').value);
                    
                    return window.api.post(window.endpoints.agenda.create, formData);
                });
                
                const results = await Promise.all(promises);
                const errors = results.filter(r => r.error);
                
                if (errors.length > 0) {
                    throw new Error(`${errors.length} eventos falharam ao ser criados`);
                }
                
                showToast(`${events.length} eventos criados com sucesso!`, 'success');
                closeMultplusModal();
                
                // Recarregar eventos
                await loadEventsFromApi();
                filterEventsByCommunity();
                
            } catch (err) {
                console.error('Erro ao criar eventos:', err);
                showToast('Erro ao criar eventos: ' + err.message, 'error');
            } finally {
                const btn = document.querySelector('#multplusForm button[type="submit"]');
                if (btn) { 
                    btn.disabled = false; 
                    btn.innerHTML = '<i class="fas fa-save"></i> Criar Eventos'; 
                }
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff'};
                color: white;
                padding: 15px 20px;
                border-radius: 6px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        function goToToday() {
            currentDate = new Date();
            currentView = 'dia';
            renderCalendar();
            updateCurrentWeekRange();
        }

        function updateDailyCalendar() {
            const calendarBody = document.getElementById('calendarBody');
            calendarBody.innerHTML = '';

            // Cabeçalho do dia (igual ao estilo da semana)
            const header = document.querySelector('.calendar-header');
            if (header) {
                const dayNames = ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado'];
                const dayName = dayNames[currentDate.getDay()];
                const dayNumber = currentDate.getDate();
                const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                const monthName = monthNames[currentDate.getMonth()];
                const year = currentDate.getFullYear();
                
                header.innerHTML = `
                    <div class="time-column-header">Hora</div>
                    <div class="day-header today" style="grid-column: span 1;">
                        <div class="day-name">${dayName}</div>
                        <div class="day-number">${dayNumber}</div>
                        <div class="day-month">${monthName} ${year}</div>
                    </div>
                `;
            }

            // Gerar horários (06:00 - 22:00) - estilo Google Calendar
            for (let hour = 6; hour <= 22; hour++) {
                // Coluna de hora (primeira coluna) - igual ao estilo da semana
                const timeSlot = document.createElement('div');
                timeSlot.className = 'time-slot';
                timeSlot.textContent = `${hour.toString().padStart(2, '0')}:00`;
                calendarBody.appendChild(timeSlot);

                // Coluna do dia (segunda coluna) - igual ao estilo da semana
                const daySlot = document.createElement('div');
                daySlot.className = 'day-slot';
                
                // Adicionar eventos para este horário - igual ao estilo da semana
                const hourEvents = getEventsForHour(currentDate, hour);
                hourEvents.forEach(event => {
                    const eventElement = document.createElement('div');
                    eventElement.className = 'event-item';
                    eventElement.textContent = event.title || 'Evento';
                    eventElement.title = `${event.title || 'Evento'}\n${event.time || ''}\n${event.location || ''}`;
                    eventElement.addEventListener('click', (e) => {
                        e.stopPropagation();
                        editEvent(event);
                    });
                    daySlot.appendChild(eventElement);
                });

                // Adicionar click para criar evento
                daySlot.addEventListener('click', (e) => {
                    if (e.target === daySlot) {
                        console.log('Modal de novo agendamento não está disponível');
                    }
                });

                calendarBody.appendChild(daySlot);
            }
        }

        // Adicionar estilos de animação
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
