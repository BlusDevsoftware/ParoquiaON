<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda - ParoquiaON</title>
    <link rel="icon" type="image/png" href="assets/images/logo2.png">
    <link rel="stylesheet" href="styles/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Reset e configurações básicas */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            overflow-x: hidden;
        }

        /* Layout principal */
        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* Barra superior ocupando toda a largura */
        .top-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: #1e3a8a;
            color: white;
            padding: 0 30px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Sidebar esquerda */
        .left-sidebar {
            width: 300px;
            background: #f8f9fa;
            border-right: none;
            display: flex;
            flex-direction: column;
            position: fixed;
            left: 0;
            top: 80px;
            height: calc(100vh - 80px);
            z-index: 100;
            padding: 0;
            overflow-y: auto;
        }

        /* Container lateral para o calendário */
        .sidebar-content {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 0;
        }


        /* Botão Criar */
        .create-button {
            margin: 20px 20px 15px 20px;
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(25, 118, 210, 0.25);
            position: relative;
            z-index: 10;
            width: calc(100% - 40px);
        }

        .create-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(25, 118, 210, 0.35);
        }

        /* Container lateral do calendário */
        .calendar-sidebar-container {
            margin: 20px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #f0f0f0;
            position: relative;
            z-index: 10;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .calendar-sidebar-header {
            background: white;
            color: #333;
            padding: 20px 15px 15px 15px;
            text-align: center;
            font-weight: 600;
            font-size: 16px;
            border-bottom: none;
        }

        /* Mini calendário */
        .mini-calendar {
            margin: 0;
            background: white;
            border-radius: 0;
            overflow: hidden;
            box-shadow: none;
            border: none;
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
            max-height: 280px;
        }

        .mini-calendar-header {
            background: white;
            color: #333;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: none;
            font-weight: 500;
        }

        .mini-calendar-title {
            font-weight: 500;
            font-size: 14px;
            color: #333;
        }

        .mini-calendar-nav {
            display: flex;
            gap: 8px;
        }

        .mini-nav-btn {
            background: transparent;
            border: none;
            color: #333;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 500;
            transition: background 0.2s ease;
        }

        .mini-nav-btn:hover {
            background: #f8f9fa;
        }

        .mini-calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: white;
            border-bottom: none;
        }

        .mini-weekday {
            padding: 6px 4px;
            text-align: center;
            font-size: 11px;
            font-weight: 500;
            color: #333;
        }

        .mini-calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0;
            background: white;
            flex: 0 0 auto;
            min-height: 0;
        }

        .mini-day {
            background: white;
            padding: 6px 4px;
            text-align: center;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            font-weight: 400;
        }

        .mini-day:hover {
            background: #f8f9fa;
        }

        .mini-day.selected {
            background: #007bff;
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mini-day.has-events {
            background: white;
            position: relative;
        }

        .mini-day.has-events::after {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 3px;
            height: 3px;
            background: #007bff;
            border-radius: 50%;
        }

        .mini-day.other-month {
            color: #999;
        }

        /* Seção de Últimos Agendamentos */
        .recent-appointments {
            margin: 20px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #f0f0f0;
            flex: 0 0 auto;
        }

        .recent-appointments-header {
            background: white;
            color: #333;
            padding: 15px 20px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            border-bottom: 1px solid #f0f0f0;
        }

        .appointments-list {
            padding: 0;
            margin: 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .appointment-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f8f9fa;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s ease;
        }

        .appointment-item:last-child {
            border-bottom: none;
        }

        .appointment-item:hover {
            background: #f8f9fa;
        }

        .appointment-time {
            background: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            min-width: 50px;
            text-align: center;
        }

        .appointment-details {
            flex: 1;
        }

        .appointment-title {
            font-size: 12px;
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .appointment-type {
            font-size: 10px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .appointment-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .status-confirmed {
            background: #28a745;
        }

        .status-pending {
            background: #ffc107;
        }

        .status-cancelled {
            background: #dc3545;
        }


        /* Área principal */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
            margin-top: 80px; /* Compensar altura da barra fixa */
            margin-left: 300px;
            width: calc(100vw - 300px);
            min-height: calc(100vh - 80px);
        }


        .header-left {
            display: flex;
            align-items: center;
            gap: 60px;
            flex: 1;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }


        .nav-links {
            display: flex;
            gap: 30px;
            justify-content: center;
            flex: 1;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 12px 0;
            position: relative;
            transition: opacity 0.2s ease;
            font-size: 16px;
        }

        .nav-link:hover {
            opacity: 0.8;
        }

        .nav-link.active {
            opacity: 1;
        }

        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            right: 0;
            height: 3px;
            background: #4caf50;
            border-radius: 2px;
        }

        /* Dropdown styles */
        .nav-dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-trigger {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .dropdown-trigger i {
            font-size: 12px;
            transition: transform 0.2s ease;
        }

        .nav-dropdown:hover .dropdown-trigger i {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 180px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            z-index: 1000;
            border: 1px solid #e0e0e0;
        }

        .nav-dropdown:hover .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            display: block;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s ease;
            border-bottom: 1px solid #f0f0f0;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: #f8f9fa;
            color: #1976d2;
        }

        .beta-tag {
            background: #ff9800;
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
            text-transform: uppercase;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-shrink: 0;
        }

        .header-icon {
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s ease;
            position: relative;
            font-size: 16px;
        }

        .header-icon:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #f44336;
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .user-avatar {
            width: 44px;
            height: 44px;
            background: #4caf50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
        }

        /* Área de conteúdo principal */
        .content-area {
            flex: 1;
            padding: 0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            background: transparent;
        }


        /* Container de informações acima do calendário */
        .calendar-info-container {
            background: white;
            border-radius: 12px;
            padding: 25px 30px;
            margin: 20px 20px 15px 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 25px;
            border: 1px solid #f0f0f0;
            min-height: 80px;
            position: relative;
            z-index: 10;
        }

        .info-left {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .info-location {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-location-label {
            font-size: 13px;
            color: #666;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .info-location-name {
            font-size: 18px;
            color: #333;
            font-weight: 700;
        }

        .info-agenda {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .info-agenda-label {
            font-size: 15px;
            color: #333;
            font-weight: 600;
        }

        .info-agenda-avatar {
            width: 36px;
            height: 36px;
            background: #1976d2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        .info-agenda-name {
            font-size: 15px;
            color: #333;
            font-weight: 600;
        }

        .info-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .info-date {
            font-size: 18px;
            color: #333;
            font-weight: 700;
            text-align: center;
            background: #f8f9fa;
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .info-today-btn {
            background: #1976d2;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
            font-size: 15px;
            box-shadow: 0 2px 4px rgba(25, 118, 210, 0.3);
        }

        .info-today-btn:hover {
            background: #1565c0;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(25, 118, 210, 0.4);
        }

        .info-online-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            color: #666;
            font-weight: 500;
        }

        .info-view-selector {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            min-width: 110px;
            font-size: 15px;
            transition: all 0.2s ease;
        }

        .info-view-selector:hover {
            border-color: #1976d2;
            background: #f8f9fa;
        }

        /* Calendário semanal */
        .weekly-calendar {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            flex: 1;
            display: flex;
            flex-direction: column;
            margin: 0 20px 20px 20px;
            border: 1px solid #f0f0f0;
            position: relative;
            z-index: 5;
            max-height: calc(100vh - 200px);
        }

        .calendar-header {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }

        .time-column-header {
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
            color: #666;
            border-right: 1px solid #e0e0e0;
        }

        .day-header {
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
            color: #333;
            border-right: 1px solid #e0e0e0;
            position: relative;
        }

        .day-header:last-child {
            border-right: none;
        }

        .day-header.today {
            background: #e3f2fd;
            color: #1976d2;
        }

        .day-header.today::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #1976d2;
        }

        .day-name {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .day-number {
            font-size: 18px;
            font-weight: bold;
        }

        .calendar-body {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            max-height: calc(100vh - 300px);
        }

        /* Estilização do scroll */
        .calendar-body::-webkit-scrollbar {
            width: 8px;
        }

        .calendar-body::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .calendar-body::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .calendar-body::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .time-column {
            border-right: 1px solid #e0e0e0;
        }

        .time-slot {
            height: 60px;
            padding: 8px;
            text-align: center;
            font-size: 12px;
            color: #666;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .day-column {
            border-right: 1px solid #e0e0e0;
            position: relative;
        }

        .day-column:last-child {
            border-right: none;
        }

        .day-column.today {
            background: #f8f9ff;
        }

        .day-slot {
            height: 60px;
            border-bottom: 1px solid #f0f0f0;
            position: relative;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .day-slot:hover {
            background: #f0f8ff;
        }

        .day-slot.today {
            background: #e3f2fd;
        }

        /* Eventos */
        .event-block {
            position: absolute;
            left: 2px;
            right: 2px;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 500;
            color: white;
            cursor: pointer;
            z-index: 10;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }

        .event-block:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        /* Cores dos eventos */
        .event-missa {
            background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
        }

        .event-batizado {
            background: linear-gradient(135deg, #2196f3 0%, #42a5f5 100%);
        }

        .event-casamento {
            background: linear-gradient(135deg, #e91e63 0%, #f06292 100%);
        }

        .event-comunhao {
            background: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%);
        }

        .event-crisma {
            background: linear-gradient(135deg, #9c27b0 0%, #ba68c8 100%);
        }

        .event-funeral {
            background: linear-gradient(135deg, #607d8b 0%, #90a4ae 100%);
        }

        .event-reuniao {
            background: linear-gradient(135deg, #795548 0%, #a1887f 100%);
        }

        .event-outro {
            background: linear-gradient(135deg, #1976d2 0%, #42a5f5 100%);
        }

        /* Status dos eventos */
        .event-confirmado {
            border-left: 4px solid #4caf50;
        }

        .event-pendente {
            border-left: 4px solid #ff9800;
        }

        .event-cancelado {
            border-left: 4px solid #f44336;
            opacity: 0.7;
        }

        /* Modal de evento */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(6px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 840px;
            width: 96%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.25);
            border: 1px solid #f0f0f0;
        }
        .modal-body {
            overflow-y: auto;
            max-height: calc(90vh - 120px);
            padding-right: 6px; /* evita sobrepor borda arredondada */
        }

        /* Layout refinado do formulário */
        .form-section {
            margin-bottom: 18px;
        }
        .section-title {
            font-size: 14px;
            font-weight: 700;
            color: #374151;
            margin: 8px 0 12px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .section-title i {
            color: #1976d2;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .form-grid .form-group { margin-bottom: 0; }
        @media (max-width: 600px) {
            .form-grid { grid-template-columns: 1fr; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 5px;
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .close-btn:hover {
            background: #f5f5f5;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #1976d2;
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(25, 118, 210, 0.4);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #e0e0e0;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        /* Responsivo */
        @media (max-width: 1200px) {
            .left-sidebar {
                width: 250px;
            }
            
            .main-area {
                width: calc(100vw - 250px);
                margin-left: 250px;
            }
            
            .nav-links {
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .left-sidebar {
                display: none;
            }
            
            .main-area {
                margin-left: 0;
                width: 100vw;
            }
            
            .top-header {
                padding: 0 15px;
                height: 70px;
            }
            
            .main-area {
                margin-top: 70px;
            }
            
            .nav-links {
                display: none;
            }
            
            .nav-dropdown .dropdown-menu {
                position: static;
                opacity: 1;
                visibility: visible;
                transform: none;
                box-shadow: none;
                border: none;
                background: transparent;
            }
            
            .header-left {
                gap: 30px;
            }
            
            .content-area {
                padding: 0;
            }


            .calendar-info-container {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
                padding: 15px 20px;
            }

            .info-left {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .info-right {
                flex-wrap: wrap;
                gap: 10px;
            }

            .calendar-body {
                min-height: 400px;
            }

            .time-slot, .day-slot {
                height: 40px;
            }
        }

        @media (max-width: 480px) {
            .left-sidebar {
                flex-direction: column;
                height: auto;
                margin-top: 70px;
            }
            
            .calendar-sidebar-container {
                margin: 10px;
                min-width: 200px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }
            
            .content-header {
                margin-bottom: 20px;
            }
            
            .calendar-header {
                font-size: 12px;
            }

            .day-header {
                padding: 10px 5px;
            }
            
            .day-number {
                font-size: 14px;
            }

            .time-slot, .day-slot {
                height: 30px;
                font-size: 10px;
            }

            .event-block {
                font-size: 9px;
                padding: 2px 4px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Esquerda -->
        <div class="left-sidebar">
            <div class="sidebar-content">
                <!-- Container Lateral do Calendário -->
                <div class="calendar-sidebar-container">
                    <!-- Botão Criar -->
                    <button class="create-button" onclick="openEventModal()">
                        <i class="fas fa-plus"></i>
                        Criar
                    </button>

                    <div class="calendar-sidebar-header">
                        <i class="fas fa-calendar-alt"></i> Calendário
                    </div>
                    
                    <!-- Mini Calendário -->
                    <div class="mini-calendar">
                        <div class="mini-calendar-header">
                            <div class="mini-calendar-title" id="miniCalendarTitle">Agosto 2024</div>
                            <div class="mini-calendar-nav">
                                <button class="mini-nav-btn" onclick="navigateMiniCalendar(-1)">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button class="mini-nav-btn" onclick="navigateMiniCalendar(1)">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mini-calendar-weekdays">
                            <div class="mini-weekday">D</div>
                            <div class="mini-weekday">S</div>
                            <div class="mini-weekday">T</div>
                            <div class="mini-weekday">Q</div>
                            <div class="mini-weekday">Q</div>
                            <div class="mini-weekday">S</div>
                            <div class="mini-weekday">S</div>
                        </div>
                        <div class="mini-calendar-days" id="miniCalendarDays">
                            <!-- Dias serão inseridos via JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Seção de Últimos Agendamentos -->
                    <div class="recent-appointments">
                        <div class="recent-appointments-header">
                            <i class="fas fa-clock"></i> Últimos Agendamentos
                        </div>
                        <div class="appointments-list" id="recentAppointmentsList">
                            <!-- Agendamentos serão inseridos via JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Espaço em branco para não ocupar todo o container -->
                    <div style="flex: 1;"></div>
                </div>
            </div>
        </div>

        <!-- Área Principal -->
        <div class="main-area">
            <!-- Header Superior -->
            <div class="top-header">
                <div class="header-left">
                    <div class="logo-section">
                        <span style="font-size: 20px; font-weight: 600;">ParoquiaON</span>
        </div>
                    <div class="nav-links">
                        <a href="index.html" class="nav-link">Minha Comunidade</a>
                        <a href="agenda.html" class="nav-link active">Agenda</a>
                        <a href="comunidades.html" class="nav-link">Comunidades</a>
                        <a href="pastorais.html" class="nav-link">Pastorais</a>
                        <a href="pilares.html" class="nav-link">Pilares</a>
                        <a href="locais.html" class="nav-link">Locais</a>
                        <a href="acoes.html" class="nav-link">Ações</a>
                        <a href="pessoas.html" class="nav-link">Pessoas</a>
                        <a href="usuarios.html" class="nav-link">Usuários</a>
                        <a href="perfil.html" class="nav-link">Perfil</a>
                        <div class="nav-dropdown">
                            <a href="#" class="nav-link dropdown-trigger">Relatórios <i class="fas fa-chevron-down"></i></a>
                            <div class="dropdown-menu">
                                <a href="recebimento.html" class="dropdown-item">Recebimento</a>
                                <a href="conferencia.html" class="dropdown-item">Conferência</a>
                                <a href="dinamico.html" class="dropdown-item">Dinâmico <span class="beta-tag">beta</span></a>
                            </div>
                        </div>
    </div>
            </div>
                <div class="header-right">
                    <div class="header-icon">
                    <i class="fas fa-bell"></i>
                        <span class="notification-badge">3</span>
                    </div>
                <div class="user-avatar">A</div>
            </div>
        </div>

            <!-- Área de Conteúdo -->
            <div class="content-area">
                <!-- Container de Informações -->
                <div class="calendar-info-container">
                    <div class="info-left">
                        <div class="info-location">
                            <div class="info-location-label">Você está em:</div>
                            <div class="info-location-name">Paróquia São João Batista</div>
                        </div>
                        <div class="info-agenda">
                            <div class="info-agenda-label">Agenda:</div>
                            <div class="info-agenda-name">Padre João Silva - Pároco</div>
                        </div>
                    </div>
                    <div class="info-right">
                        <div class="info-date">12 - 18 outubro de 2025</div>
                        <button class="info-today-btn" onclick="goToToday()">Hoje</button>
                        <div class="info-online-toggle">
                            <span>Exibir horário online</span>
                            <div class="toggle-switch" id="infoOnlineToggle"></div>
                        </div>
                        <div class="info-view-selector">
                            <span>Semana</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>
                </div>

                <!-- Calendário Semanal -->
                <div class="weekly-calendar">
                    <div class="calendar-header">
                        <div class="time-column-header">Hora</div>
                        <div class="day-header" id="day0">
                            <div class="day-name">SEG</div>
                            <div class="day-number">24</div>
                    </div>
                        <div class="day-header" id="day1">
                            <div class="day-name">TER</div>
                            <div class="day-number">25</div>
                    </div>
                        <div class="day-header today" id="day2">
                            <div class="day-name">QUA</div>
                            <div class="day-number">26</div>
                </div>
                        <div class="day-header" id="day3">
                            <div class="day-name">QUI</div>
                            <div class="day-number">27</div>
                    </div>
                        <div class="day-header" id="day4">
                            <div class="day-name">SEX</div>
                            <div class="day-number">28</div>
                    </div>
                        <div class="day-header" id="day5">
                            <div class="day-name">SAB</div>
                            <div class="day-number">29</div>
                </div>
                        <div class="day-header" id="day6">
                            <div class="day-name">DOM</div>
                            <div class="day-number">30</div>
                    </div>
                </div>
                    <div class="calendar-body" id="calendarBody">
                        <!-- Horários e eventos serão inseridos via JavaScript -->
        </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Evento -->
    <div class="modal" id="eventModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Novo Agendamento</h2>
                <button class="close-btn" onclick="closeEventModal()">&times;</button>
            </div>
            <div class="modal-body">
            <form id="eventForm">
                <!-- Seção: Título do evento -->
                <div class="form-section">
                    <div class="section-title"><i class="fas fa-heading"></i> Título do evento</div>
                    <div class="form-grid">
                        <div class="form-group" style="grid-column: 1 / -1;">
                    <label class="form-label" for="eventTitle">Título do Evento</label>
                    <input type="text" id="eventTitle" class="form-input" required>
                </div>
                </div>
                </div>
                
                <!-- Seção: Vínculos -->
                <div class="form-section">
                    <div class="section-title"><i class="fas fa-link"></i> Vínculos</div>
                    <div id="comunidadesContainer" class="form-grid" style="grid-column: 1 / -1;">
                        <div class="form-group" data-placeholder="comunidades" style="grid-column: 1 / -1; color:#6b7280; font-size:13px;">
                            Nenhuma comunidade vinculada ainda.
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1; display:flex; justify-content:flex-end;">
                            <button type="button" id="addComunidadeBtn" class="btn btn-secondary"><i class="fas fa-plus"></i> Adicionar comunidade</button>
                        </div>
                    </div>
                </div>
                
                <!-- Seção: Horários -->
                <div class="form-section">
                    <div class="section-title"><i class="fas fa-clock"></i> Horários</div>
                    <div id="horariosContainer" class="form-grid" style="grid-column: 1 / -1;">
                        <div class="form-group" data-placeholder="horarios" style="grid-column: 1 / -1; color:#6b7280; font-size:13px;">
                            Nenhum horário adicionado ainda.
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1; display:flex; justify-content:flex-end;">
                            <button type="button" id="addHorarioBtn" class="btn btn-secondary"><i class="fas fa-plus"></i> Adicionar horário</button>
                </div>
                
                    </div>
                </div>
                
                <!-- Seção: Detalhes -->
                <div class="form-section">
                    <div class="section-title"><i class="fas fa-align-left"></i> Detalhes</div>
                    <div class="form-grid">
                        <div class="form-group" style="grid-column: 1 / -1;">
                    <label class="form-label" for="eventDescription">Descrição</label>
                    <textarea id="eventDescription" class="form-input form-textarea" placeholder="Detalhes do evento..."></textarea>
                </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label class="form-label" for="eventObjetivo">Objetivo</label>
                            <textarea id="eventObjetivo" class="form-input form-textarea" placeholder="Qual o objetivo deste evento?"></textarea>
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1; display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap;">
                            <div>
                                <label class="form-label" style="display:block;">Status</label>
                                <div id="eventStatusGroup" class="status-group" role="group" aria-label="Status do evento" style="display:flex; gap:8px; flex-wrap:wrap;">
                                    <button type="button" class="btn status-btn" data-status="confirmado" style="background:#1e3a8a; color:#fff;">Confirmado</button>
                                    <button type="button" class="btn status-btn" data-status="pendente" style="background:#f59e0b; color:#fff;">Pendente</button>
                                    <button type="button" class="btn status-btn" data-status="cancelado" style="background:#dc2626; color:#fff;">Cancelado</button>
                                </div>
                                <input type="hidden" id="eventStatus" value="confirmado">
                            </div>
                            
                        </div>
                        <div class="form-group" style="display:flex; align-items:center; gap:12px; grid-column: 1 / -1;">
                            <label class="form-label" style="margin:0;">Evento Paroquial?</label>
                            <input type="checkbox" id="eventParoquial" style="width:18px; height:18px;">
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label class="form-label" for="eventAnexo">Anexo (PDF/Imagem)</label>
                            <input type="file" id="eventAnexo" class="form-input" accept="application/pdf,image/*">
                        </div>
                        
                    </div>
                </div>
                
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" onclick="closeEventModal()">Cancelar</button>
                    <button type="submit" id="eventSubmitBtn" class="btn btn-primary">Salvar Evento</button>
                </div>
            </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="scripts/auth-guard.js"></script>
    <script src="scripts/apply-auth-protection.js"></script>
    <script src="scripts/navigation.js"></script>
    
    <script>
        // Variáveis globais
        let currentDate = new Date();
        let events = [];
        let editingEvent = null;
        let miniCalendarDate = new Date();

        // Inicializar aplicação
        document.addEventListener('DOMContentLoaded', async function() {
            initializeApp();
            await loadEventsFromApi();
            await loadAgendaLookups();
            setupEventListeners();
        });

        function initializeApp() {
            updateMiniCalendar();
            updateWeeklyCalendar();
            updateCurrentWeekRange();
            updateRecentAppointments();
        }

        function setupEventListeners() {
            // Toggle online do container de informações
            document.getElementById('infoOnlineToggle').addEventListener('click', function() {
                this.classList.toggle('active');
            });

            // Formulário de evento
            document.getElementById('eventForm').addEventListener('submit', handleEventSubmit);

            // Adicionar mais comunidade
            const addComunidadeBtn = document.getElementById('addComunidadeBtn');
            if (addComunidadeBtn) {
                addComunidadeBtn.addEventListener('click', async function() {
                    const container = document.getElementById('comunidadesContainer');
                    if (!container) return;
                    const placeholder = container.querySelector('[data-placeholder="comunidades"]');
                    if (placeholder) placeholder.remove();
                    const wrapper = document.createElement('div');
                    wrapper.className = 'form-group';
                    wrapper.setAttribute('data-comunidade-row', '');
                    wrapper.innerHTML = `
                        <label class="form-label">Comunidade</label>
                        <select class="form-input comunidade-select"><option value="">Carregando...</option></select>
                    `;
                    container.insertBefore(wrapper, addComunidadeBtn.parentElement);
                    // Popular select
                    await loadSelectOptionsForElement(wrapper.querySelector('select'), window.endpoints.comunidades.list);
                });
            }

            // Adicionar horário extra
            const addHorarioBtn = document.getElementById('addHorarioBtn');
            if (addHorarioBtn) {
                addHorarioBtn.addEventListener('click', function() {
                    const container = document.getElementById('horariosContainer');
                    if (!container) return;
                    const placeholder = container.querySelector('[data-placeholder="horarios"]');
                    if (placeholder) placeholder.remove();
                    const row = document.createElement('div');
                    row.className = 'form-grid';
                    row.innerHTML = `
                        <div class="form-group" data-schedule-row>
                            <label class="form-label">Data</label>
                            <input type="date" class="form-input" required>
                        </div>
                        <div class="form-group" data-schedule-row>
                            <label class="form-label">Horário</label>
                            <input type="time" class="form-input" required>
                        </div>
                        <div class="form-group" data-schedule-row>
                            <label class="form-label">Duração (minutos)</label>
                            <input type="number" class="form-input" value="60" min="15" max="480">
                        </div>
                        <div class="form-group" data-schedule-row>
                            <label class="form-label">Recorrência</label>
                            <select class="form-input recurrence-select">
                                <option value="nenhuma">Nenhuma</option>
                                <option value="semanal">Semanal</option>
                                <option value="mensal">Mensal</option>
                                <option value="anual">Anual</option>
                            </select>
                        </div>
                    `;
                    container.insertBefore(row, addHorarioBtn.parentElement);
                });
            }

            // Fechar modal ao clicar fora
            document.getElementById('eventModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeEventModal();
                }
            });

            // Presets de duração
            const durationButtons = document.querySelectorAll('[data-duration]');
            durationButtons.forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const minutes = parseInt(btn.getAttribute('data-duration'));
                    const input = document.getElementById('eventDuration');
                    if (input && !Number.isNaN(minutes)) input.value = String(minutes);
                });
            });

            // Status buttons (toggle selection)
            const statusBtns = document.querySelectorAll('.status-btn');
            statusBtns.forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const status = btn.getAttribute('data-status');
                    document.getElementById('eventStatus').value = status;
                    statusBtns.forEach(b => b.style.outline = 'none');
                    // Visual selection by border
                    statusBtns.forEach(b => b.style.boxShadow = 'none');
                    btn.style.boxShadow = '0 0 0 2px rgba(0,0,0,0.15) inset';
                });
            });
        }

        function updateMiniCalendar() {
            const title = document.getElementById('miniCalendarTitle');
            const daysContainer = document.getElementById('miniCalendarDays');
            
            title.textContent = miniCalendarDate.toLocaleDateString('pt-BR', { 
                month: 'long', 
                year: 'numeric' 
            });

            daysContainer.innerHTML = '';

            const year = miniCalendarDate.getFullYear();
            const month = miniCalendarDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'mini-day';
                
                if (date.getMonth() !== month) {
                    dayElement.classList.add('other-month');
                }
                
                if (isToday(date)) {
                    dayElement.classList.add('selected');
                }
                
                if (hasEventsOnDate(date)) {
                    dayElement.classList.add('has-events');
                }
                
                dayElement.textContent = date.getDate();
                dayElement.addEventListener('click', () => {
                    currentDate = new Date(date);
                    updateWeeklyCalendar();
                });
                
                daysContainer.appendChild(dayElement);
            }
        }

        function navigateMiniCalendar(direction) {
            miniCalendarDate.setMonth(miniCalendarDate.getMonth() + direction);
            updateMiniCalendar();
        }

        function updateWeeklyCalendar() {
            const calendarBody = document.getElementById('calendarBody');
            calendarBody.innerHTML = '';

            // Calcular início da semana
            const weekStart = new Date(currentDate);
            weekStart.setDate(currentDate.getDate() - currentDate.getDay());

            // Atualizar cabeçalhos dos dias
            const dayNames = ['SEG', 'TER', 'QUA', 'QUI', 'SEX', 'SAB', 'DOM'];
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(weekStart);
                dayDate.setDate(weekStart.getDate() + i);
                const dayHeader = document.getElementById(`day${i}`);
                
                dayHeader.querySelector('.day-name').textContent = dayNames[i];
                dayHeader.querySelector('.day-number').textContent = dayDate.getDate();
                
                // Remover classe today de todos
                dayHeader.classList.remove('today');
                // Adicionar classe today se for hoje
                if (isToday(dayDate)) {
                    dayHeader.classList.add('today');
                }
            }

            // Gerar horários (06:00 - 22:00)
            for (let hour = 6; hour <= 22; hour++) {
                // Coluna de hora
                const timeSlot = document.createElement('div');
                timeSlot.className = 'time-slot';
                timeSlot.textContent = `${hour.toString().padStart(2, '0')}:00`;
                calendarBody.appendChild(timeSlot);

                // Colunas dos dias
                for (let day = 0; day < 7; day++) {
                    const dayDate = new Date(weekStart);
                    dayDate.setDate(weekStart.getDate() + day);
                    
                    const daySlot = document.createElement('div');
                    daySlot.className = 'day-slot';
                    
                    if (isToday(dayDate)) {
                        daySlot.classList.add('today');
                    }
                    
                    // Adicionar eventos para este horário
                    const hourEvents = getEventsForHour(dayDate, hour);
                    hourEvents.forEach(event => {
                        const eventElement = document.createElement('div');
                        eventElement.className = `event-block event-${event.type}`;
                        eventElement.textContent = event.title;
                        
                        // Calcular posição e altura baseada no horário
                        const startTime = new Date(event.startTime);
                        const endTime = new Date(event.endTime);
                        const startMinutes = startTime.getMinutes();
                        const durationMinutes = (endTime.getTime() - startTime.getTime()) / (1000 * 60);
                        
                        eventElement.style.top = `${(startMinutes / 60) * 100}%`;
                        eventElement.style.height = `${(durationMinutes / 60) * 100}%`;
                        
                        eventElement.addEventListener('click', (e) => {
                            e.stopPropagation();
                            editEvent(event);
                        });
                        
                        daySlot.appendChild(eventElement);
                    });
                    
                    daySlot.addEventListener('click', () => {
                        dayDate.setHours(hour, 0, 0, 0);
                        openEventModal(dayDate);
                    });
                    
                    calendarBody.appendChild(daySlot);
                }
            }
        }

        function updateCurrentWeekRange() {
            const weekStart = new Date(currentDate);
            weekStart.setDate(currentDate.getDate() - currentDate.getDay());
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);

            const rangeElement = document.getElementById('currentWeekRange');
            rangeElement.textContent = `${weekStart.getDate()} - ${weekEnd.getDate()} ${weekStart.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })}`;
        }

        function navigateWeek(direction) {
            currentDate.setDate(currentDate.getDate() + (direction * 7));
            updateWeeklyCalendar();
            updateCurrentWeekRange();
        }

        function goToToday() {
            currentDate = new Date();
            updateWeeklyCalendar();
            updateCurrentWeekRange();
        }

        function isToday(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        function hasEventsOnDate(date) {
            return events.some(event => {
                const eventDate = new Date(event.startTime);
                return eventDate.toDateString() === date.toDateString();
            });
        }

        function getEventsForHour(date, hour) {
            return events.filter(event => {
                const eventDate = new Date(event.startTime);
                return eventDate.toDateString() === date.toDateString() && 
                       eventDate.getHours() === hour;
            });
        }

        function openEventModal(date = null) {
            const modal = document.getElementById('eventModal');
            const form = document.getElementById('eventForm');
            
            form.reset();
            if (date) {
                document.getElementById('eventDate').value = date.toISOString().split('T')[0];
                document.getElementById('eventTime').value = date.toTimeString().slice(0, 5);
            }
            
            editingEvent = null;
            modal.classList.add('active');
        }

        function closeEventModal() {
            const modal = document.getElementById('eventModal');
            modal.classList.remove('active');
            editingEvent = null;
        }

        function editEvent(event) {
            editingEvent = event;
            
            document.getElementById('eventTitle').value = event.title;
            document.getElementById('eventType').value = event.type;
            document.getElementById('eventDate').value = event.date;
            document.getElementById('eventTime').value = event.time;
            document.getElementById('eventDuration').value = event.duration;
            document.getElementById('eventLocation').value = event.location || '';
            document.getElementById('eventDescription').value = event.description || '';
            
            document.getElementById('modalTitle').textContent = 'Editar Evento';
            
            const modal = document.getElementById('eventModal');
            modal.classList.add('active');
        }

        async function handleEventSubmit(e) {
            e.preventDefault();
            
            // Coletar múltiplos horários
            const horarios = Array.from(document.querySelectorAll('#horariosContainer [data-schedule-row]'))
                .reduce((acc, el, idx, arr) => {
                    // Agrupar a cada 4 (data/hora/duracao/recorrencia)
                    if (idx % 4 === 0) {
                        const dateEl = arr[idx].querySelector('input[type="date"]') || document.getElementById('eventDate');
                        const timeEl = arr[idx + 1]?.querySelector('input[type="time"]') || document.getElementById('eventTime');
                        const durEl = arr[idx + 2]?.querySelector('input[type="number"]') || document.getElementById('eventDuration');
                        const recEl = arr[idx + 3]?.querySelector('select.recurrence-select');
                        if (dateEl && timeEl && durEl && dateEl.value && timeEl.value) {
                            const startLocal = new Date(`${dateEl.value}T${timeEl.value}`);
                            const dur = parseInt(durEl.value || '60');
                            acc.push({
                                date: dateEl.value,
                                time: timeEl.value,
                                startTime: startLocal.toISOString(),
                                endTime: new Date(startLocal.getTime() + dur * 60000).toISOString(),
                                duration: dur,
                                recurrence: recEl ? recEl.value : 'nenhuma'
                            });
                        }
                    }
                    return acc;
                }, []);

            const firstSchedule = horarios[0] || null;
            const start = firstSchedule ? new Date(firstSchedule.startTime) : new Date(`${document.getElementById('eventDate').value}T${document.getElementById('eventTime').value}`);
            const durationMin = firstSchedule ? firstSchedule.duration : parseInt(document.getElementById('eventDuration').value);
            // Ler anexo (opcional)
            async function readFileAsBase64(file) {
                if (!file) return null;
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }
            const anexoFile = document.getElementById('eventAnexo')?.files?.[0] || null;
            const anexoBase64 = anexoFile ? await readFileAsBase64(anexoFile) : null;
            const formData = {
                title: document.getElementById('eventTitle').value,
                type: document.getElementById('eventType').value,
                date: document.getElementById('eventDate').value,
                time: document.getElementById('eventTime').value,
                startTime: start.toISOString(),
                endTime: new Date(start.getTime() + durationMin * 60000).toISOString(),
                duration: durationMin,
                location: document.getElementById('eventLocation').value,
                description: document.getElementById('eventDescription').value,
                status: document.getElementById('eventStatus').value,
                vinculos: Array.from(document.querySelectorAll('#comunidadesContainer [data-comunidade-row]')).map(row => ({
                    comunidade_id: (row.querySelector('.comunidade-select')?.value ? Number(row.querySelector('.comunidade-select').value) : null),
                    pastoral_id: (document.getElementById('eventPastoral')?.value ? Number(document.getElementById('eventPastoral').value) : null),
                    pilar_id: (document.getElementById('eventPilar')?.value ? Number(document.getElementById('eventPilar').value) : null),
                    local_id: (document.getElementById('eventLocalSelect')?.value ? Number(document.getElementById('eventLocalSelect').value) : null),
                    acao_id: (document.getElementById('eventAcao')?.value ? Number(document.getElementById('eventAcao').value) : null)
                })).filter(v => v.comunidade_id || v.pastoral_id || v.pilar_id || v.local_id || v.acao_id),
                horarios: horarios,
                objetivo: document.getElementById('eventObjetivo').value || null,
                paroquial: !!document.getElementById('eventParoquial').checked,
                anexo_nome: anexoFile ? anexoFile.name : null,
                anexo_tipo: anexoFile ? anexoFile.type : null,
                anexo_base64: anexoBase64
            };

            try {
                const btn = document.getElementById('eventSubmitBtn');
                const original = btn ? btn.innerHTML : '';
                if (btn) { btn.disabled = true; btn.innerHTML = '<span style="width:14px;height:14px;border:2px solid rgba(255,255,255,.4);border-top-color:#fff;border-radius:50%;display:inline-block;animation:spin .9s linear infinite"></span>&nbsp;&nbsp;Salvando...'; }
                if (editingEvent && editingEvent.id != null) {
                    const { error } = await window.api.put(window.endpoints.agenda.update(editingEvent.id), formData);
                    if (error) throw error;
                    showToast('Evento atualizado com sucesso!', 'success');
            } else {
                    const { data, error } = await window.api.post(window.endpoints.agenda.create, formData);
                    if (error) throw error;
                    showToast('Evento criado com sucesso!', 'success');
            }

                await loadEventsFromApi();
            updateWeeklyCalendar();
            updateMiniCalendar();
            updateRecentAppointments();
            closeEventModal();
            } catch (err) {
                console.error('Erro ao salvar evento:', err);
                showToast('Erro ao salvar evento', 'error');
            } finally {
                const btn = document.getElementById('eventSubmitBtn');
                if (btn) { btn.disabled = false; btn.innerHTML = 'Salvar Evento'; }
            }
        }

        async function deleteEvent(eventId) {
            if (!confirm('Tem certeza que deseja excluir este evento?')) return;
            try {
                const { error } = await window.api.delete(window.endpoints.agenda.delete(eventId));
                if (error) throw error;
                await loadEventsFromApi();
                updateWeeklyCalendar();
                updateMiniCalendar();
                updateRecentAppointments();
                showToast('Evento excluído com sucesso!', 'success');
            } catch (err) {
                console.error('Erro ao excluir evento:', err);
                showToast('Erro ao excluir evento', 'error');
            }
        }

        async function loadEventsFromApi() {
            try {
                const { data, error } = await window.api.get(window.endpoints.agenda.list);
                if (error) throw error;
                const lista = Array.isArray(data) ? data : [];
                // Normalizar objetos para uso no calendário
                events = lista.map(ev => ({
                    ...ev,
                    // Garantir compatibilidade de tipos
                    startTime: ev.startTime || ev.start_time || ev.inicio || ev.data_inicio || ev.dataHoraInicio || ev.start || ev.startedAt || ev.inicio_iso || ev.inicioISO || ev.data_inicio_iso || ev.dataInicioISO || ev.data_inicio_iso || ev.start_iso || ev.startISO || ev.startDate || ev.start_date,
                    endTime: ev.endTime || ev.end_time || ev.fim || ev.data_fim || ev.dataHoraFim || ev.end || ev.endedAt || ev.fim_iso || ev.fimISO || ev.data_fim_iso || ev.dataFimISO || ev.data_fim_iso || ev.end_iso || ev.endISO || ev.endDate || ev.end_date
                }));
            } catch (err) {
                console.error('Erro ao carregar eventos da API:', err);
                events = [];
            }
        }

        function updateRecentAppointments() {
            const appointmentsList = document.getElementById('recentAppointmentsList');
            appointmentsList.innerHTML = '';

            // Ordenar eventos por data (mais recentes primeiro)
            const sortedEvents = [...events].sort((a, b) => new Date(b.startTime) - new Date(a.startTime));
            
            // Pegar os últimos 5 eventos
            const recentEvents = sortedEvents.slice(0, 5);

            if (recentEvents.length === 0) {
                appointmentsList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #666; font-size: 12px;">
                        <i class="fas fa-calendar-plus" style="font-size: 24px; margin-bottom: 8px; display: block; opacity: 0.5;"></i>
                        Nenhum agendamento encontrado
                    </div>
                `;
                return;
            }

            recentEvents.forEach(event => {
                const eventDate = new Date(event.startTime);
                const timeString = eventDate.toLocaleTimeString('pt-BR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const dateString = eventDate.toLocaleDateString('pt-BR', { 
                    day: '2-digit', 
                    month: '2-digit' 
                });

                // Determinar status baseado na data
                let status = 'confirmed';
                let statusClass = 'status-confirmed';
                
                if (eventDate < new Date()) {
                    status = 'completed';
                    statusClass = 'status-confirmed';
                } else if (eventDate.toDateString() === new Date().toDateString()) {
                    status = 'today';
                    statusClass = 'status-pending';
                }

                const appointmentItem = document.createElement('div');
                appointmentItem.className = 'appointment-item';
                appointmentItem.innerHTML = `
                    <div class="appointment-time">${timeString}</div>
                    <div class="appointment-details">
                        <div class="appointment-title">${event.title}</div>
                        <div class="appointment-type">${getEventTypeLabel(event.type)} • ${dateString}</div>
                    </div>
                    <div class="appointment-status ${statusClass}"></div>
                `;
                
                appointmentItem.addEventListener('click', () => {
                    editEvent(event);
                });
                
                appointmentsList.appendChild(appointmentItem);
            });
        }

        function getEventTypeLabel(type) {
            const labels = {
                'missa': 'Missa',
                'batizado': 'Batizado',
                'casamento': 'Casamento',
                'comunhao': 'Comunhão',
                'crisma': 'Crisma',
                'funeral': 'Funeral',
                'reuniao': 'Reunião',
                'outro': 'Outro'
            };
            return labels[type] || 'Evento';
        }


        // Carregar opções dos selects (Comunidade, Pastoral, Pilar, Local, Ação)
        async function loadSelectOptions(selectId, endpoint) {
            try {
                const select = document.getElementById(selectId);
                if (!select) return;
                select.innerHTML = '<option value="">Carregando...</option>';
                const { data, error } = await window.api.get(endpoint);
                if (error) throw error;
                const lista = Array.isArray(data) ? data : [];
                const options = ['<option value="">Selecione</option>']
                    .concat(lista.map(item => `<option value="${item.id || item.codigo}">${item.nome || item.titulo || item.descricao || 'Registro'}</option>`));
                select.innerHTML = options.join('');
            } catch (e) {
                const select = document.getElementById(selectId);
                if (select) select.innerHTML = '<option value="">Erro ao carregar</option>';
                console.error('Erro ao carregar select', selectId, e);
            }
        }

        // Carregar opções para um select específico (elemento já existente)
        async function loadSelectOptionsForElement(selectEl, endpoint) {
            try {
                if (!selectEl) return;
                selectEl.innerHTML = '<option value="">Carregando...</option>';
                const { data, error } = await window.api.get(endpoint);
                if (error) throw error;
                const lista = Array.isArray(data) ? data : [];
                const options = ['<option value="">Selecione</option>']
                    .concat(lista.map(item => `<option value="${item.id || item.codigo}">${item.nome || item.titulo || item.descricao || 'Registro'}</option>`));
                selectEl.innerHTML = options.join('');
            } catch (e) {
                if (selectEl) selectEl.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }

        async function loadAgendaLookups() {
            await Promise.all([
                loadSelectOptions('eventComunidade', window.endpoints.comunidades.list),
                loadSelectOptions('eventPastoral', window.endpoints.pastorais.list),
                loadSelectOptions('eventPilar', window.endpoints.pilares.list),
                loadSelectOptions('eventLocalSelect', window.endpoints.locais.list),
                loadSelectOptions('eventAcao', window.endpoints.acoes.list)
            ]);
        }


        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff'};
                color: white;
                padding: 15px 20px;
                border-radius: 6px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // Adicionar estilos de animação
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
