<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda - ParoquiaON</title>
    <link rel="icon" type="image/png" href="assets/images/logo2.png">
    <link rel="stylesheet" href="styles/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        .top-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: #1e3a8a;
            color: white;
            padding: 0 30px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .left-sidebar {
            width: 350px;
            background: transparent;
            border-right: none;
            display: flex;
            flex-direction: column;
            position: fixed;
            left: 0;
            top: 80px;
            height: calc(100vh - 80px);
            z-index: 100;
            padding: 0;
            overflow-y: auto;
            overflow-x: hidden;
            transition: transform 0.3s ease-in-out;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
        }

        .left-sidebar.collapsed {
            transform: translateX(-100%);
        }

        .sidebar-toggle {
            display: none;
            position: fixed;
            top: 90px;
            left: 20px;
            z-index: 1001;
            background: #1e3a8a;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .sidebar-toggle:hover {
            background: #1e40af;
            transform: scale(1.1);
        }



        .create-button {
            margin: 5px auto;
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(30, 58, 138, 0.15);
            position: relative;
            z-index: 10;
            width: 200px;
            font-size: 14px;
        }

        .create-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.25);
            background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
        }

        .create-button:active {
            transform: translateY(0);
            box-shadow: 0 1px 4px rgba(30, 58, 138, 0.2);
        }


        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(6px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            border: none;
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
            display: flex;
            flex-direction: column;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: scale(0.95) translateY(-20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e5e7eb;
            flex-shrink: 0;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
            color: #1e3a8a;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-title i {
            color: #1e3a8a;
        }

        .modal-header h2 {
            font-size: 24px;
            font-weight: 600;
            color: #1e3a8a !important;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-header h2 i {
            color: #1e3a8a !important;
        }

        #modalTitle {
            color: #1e3a8a !important;
        }

        .modal-body {
            overflow-y: auto;
            flex: 1;
            padding-right: 10px;
        }

        .modal-body .form-group:has(.checkbox-group) {
            overflow: visible !important;
            max-height: none !important;
        }

        .modal-body::-webkit-scrollbar {
            width: 6px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .modal-body::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            border-color: #1e3a8a;
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }

        .form-input::placeholder {
            color: #9ca3af;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 58, 138, 0.35);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 2px solid #e5e7eb;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
            transform: translateY(-1px);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #6b7280;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: #f5f5f5;
            color: #333;
        }

        @media (max-width: 768px) {
            .modal-content {
                margin: 20px;
                max-width: calc(100% - 40px);
            padding: 20px;
            }
            
            .modal-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        .form-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .section-title {
            margin: 0 0 20px 0;
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #1e3a8a;
        }

        .section-title i {
            color: #1e3a8a;
            font-size: 1.1em;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: flex-start;
        }

        .form-group {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group label i {
            margin-right: 5px;
            color: #1e3a8a;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        .form-group select {
            max-height: 200px !important;
            overflow-y: auto !important;
            background-color: white;
            cursor: pointer;
            height: auto !important;
        }

        #eventModal select {
            max-height: 200px !important;
            overflow-y: auto !important;
            height: auto !important;
        }

        select[size] {
            max-height: 200px !important;
            overflow-y: auto !important;
        }

        .form-group select::-webkit-scrollbar {
            width: 8px;
        }

        .form-group select::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .form-group select::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .form-group select::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .form-group select option {
            padding: 8px 12px;
            max-height: 40px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .form-group select:focus {
            border-color: #1e3a8a;
            outline: none;
            box-shadow: 0 0 0 2px rgba(30, 58, 138, 0.1);
        }

        .form-group select[size] {
            max-height: 200px;
            overflow-y: auto;
        }

        #eventModal .form-group select,
        #eventModal select {
            max-height: 200px !important;
            overflow-y: auto !important;
            height: auto !important;
            min-height: 40px !important;
        }

        #eventModal .checkbox-group {
            max-height: none !important;
            overflow: visible !important;
            height: auto !important;
            width: 100% !important;
            position: relative !important;
        }

        #eventModal .form-group:has(.checkbox-group) {
            overflow: visible !important;
            max-height: none !important;
            height: auto !important;
            width: 100% !important;
        }

        #eventModal .form-row:has(.checkbox-group) {
            overflow: visible !important;
            max-height: none !important;
            height: auto !important;
        }

        #eventModal #eventParoquial {
            position: relative !important;
            z-index: 10 !important;
        }

        #eventModal .checkbox-label {
            white-space: nowrap !important;
            overflow: visible !important;
            text-overflow: unset !important;
        }

        .checkbox-full-width {
            width: 100% !important;
            flex: 1 1 100% !important;
            min-width: 0 !important;
            overflow: visible !important;
        }

        .checkbox-full-width .checkbox-group {
            width: 100% !important;
            overflow: visible !important;
        }

        .checkbox-full-width .checkbox-label {
            width: 100% !important;
            overflow: visible !important;
            display: flex !important;
            align-items: center !important;
        }

        #eventModal input[type="time"] {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        #eventModal input[type="date"] {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        #eventModal .search-select-field {
            position: relative;
            width: 100%;
        }

        #eventModal .search-select-field input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff;
            color: #333;
            font-size: 14px;
        }

        #eventModal .search-select-field input:hover {
            border-color: #1e3a8a;
        }

        #eventModal .search-select-field input:focus {
            border-color: #1e3a8a;
            outline: none;
            box-shadow: 0 0 0 2px rgba(30, 58, 138, 0.1);
        }

        #eventModal .search-select-menu {
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            z-index: 10;
            display: none;
        }

        #eventModal .search-select-field.open .search-select-menu {
            display: block;
        }

        #eventModal .search-select-list {
            max-height: 220px;
            overflow-y: auto;
        }

        #eventModal .search-select-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f8f8f8;
        }

        #eventModal .search-select-item:hover {
            background: #f8f9fa;
        }

        #eventModal .search-select-item.is-selected {
            background: #eff6ff;
            color: #1e3a8a;
        }

        /* Mini-calendário */
        #eventModal .mini-calendar {
            padding: 16px;
            font-size: 14px;
        }

        #eventModal .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-weight: 600;
        }

        #eventModal .calendar-nav {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        #eventModal .calendar-nav:hover {
            background: #f0f0f0;
        }

        #eventModal .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 8px;
            font-weight: 600;
            color: #666;
            text-align: center;
        }

        #eventModal .calendar-weekdays > div {
            padding: 8px 4px;
            font-size: 12px;
        }

        #eventModal .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        #eventModal .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
            font-size: 13px;
        }

        #eventModal .calendar-day:hover {
            background: #f0f0f0;
        }

        #eventModal .calendar-day.today {
            background: #1e3a8a;
            color: white;
            font-weight: 600;
        }

        #eventModal .calendar-day.selected {
            background: #1e3a8a;
            color: white;
            font-weight: 600;
        }

        #eventModal .calendar-day.other-month {
            color: #ccc;
            cursor: default;
        }

        #eventModal .calendar-day.other-month:hover {
            background: transparent;
        }

        /* Responsivo para selects */
        @media (max-width: 768px) {
            .form-group select,
            #eventModal select {
                max-height: 150px !important;
            }
        }

        /* Estilo adicional para garantir scroll */
        select {
            max-height: 200px !important;
            overflow-y: auto !important;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            border-color: #1e3a8a;
            outline: none;
            box-shadow: 0 0 0 2px rgba(30, 58, 138, 0.1);
        }

        .form-group input[readonly] {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            flex-shrink: 0;
        }

        .btn-primary,
        .btn-secondary {
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            border: none;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 58, 138, 0.35);
        }

        .btn-secondary {
            background-color: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
        }

        .btn-secondary:hover {
            background-color: #e0e0e0;
        }

        /* Toggle de Status */
        .status-toggle-modal {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .status-label-modal {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        /* Modal Header Actions */
        .modal-header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5em;
            color: #666;
            cursor: pointer;
            padding: 5px;
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: #333;
        }

        /* Checkbox personalizado */
        .checkbox-group {
            margin-top: 8px;
            padding: 12px 0;
            min-height: 50px;
            display: flex;
            align-items: center;
            width: 100%;
            overflow: visible;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
            color: #555;
            padding: 8px 0;
            min-height: 40px;
            width: 100%;
            overflow: visible;
        }

        .checkbox-label input[type="checkbox"] {
            display: none;
        }

        .checkmark {
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
            position: relative;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .checkbox-label input[type="checkbox"]:checked + .checkmark {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            border-color: #1e3a8a;
        }

        .checkbox-label input[type="checkbox"]:checked + .checkmark::after {
            content: "✓";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        /* Estilos para campos de arquivo */
        .file-info {
            margin-top: 5px;
        }

        .file-info small {
            color: #666;
            font-size: 12px;
        }

        input[type="file"] {
            width: 100%;
            padding: 8px;
            border: 2px dashed #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        input[type="file"]:hover {
            border-color: #1e3a8a;
            background-color: #f0f8ff;
        }

        input[type="file"]:focus {
            outline: none;
            border-color: #1e3a8a;
            box-shadow: 0 0 0 2px rgba(30, 58, 138, 0.1);
        }

        /* Responsivo para formulário */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .form-section {
                padding: 15px;
            }
            
            .modal-header-actions {
                flex-direction: column;
                gap: 10px;
            }
        }










        /* Container lateral do calendário */
        .calendar-sidebar-container {
            width: 350px;
            margin: 0;
            background: #ffffff;
            border-radius: 0;
            overflow: hidden;
            box-shadow: none;
            border: none;
            position: relative;
            z-index: 10;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            height: calc(100vh - 80px);
            transition: all 0.3s ease;
        }

        /* Efeito hover removido para manter consistência com o layout */

        .calendar-sidebar-header {
            background: #ffffff;
            color: #495057;
            padding: 20px;
            text-align: center;
            font-weight: 600;
            font-size: 18px;
            border-bottom: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .calendar-sidebar-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .calendar-collapse-btn {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
            font-size: 16px;
        }

        .calendar-collapse-btn:hover {
            background: #f8f9fa;
            color: #1e3a8a;
        }

        .calendar-sidebar-container.collapsed {
            width: 60px;
            overflow: hidden;
        }

        .left-sidebar.calendar-collapsed {
            width: 60px;
        }

        .calendar-sidebar-container.collapsed .calendar-sidebar-header {
            padding: 20px 15px;
            justify-content: center;
        }

        .calendar-sidebar-container.collapsed .calendar-sidebar-title {
            display: none;
        }

        .calendar-sidebar-container.collapsed .mini-calendar,
        .calendar-sidebar-container.collapsed .create-button,
        .calendar-sidebar-container.collapsed .recent-appointments {
            display: none;
        }

        .calendar-sidebar-header i {
            color: #1e3a8a;
            font-size: 20px;
        }

        /* === INDICADORES DE ESTADO === */
        .event-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .event-item:hover {
            background: #f8f9fa;
            transform: translateX(5px);
        }

        .event-item.status-ativo {
            border-left: 4px solid #28a745;
        }

        .event-item.status-concluido {
            border-left: 4px solid #6c757d;
            opacity: 0.7;
        }

        .event-item.status-cancelado {
            border-left: 4px solid #dc3545;
            opacity: 0.7;
        }

        .event-item.status-inativo {
            border-left: 4px solid #ffc107;
        }

        .event-status-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #6c757d;
        }

        .event-status-indicator.ativo {
            background: #28a745;
        }

        .event-status-indicator.concluido {
            background: #6c757d;
        }

        .event-status-indicator.cancelado {
            background: #dc3545;
        }

        .event-status-indicator.inativo {
            background: #ffc107;
        }

        /* Mini calendário */
        .mini-calendar {
            margin: 0;
            background: #ffffff;
            border-radius: 0;
            overflow: hidden;
            box-shadow: none;
            border: none;
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
            max-height: 300px;
            overflow-y: auto;
        }

        .mini-calendar-header {
            background: #ffffff;
            color: #333;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: none;
            font-weight: 500;
        }

        .mini-calendar-title {
            font-weight: 500;
            font-size: 14px;
            color: #333;
        }

        .mini-calendar-nav {
            display: flex;
            gap: 8px;
        }

        .mini-nav-btn {
            background: transparent;
            border: none;
            color: #333;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 500;
            transition: background 0.2s ease;
        }

        .mini-nav-btn:hover {
            background: #f8f9fa;
        }

        .mini-calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: #ffffff;
            border-bottom: none;
        }

        .mini-weekday {
            padding: 6px 4px;
            text-align: center;
            font-size: 11px;
            font-weight: 500;
            color: #333;
        }

        .mini-calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0;
            background: #ffffff;
            flex: 0 0 auto;
            min-height: 0;
        }

        .mini-day {
            background: #ffffff;
            padding: 6px 4px;
            text-align: center;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            font-weight: 400;
        }

        .mini-day:hover {
            background: #f8f9fa;
        }

        .mini-day.selected {
            background: #007bff;
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mini-day.has-events {
            background: #ffffff;
            position: relative;
        }

        .mini-day.has-events::after {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 3px;
            height: 3px;
            background: #007bff;
            border-radius: 50%;
        }

        .mini-day.other-month {
            color: #999;
        }

        /* Seção de Últimos Agendamentos */
        .recent-appointments {
            margin: 20px;
            background: #ffffff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid #f0f0f0;
            flex: 0 0 auto;
        }

        .recent-appointments-header {
            background: #ffffff;
            color: #333;
            padding: 15px 20px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            border-bottom: 1px solid #f0f0f0;
        }

        .appointments-list {
            padding: 0;
            margin: 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .appointment-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f8f9fa;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s ease;
        }

        .appointment-item:last-child {
            border-bottom: none;
        }

        .appointment-item:hover {
            background: #f8f9fa;
        }

        .appointment-time {
            background: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            min-width: 50px;
            text-align: center;
        }

        .appointment-details {
            flex: 1;
        }

        .appointment-title {
            font-size: 12px;
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .appointment-type {
            font-size: 10px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .appointment-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .status-confirmed {
            background: #28a745;
        }

        .status-pending {
            background: #ffc107;
        }

        .status-cancelled {
            background: #dc3545;
        }


        /* Área principal */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
            margin-top: 80px; /* Compensar altura da barra fixa */
            margin-left: 350px;
            width: calc(100vw - 350px);
            min-height: calc(100vh - 80px);
            transition: all 0.3s ease;
        }

        .main-area.calendar-collapsed {
            margin-left: 60px;
            width: calc(100vw - 60px);
        }


        .header-left {
            display: flex;
            align-items: center;
            gap: 60px;
            flex: 1;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }


        .nav-links {
            display: flex;
            gap: 30px;
            justify-content: center;
            flex: 1;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 12px 0;
            position: relative;
            transition: opacity 0.2s ease;
            font-size: 16px;
        }

        .nav-link:hover {
            opacity: 0.8;
        }

        .nav-link.active {
            opacity: 1;
        }

        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            right: 0;
            height: 3px;
            background: #ffffff;
            border-radius: 2px;
        }

        /* Dropdown styles */
        .nav-dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-trigger {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .dropdown-trigger i {
            font-size: 12px;
            transition: transform 0.2s ease;
        }

        .nav-dropdown:hover .dropdown-trigger i {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 180px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            z-index: 1000;
            border: 1px solid #e0e0e0;
        }

        .nav-dropdown:hover .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            display: block;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s ease;
            border-bottom: 1px solid #f0f0f0;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: #f8f9fa;
            color: #1976d2;
        }

        .beta-tag {
            background: #ff9800;
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
            text-transform: uppercase;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-shrink: 0;
        }

        .header-icon {
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s ease;
            position: relative;
            font-size: 16px;
        }

        .header-icon:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #f44336;
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .user-avatar {
            width: 44px;
            height: 44px;
            background: #4caf50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
        }

        /* Área de conteúdo principal */
        .content-area {
            flex: 1;
            padding: 0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            position: relative;
            background: transparent;
            width: 100%;
        }


        /* Container de informações acima do calendário */
        .calendar-info-container {
            background: white;
            border-radius: 12px;
            padding: 20px 25px;
            position: relative;
            margin: 5px 15px 5px 15px;
            box-shadow: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            border: 1px solid #f0f0f0;
            min-height: 70px;
            position: relative;
            z-index: 100;
            width: calc(100% - 30px);
            transition: all 0.3s ease;
            isolation: isolate;
        }

        .info-left {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .info-location {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-location-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .info-location-label {
            font-size: 15px;
            color: #333;
            font-weight: 600;
            white-space: nowrap;
        }

        .info-location-name {
            font-size: 18px;
            color: #333;
            font-weight: 700;
        }

        .info-location-select {
            font-size: 15px;
            color: #333;
            font-weight: 600;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 180px;
            outline: none;
        }

        .info-location-select:hover {
            border-color: #1976d2;
            background: #f8f9fa;
        }

        .info-location-select:focus {
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }

        .info-agenda {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .info-agenda-label {
            font-size: 15px;
            color: #333;
            font-weight: 600;
        }

        .info-agenda-avatar {
            width: 36px;
            height: 36px;
            background: #1976d2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        .info-agenda-name {
            font-size: 15px;
            color: #333;
            font-weight: 600;
        }

        .info-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .info-date {
            font-size: 18px;
            color: #333;
            font-weight: 700;
            text-align: center;
            padding: 8px 16px;
        }

        .date-navigation {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .date-nav-btn {
            background: #1976d2;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .date-nav-btn:hover {
            background: #1565c0;
            transform: scale(1.05);
        }

        .date-nav-btn:active {
            transform: scale(0.95);
        }

        /* Estilos para múltiplos horários */

        .time-slot {
            border-radius: 8px;
            padding: 15px;
            background: #f9f9f9;
            position: relative;
        }

        .time-slot:first-child {
            background: #fff;
        }

        .time-actions {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 50px;
        }

        .btn-remove-time {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
        }

        .btn-remove-time:hover {
            background: #d32f2f;
            transform: scale(1.05);
        }

        .btn-add-time {
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-add-time:hover {
            background: #45a049;
            transform: translateY(-1px);
        }

        /* Estilos para múltiplos períodos de agendamento */
        .add-period-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .subsection-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e3a8a;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .subsection-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: #1e3a8a;
            border-radius: 2px;
        }

        .btn-add-period {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            height: 40px;
            margin-top: 20px;
        }

        .btn-add-period:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .periods-list-section {
            margin-bottom: 20px;
        }

        .periods-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: white;
        }

        .no-periods-message {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .no-periods-message i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .no-periods-message p {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .no-periods-message small {
            font-size: 14px;
            opacity: 0.7;
        }

        .period-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            border-bottom: 1px solid #f8f9fa;
            transition: background 0.2s ease;
        }

        .period-item:last-child {
            border-bottom: none;
        }

        .period-item:hover {
            background: #f8f9fa;
        }

        .period-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .period-date {
            background: #1e3a8a;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            min-width: 100px;
            text-align: center;
        }

        .period-time {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #495057;
        }

        .period-time i {
            color: #1e3a8a;
        }

        .period-time .time-range {
            display: inline-block;
            white-space: nowrap;
        }

        .period-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-remove-period {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-remove-period:hover {
            background: #c82333;
            transform: scale(1.05);
        }

        .periods-count {
            background: #17a2b8;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .info-today-btn {
            background: #1976d2;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
            font-size: 15px;
            box-shadow: 0 2px 4px rgba(25, 118, 210, 0.3);
        }

        .info-today-btn:hover {
            background: #1565c0;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(25, 118, 210, 0.4);
        }

        /* View Dropdown styles (igual ao dropdown de relatórios) */
        .view-dropdown {
            position: relative;
            display: inline-block;
        }

        .view-dropdown-trigger {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            min-width: 120px;
            font-size: 15px;
            transition: all 0.2s ease;
        }

        .view-dropdown-trigger:hover {
            border-color: #1976d2;
            background: #f8f9fa;
        }

        .view-dropdown-trigger i {
            font-size: 12px;
            transition: transform 0.2s ease;
        }

        .view-dropdown:hover .view-dropdown-trigger i {
            transform: rotate(180deg);
        }

        .view-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            width: 100%;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            z-index: 1;
            border: 1px solid #e0e0e0;
        }

        .view-dropdown:hover .view-dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .view-dropdown-item {
            display: block;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s ease;
            border-bottom: 1px solid #f0f0f0;
        }

        .view-dropdown-item:last-child {
            border-bottom: none;
        }

        .view-dropdown-item:hover {
            background: #f8f9fa;
            color: #1976d2;
        }

        /* Estilos para visualização de dia */
        .day-month {
            font-size: 12px;
            color: #666;
            font-weight: 400;
            margin-top: 2px;
        }

        .info-online-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            color: #666;
            font-weight: 500;
        }

        /* Community Dropdown styles (igual ao dropdown de visualização) */
        .community-dropdown {
            position: relative;
            display: inline-block;
        }

        .community-dropdown-trigger {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            min-width: 200px;
            font-size: 15px;
            transition: all 0.2s ease;
        }

        .community-dropdown-trigger:hover {
            border-color: #1976d2;
            background: #f8f9fa;
        }

        .community-dropdown-trigger i {
            font-size: 12px;
            transition: transform 0.2s ease;
        }

        .community-dropdown:hover .community-dropdown-trigger i {
            transform: rotate(180deg);
        }

        .community-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            width: 100%;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            z-index: 1;
            border: 1px solid #e0e0e0;
            max-height: 200px;
            overflow-y: auto;
        }

        .community-dropdown:hover .community-dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .community-dropdown-item {
            display: block;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s ease;
            border-bottom: 1px solid #f0f0f0;
        }

        .community-dropdown-item:last-child {
            border-bottom: none;
        }

        .community-dropdown-item:hover {
            background: #f8f9fa;
            color: #1976d2;
        }

        /* Calendário semanal */
        .weekly-calendar {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.12);
            flex: 1;
            display: flex;
            flex-direction: column;
            margin: 0 15px 5px 15px;
            border: 1px solid #f0f0f0;
            position: relative;
            z-index: 10;
            max-height: calc(100vh - 160px);
            overflow-y: auto;
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
            width: calc(100% - 30px);
            transition: all 0.3s ease;
        }


        /* Container do corpo do calendário - limitar altura dos eventos */
        .calendar-body {
            overflow: hidden;
            position: relative;
        }

        .weekly-calendar::-webkit-scrollbar {
            display: none;  /* Chrome, Safari and Opera */
        }

        .calendar-header {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
            background: #ffffff;
            border-bottom: 1px solid #e0e0e0;
            border-collapse: separate;
            border-spacing: 0;
            position: sticky;
            top: 0;
            z-index: 20;
        }

        .time-column-header {
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
            color: #666;
            border-right: none; /* remove linha vertical no título da coluna de horas */
            position: sticky;
            top: 0;
            background: #ffffff;
            z-index: 21;
        }

        .day-header {
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
            color: #333;
            border-right: 1px solid #e0e0e0;
            background: #ffffff;
            transition: background-color 0.2s ease;
            position: sticky;
            top: 0;
            z-index: 21;
        }

        .day-header:hover {
            background: #f8f9fa;
        }

        .day-header:last-child {
            border-right: none;
        }

        .day-header.today { 
            background: #e3f2fd; 
            color: #1976d2; 
        }
        
        .day-header.today::after { 
            display: none; 
        }
        
        .day-header.today .day-number {
            background: #1976d2;
            color: #fff;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            font-weight: 700;
        }

        .day-name {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .day-number {
            font-size: 18px;
            font-weight: bold;
        }

        .calendar-body {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
            flex: 1;
            min-height: 0;
            overflow: visible;
            background: #ffffff;
            border-collapse: separate;
            border-spacing: 0;
            gap: 0;
            row-gap: 0;
        }

        /* Scroll escondido no container central */

        .time-slot {
            height: 60px;
            padding: 8px;
            text-align: center;
            font-size: 12px;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #ffffff;
            margin: 0 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
        }

        .day-column {
            position: relative;
        }

        .day-column:last-child {
            border-right: none;
        }

        .day-column.today {
            background: #f8f9ff;
        }

        .day-slot {
            height: 60px;
            border-bottom: 1px solid #f0f0f0;
            border-right: 1px solid #e0e0e0;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #ffffff;
        }

        .day-slot:hover {
            background: #e3f2fd;
            border-color: #2196f3;
            box-shadow: inset 0 0 0 2px rgba(33, 150, 243, 0.1);
        }

        .day-slot:hover::after {
            content: '+';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            color: #2196f3;
            font-weight: bold;
            opacity: 0.7;
            pointer-events: none;
        }

        .day-slot:last-child {
            border-right: none;
        }

        .day-slot.today { 
            background: #f0f8ff; 
        }

        /* Linha de tempo atual */
        .current-time-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: #ea4335;
            z-index: 10;
            pointer-events: none;
            box-shadow: 0 0 4px rgba(234, 67, 53, 0.3);
        }

        .current-time-line::before {
            content: '';
            position: absolute;
            left: -6px;
            top: -4px;
            width: 10px;
            height: 10px;
            background: #ea4335;
            border-radius: 50%;
            box-shadow: 0 0 4px rgba(234, 67, 53, 0.3);
        }

        /* Badge para número do dia no modo mensal */
        .day-badge {
            position:absolute; top:4px; right:6px; font-size:11px; color:#666;
        }
        .day-badge.today-badge {
            right: 6px; top: 6px;
            background: #1976d2; color: #fff; border-radius: 50%;
            width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 11px;
        }

        /* Eventos */
        .event-block {
            position: absolute;
            left: 2px;
            right: 8px;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 500;
            color: white;
            cursor: pointer;
            z-index: 10;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }

        .event-block:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
            z-index: 100 !important;
            white-space: normal !important;
            overflow: visible !important;
            padding: 12px;
            width: auto !important;
            height: auto !important;
            min-width: 300px;
            max-width: 500px;
        }
        
        .event-block:hover * {
            white-space: normal !important;
        }

        /* Evento truncado (que vai além das 23h) */
        .event-block.event-truncated {
            position: relative;
            overflow: hidden;
        }

        .event-block.event-truncated::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff6b6b, #ff8e8e);
            border-radius: 0 0 4px 4px;
        }

        .event-block.event-truncated::before {
            content: '...';
            position: absolute;
            bottom: 2px;
            right: 4px;
            font-size: 10px;
            color: #ff6b6b;
            font-weight: bold;
        }

        /* Estilo padrão para todos os eventos */
        .event-block {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #333;
            font-weight: 500;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        /* Eventos passados: escurecer sem transparência */
        .event-past {
            filter: grayscale(55%) brightness(0.95) contrast(0.98);
        }
        .event-block.event-past {
            background: linear-gradient(135deg, #d7dce0 0%, #c4cbd1 100%) !important;
            color: #1f2937;
            border-color: #c4cbd1 !important;
        }
        .event-item.event-past {
            background: #e1e5ea !important;
            color: #1f2937;
            border-left-color: #9aa1a8 !important;
        }

        .event-title {
            font-weight: 600;
            font-size: 12px;
            color: #1e3a8a;
            line-height: 1.2;
        }

        .event-datetime {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .event-date {
            font-size: 10px;
            color: #6c757d;
            font-weight: 500;
        }

        .event-time {
            font-size: 10px;
            color: #495057;
            font-weight: 600;
        }

        .event-community {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 2px;
            margin-bottom: 2px;
        }

        .event-avatar {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #007bff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: 600;
            background-size: cover;
            background-position: center;
        }

        .event-community span {
            font-size: 9px;
            color: #6c757d;
            font-weight: 500;
        }

        /* Estilos para modal de edição */
        .event-details {
            margin-bottom: 20px;
        }

        .detail-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-row label {
            font-weight: 600;
            color: #1e3a8a;
            min-width: 120px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-row span {
            color: #333;
            flex: 1;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        /* Estilos para modal overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }



        .modal-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #666;
            padding: 5px;
        }

        .modal-close:hover {
            color: #333;
        }


        /* Estilos específicos para o novo modal de agendamento */
        .new-appointment-modal {
            max-width: 800px;
            width: 95%;
            border: none;
            outline: none;
            padding: 0 !important;
            display: flex !important;
            flex-direction: column !important;
            border-radius: 8px !important;
            overflow: hidden !important;
        }

        .new-appointment-header {
            background: white;
            color: #333;
            padding: 20px;
            border-radius: 8px 8px 0 0;
            border-bottom: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .new-appointment-header .modal-title {
            margin: 0;
            font-size: 1.5em;
            color: #1e3a8a;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .new-appointment-header .modal-title i {
            color: #2196F3;
        }

        .new-appointment-header .close-modal {
            background: none;
            border: none;
            font-size: 1.5em;
            color: #666;
            cursor: pointer;
            padding: 5px;
            transition: color 0.3s;
        }

        .new-appointment-header .close-modal:hover {
            color: #333;
        }

        .modal-header.new-appointment-header {
            border-bottom: none !important;
        }

        .new-appointment-header .modal-title {
            color: #333;
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .new-appointment-header .close-modal {
            color: #666;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
        }

        .modal-header.new-appointment-header {
            border-bottom: none !important;
        }

        .new-appointment-body {
            padding: 5px 20px 20px 20px !important;
            width: 97% !important;
            margin: 0 auto !important;
            overflow-y: auto !important;
            flex: 1 !important;
            max-height: 70vh !important;
            border: none !important;
            outline: none !important;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 #f7fafc;
        }

        .new-appointment-body::-webkit-scrollbar {
            width: 8px;
        }

        .new-appointment-body::-webkit-scrollbar-track {
            background: #f7fafc;
            border-radius: 4px;
        }

        .new-appointment-body::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 4px;
        }

        .new-appointment-body::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        /* Override do estilo geral do modal-body para o novo modal */
        .modal-body.new-appointment-body {
            padding: 1px 20px 20px 20px !important;
            border: none !important;
            outline: none !important;
        }

        /* Override mais específico para garantir que funcione */
        .new-appointment-modal .modal-body.new-appointment-body {
            padding: 1px 20px 20px 20px !important;
            border: none !important;
            outline: none !important;
        }

        /* Override ainda mais específico */
        .modal-content.new-appointment-modal .modal-body.new-appointment-body {
            padding: 1px 20px 20px 20px !important;
            border: none !important;
            outline: none !important;
        }

        /* Scrollbar personalizado para o novo modal */
        .new-appointment-body::-webkit-scrollbar {
            width: 8px;
        }

        .new-appointment-body::-webkit-scrollbar-track {
            background: transparent;
            margin: 5px 0;
        }

        .new-appointment-body::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
            margin: 2px;
        }

        .new-appointment-body::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .patient-section, .appointment-section {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
            width: 100%;
            box-sizing: border-box;
        }

        .patient-section:last-child, .appointment-section:last-child {
            border-bottom: none;
        }

        .form-row {
            margin-bottom: 8px;
        }

        .patient-section .form-row {
            margin-bottom: 6px;
        }

        .patient-section .form-group {
            margin-bottom: 4px;
        }

        .patient-section .form-group label {
            margin-bottom: 4px;
        }

        .input-with-button {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .input-with-button input,
        .input-with-button select {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn-add-patient,
        .btn-add-insurance {
            background: #3B82F6;
            color: white;
            border: none;
            border-radius: 4px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-add-patient:hover,
        .btn-add-insurance:hover {
            background: #2563EB;
        }

        .toggles-row {
            display: flex;
            gap: 20px;
            margin: 8px 0;
        }

        .toggle-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-group label:first-child {
            font-size: 14px;
            color: #666;
            margin: 0;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #3B82F6;
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        .time-group {
            flex: 1;
        }

        .button-row {
            display: flex;
            gap: 12px;
            margin: 8px 0;
        }

        .btn-add-time {
            background: #3B82F6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-repeat-appointment {
            background: #E5E7EB;
            color: #374151;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-add-time:hover {
            background: #2563EB;
        }

        .btn-repeat-appointment:hover {
            background: #D1D5DB;
        }

        .full-width {
            width: 100%;
        }

        .full-width textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
        }

        .new-appointment-actions {
            padding: 12px;
            background: #F9FAFB;
            border-radius: 0 0 8px 8px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .new-appointment-actions .btn-secondary {
            background: #E5E7EB;
            color: #374151;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .new-appointment-actions .btn-primary {
            background: #10B981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .new-appointment-actions .btn-secondary:hover {
            background: #D1D5DB;
        }

        .new-appointment-actions .btn-primary:hover {
            background: #059669;
        }

        /* Status dos eventos */
        .event-confirmado {
            border-left: 4px solid #4caf50;
        }

        .event-pendente {
            border-left: 4px solid #ff9800;
        }

        .event-cancelado {
            border-left: 4px solid #f44336;
            opacity: 0.7;
        }



        /* Spinner de carregamento - cobre área de conteúdo mas não o menu superior */
        .loader-overlay-main {
            display: none;
            position: fixed;
            top: 80px; /* Deixar espaço para o menu superior (80px) */
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.95);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .spinner-main {
            border: 8px solid #e3f2fd;
            border-top: 8px solid #1976D2;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            margin-top: 20px;
            color: #1976D2;
            font-size: 1.1rem;
            font-weight: 500;
            text-align: center;
        }


        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 5px;
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .close-btn:hover {
            background: #f5f5f5;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #1976d2;
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(25, 118, 210, 0.4);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #e0e0e0;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        @media (max-width: 1200px) {
            .left-sidebar {
                width: 320px;
            }
            
            .calendar-sidebar-container {
                width: 320px;
            }
            
            .left-sidebar.calendar-collapsed {
                width: 60px;
            }
            
            .main-area {
                width: calc(100vw - 320px);
                margin-left: 320px;
            }
            
            .main-area.calendar-collapsed {
                width: calc(100vw - 60px);
                margin-left: 60px;
            }
            
            .nav-links {
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .sidebar-toggle {
                display: block;
            }
            
            .left-sidebar {
                width: 320px;
                transform: translateX(-100%);
            }
            
            .calendar-sidebar-container {
                width: 320px;
            }
            
            .left-sidebar.open {
                transform: translateX(0);
            }
            
            .main-area {
                margin-left: 0;
                width: 100vw;
            }
            
            .top-header {
                padding: 0 15px;
                height: 70px;
            }
            
            .main-area {
                margin-top: 70px;
            }
            
            .nav-links {
                display: none;
            }
            
            .nav-dropdown .dropdown-menu {
                position: static;
                opacity: 1;
                visibility: visible;
                transform: none;
                box-shadow: none;
                border: none;
                background: transparent;
            }
            
            .header-left {
                gap: 30px;
            }
            
            .content-area {
                padding: 0;
            }


            .calendar-info-container {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
                padding: 15px 20px;
            }

            .info-left {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .info-right {
                flex-wrap: wrap;
                gap: 10px;
            }

            .calendar-body {
                min-height: 400px;
                gap: 0 !important;
                row-gap: 0 !important;
            }

            .time-slot, .day-slot {
                height: 40px;
                margin-bottom: 0 !important;
                margin-top: 0 !important;
                padding-top: 0 !important;
                padding-bottom: 0 !important;
            }
        }

        @media (max-width: 480px) {
            .left-sidebar {
                flex-direction: column;
                height: auto;
                margin-top: 70px;
            }
            
            .calendar-sidebar-container {
                margin: 0;
                min-width: auto;
                box-shadow: none;
            }
            
            .content-header {
                margin-bottom: 20px;
            }
            
            .calendar-header {
                font-size: 12px;
            }

            .day-header {
                padding: 10px 5px;
            }
            
            .day-number {
                font-size: 14px;
            }

            .time-slot, .day-slot {
                height: 30px;
                font-size: 10px;
                margin-bottom: 0 !important;
                margin-top: 0 !important;
                padding-top: 0 !important;
                padding-bottom: 0 !important;
            }

            .event-block {
                font-size: 9px;
                padding: 2px 4px;
            }
        }
    </style>
</head>
<body>
    <!-- Include dos modais da agenda -->
    <div id="modais-agenda-container"></div>
    
    <div class="app-container">
        <!-- Header Superior -->
        <div class="top-header">
            <div class="header-left">
                <div class="logo-section">
                    <span style="font-size: 20px; font-weight: 600;">ParoquiaON</span>
                </div>
                <div class="nav-links">
                    <a href="index.html" class="nav-link">Minha Comunidade</a>
                    <a href="agenda.html" class="nav-link active">Agenda</a>
                    <a href="comunidades.html" class="nav-link">Comunidades</a>
                    <a href="pastorais.html" class="nav-link">Pastorais</a>
                    <a href="pilares.html" class="nav-link">Pilares</a>
                    <a href="locais.html" class="nav-link">Locais</a>
                    <a href="acoes.html" class="nav-link">Ações</a>
                    <a href="pessoas.html" class="nav-link">Pessoas</a>
                    <a href="usuarios.html" class="nav-link">Usuários</a>
                    <a href="perfil.html" class="nav-link">Perfil</a>
                    <div class="nav-dropdown">
                        <a href="#" class="nav-link dropdown-trigger">Relatórios <i class="fas fa-chevron-down"></i></a>
                        <div class="dropdown-menu">
                            <a href="recebimento.html" class="dropdown-item">Recebimento</a>
                            <a href="conferencia.html" class="dropdown-item">Conferência</a>
                            <a href="dinamico.html" class="dropdown-item">Dinâmico <span class="beta-tag">beta</span></a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="header-right">
                <div class="header-icon">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge">3</span>
                </div>
                <div class="user-avatar">A</div>
            </div>
        </div>

        <!-- Spinner Centralizado de Carregamento -->
        <div id="loader-agenda" class="loader-overlay-main">
            <div class="spinner-main"></div>
            <div class="loading-text">Carregando agenda...</div>
        </div>

        <!-- Sidebar Esquerda -->
        <div class="left-sidebar" id="leftSidebar">
            <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <div>
                <!-- Container Lateral do Calendário -->
                <div class="calendar-sidebar-container">
                    <!-- Botão Criar -->
                    <button class="create-button" onclick="openEventModal()">
                        <i class="fas fa-plus"></i>
                        Criar
                    </button>


                    <div class="calendar-sidebar-header">
                        <div class="calendar-sidebar-title">
                            <i class="fas fa-calendar-alt"></i> Calendário
                        </div>
                        <button class="calendar-collapse-btn" onclick="toggleCalendarSidebar()" title="Recolher/Expandir">
                            <i class="fas fa-chevron-left" id="calendarCollapseIcon"></i>
                        </button>
                    </div>
                    
                    <!-- Mini Calendário -->
                    <div class="mini-calendar">
                        <div class="mini-calendar-header">
                            <div class="mini-calendar-title" id="miniCalendarTitle">Agosto 2024</div>
                            <div class="mini-calendar-nav">
                                <button class="mini-nav-btn" onclick="navigateMiniCalendar(-1)">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button class="mini-nav-btn" onclick="navigateMiniCalendar(1)">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mini-calendar-weekdays">
                            <div class="mini-weekday">D</div>
                            <div class="mini-weekday">S</div>
                            <div class="mini-weekday">T</div>
                            <div class="mini-weekday">Q</div>
                            <div class="mini-weekday">Q</div>
                            <div class="mini-weekday">S</div>
                            <div class="mini-weekday">S</div>
                        </div>
                        <div class="mini-calendar-days" id="miniCalendarDays">
                            <!-- Dias serão inseridos via JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Seção de Últimos Agendamentos -->
                    <div class="recent-appointments">
                        <div class="recent-appointments-header">
                            <i class="fas fa-clock"></i> Últimos Agendamentos
                        </div>
                        <div class="appointments-list" id="recentAppointmentsList">
                            <!-- Agendamentos serão inseridos via JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Espaço em branco para não ocupar todo o container -->
                    <div style="flex: 1;"></div>
                </div>
            </div>
        </div>

        <!-- Área Principal -->
        <div class="main-area">
            <!-- Content Area -->
            <div class="content-area">
                <!-- Container de Informações -->
                <div class="calendar-info-container">
                    <div class="info-left">
                        <div class="info-location">
                            <div class="info-location-container">
                            <div class="info-location-label">Você está em:</div>
                                <div class="community-dropdown">
                                    <div class="community-dropdown-trigger">
                                        <span id="currentCommunityText">Carregando comunidades...</span>
                                        <i class="fas fa-chevron-down"></i>
                        </div>
                                    <div class="community-dropdown-menu">
                                        <a href="#" class="community-dropdown-item" data-community-id="">Todas as comunidades</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="info-right">
                        <div class="date-navigation">
                            <button class="date-nav-btn" onclick="navigateWeek(-1)" title="Semana anterior">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <div class="info-date" id="dateRange">12 - 18 outubro de 2025</div>
                            <button class="date-nav-btn" onclick="navigateWeek(1)" title="Próxima semana">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <button class="info-today-btn" onclick="goToToday()">Hoje</button>
                        
                        <div class="view-dropdown">
                            <div class="view-dropdown-trigger">
                                <span id="currentViewText">Semana</span>
                            <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="view-dropdown-menu">
                                <a href="#" class="view-dropdown-item" data-view="dia">Dia</a>
                                <a href="#" class="view-dropdown-item" data-view="semana">Semana</a>
                                <a href="#" class="view-dropdown-item" data-view="mês">Mês</a>
                                <a href="#" class="view-dropdown-item" data-view="ano">Ano</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Calendário Semanal -->
                <div class="weekly-calendar">
                    <div class="calendar-header">
                        <div class="time-column-header">Hora</div>
                        <div class="day-header" id="day0">
                            <div class="day-name">DOM</div>
                            <div class="day-number">24</div>
                    </div>
                        <div class="day-header" id="day1">
                            <div class="day-name">SEG</div>
                            <div class="day-number">25</div>
                    </div>
                        <div class="day-header" id="day2">
                            <div class="day-name">TER</div>
                            <div class="day-number">26</div>
                </div>
                        <div class="day-header today" id="day3">
                            <div class="day-name">QUA</div>
                            <div class="day-number">27</div>
                    </div>
                        <div class="day-header" id="day4">
                            <div class="day-name">QUI</div>
                            <div class="day-number">28</div>
                    </div>
                        <div class="day-header" id="day5">
                            <div class="day-name">SEX</div>
                            <div class="day-number">29</div>
                </div>
                        <div class="day-header" id="day6">
                            <div class="day-name">SAB</div>
                            <div class="day-number">30</div>
                    </div>
                </div>
                    <div class="calendar-body" id="calendarBody">
                        <!-- Horários e eventos serão inseridos via JavaScript -->
        </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Container de modais removido - modais não disponíveis -->

    <!-- Scripts -->
    <script src="scripts/auth-guard.js"></script>
    <script src="scripts/apply-auth-protection.js"></script>
    <script src="scripts/navigation.js"></script>
    
    <!-- Carregar modais dinamicamente -->
    <script>
        // Carregamento de modais removido - modais não disponíveis
    </script>
    <script src="scripts/config/api.js"></script>
    <!-- Agenda modular scripts -->
    <script src="scripts/agenda/date-utils.js"></script>
    <script src="scripts/agenda/api.js"></script>
    <script src="scripts/agenda/data-cache.js"></script>
    <script src="scripts/agenda/ui-utils.js"></script>
    <script src="scripts/agenda/selects.js"></script>
    <script>
        // Wire shims to new modules
        if (window.AgendaUI) {
            window.showToast = window.AgendaUI.showToast;
        }

        // Override: loadEventsFromApi using AgendaAPI + normalization
        window.loadEventsFromApi = async function() {
            try {
                const lista = await window.AgendaAPI.list();
                allEvents = lista.map(ev => {
                    const localNome = ev.locais?.nome || ev.local_nome || 'Local não informado';
                    const acaoNome = ev.acoes?.nome || ev.acao_nome || 'Ação não informada';
                    const responsavelNome = ev.pessoas?.nome || ev.responsavel_nome || 'Responsável não informado';
                    const comunidadeNome = ev.comunidades?.nome || ev.comunidade_nome || 'Comunidade não informada';
                    const pastoralNome = ev.pastorais?.nome || ev.pastoral_nome || 'Pastoral não informada';
                    const pilarNome = ev.pilares?.nome || ev.pilar_nome || 'Pilar não informado';
                    const usuarioLancamento = ev.usuarios?.nome || ev.usuario_lancamento_nome || 'Sistema';
                    return {
                        ...ev,
                        title: ev.titulo || ev.title || 'Agendamento sem título',
                        local_nome: localNome,
                        acao_nome: acaoNome,
                        responsavel_nome: responsavelNome,
                        comunidade_nome: comunidadeNome,
                        pastoral_nome: pastoralNome,
                        pilar_nome: pilarNome,
                        usuario_lancamento_nome: usuarioLancamento,
                        color: ev.comunidades?.cor || ev.comunidade_cor || ev.acoes?.pilares?.cor || ev.pilares?.cor || ev.cor || '#1e3a8a'
                    };
                });
                filterEventsByCommunity();
            } catch (err) {
                console.error('Erro ao carregar eventos:', err);
                if (typeof showToast === 'function') showToast('Erro ao carregar eventos', 'error');
                allEvents = [];
                events = [];
            }
        };

        // Override: deleteEvent via AgendaAPI
        window.deleteEvent = async function(eventId) {
            if (!confirm('Tem certeza que deseja excluir este evento?')) return;
            try {
                await window.AgendaAPI.remove(eventId);
                await loadEventsFromApi();
                filterEventsByCommunity();
                renderCalendar();
                updateMiniCalendar();
                updateRecentAppointments();
                if (typeof showToast === 'function') showToast('Evento excluído com sucesso!', 'success');
            } catch (err) {
                console.error('Erro ao excluir evento:', err);
                if (typeof showToast === 'function') showToast('Erro ao excluir evento', 'error');
            }
        };

        // Override: updateRecentAppointments to use AgendaUI
        window.updateRecentAppointments = function() {
            if (window.AgendaUI) {
                window.AgendaUI.updateRecentAppointments(events || []);
            }
        };

        // Override: handleEventSubmit standardizing date/time
        window.handleEventSubmit = async function(e) {
            e.preventDefault();
            const DU = window.DateUtils;
            const AC = window.AgendaCache;
            // Fallbacks locais se DateUtils não estiver disponível
            const pad2 = (n) => String(n).padStart(2, '0');
            const buildDateFromYmdHm = DU && DU.buildDateFromYmdHm ? DU.buildDateFromYmdHm : function(yyyy, mm, dd, hh, mi) {
                const d = new Date();
                d.setFullYear(Number(yyyy));
                d.setMonth(Number(mm) - 1);
                d.setDate(Number(dd));
                d.setHours(Number(hh), Number(mi), 0, 0);
                return d;
            };
            const formatLocalDateTime = DU && DU.formatLocalDateTime ? DU.formatLocalDateTime : function(date) {
                return `${date.getFullYear()}-${pad2(date.getMonth()+1)}-${pad2(date.getDate())}T${pad2(date.getHours())}:${pad2(date.getMinutes())}:${pad2(date.getSeconds())}`;
            };

            const periods = typeof window.getPeriodsData === 'function' ? window.getPeriodsData() : [];
            if (!Array.isArray(periods) || periods.length === 0) {
                if (typeof showToast === 'function') showToast('Por favor, adicione pelo menos um período.', 'error');
                return;
            }

            const horarios = periods.map(p => ({
                data: p.date,
                hora_inicio: p.startTime,
                hora_fim: p.endTime
            }));

            const dataInicio = periods[0]?.date || '';
            const formData = {
                titulo: document.getElementById('eventTitle')?.value || '',
                comunidade: document.getElementById('eventCommunity')?.value || '',
                pastoral: document.getElementById('eventPastoral')?.value || '',
                pilares: document.getElementById('eventPilares')?.value || '',
                local: document.getElementById('eventLocation')?.value || '',
                acao: document.getElementById('eventAcao')?.value || '',
                objetivo: document.getElementById('eventObjetivo')?.value || '',
                dataInicio,
                horarios,
                eventoParoquial: document.getElementById('eventParoquial')?.checked || false,
                status: 'agendado'
            };

            if (!formData.titulo || !formData.comunidade || !formData.pastoral || !formData.pilares ||
                !formData.local || !formData.acao || !formData.dataInicio || horarios.length === 0) {
                if (typeof showToast === 'function') showToast('Preencha campos obrigatórios e adicione um horário.', 'error');
                return;
            }

            // Validate times and build API payloads using DateUtils
            const eventos = [];
            for (let i = 0; i < horarios.length; i++) {
                const h = horarios[i];
                if (!h.hora_inicio || !h.hora_fim) {
                    if (typeof showToast === 'function') showToast(`Preencha os horários do slot ${i + 1}.`, 'error');
                    return;
                }
                if (h.hora_inicio >= h.hora_fim) {
                    if (typeof showToast === 'function') showToast(`Início deve ser antes do fim no slot ${i + 1}.`, 'error');
                    return;
                }
                const dateStr = h.data || formData.dataInicio; // YYYY-MM-DD
                const [y, m, d] = dateStr.split('-');
                const [sh, sm] = h.hora_inicio.split(':');
                const [eh, em] = h.hora_fim.split(':');
                const startDate = buildDateFromYmdHm(y, m, d, sh, sm);
                const endDate = buildDateFromYmdHm(y, m, d, eh, em);
                const today = new Date(); today.setHours(0,0,0,0);
                const startDay = buildDateFromYmdHm(y, m, d, 0, 0);
                if (startDay < today) {
                    if (typeof showToast === 'function') showToast('A data do evento não pode ser no passado.', 'error');
                    return;
                }
                eventos.push({
                    titulo: formData.titulo,
                    objetivo: formData.objetivo || '',
                    data_inicio: formatLocalDateTime(startDate),
                    data_fim: formatLocalDateTime(endDate),
                    local_id: parseInt(formData.local),
                    acao_id: parseInt(formData.acao),
                    responsavel_id: null,
                    comunidade_id: parseInt(formData.comunidade),
                    pastoral_id: parseInt(formData.pastoral),
                    pilar_id: parseInt(formData.pilares),
                    status_id: (AC && typeof AC.getStatusIdByName === 'function') ? AC.getStatusIdByName(formData.status) : 1,
                    evento_paroquial: formData.eventoParoquial || false
                });
            }

            try {
                const resultados = [];
                for (const evento of eventos) {
                    const { data, error } = await window.AgendaAPI.create(evento);
                    if (error) throw error;
                    resultados.push(data);
                }
                if (typeof showToast === 'function') showToast(eventos.length > 1 ? `${eventos.length} eventos criados com sucesso!` : 'Evento criado com sucesso!', 'success');
                if (typeof window.clearEventForm === 'function') window.clearEventForm();
                if (typeof window.clearAllPeriods === 'function') window.clearAllPeriods();
                if (typeof window.closeEventModal === 'function') window.closeEventModal();
                await loadEventsFromApi();
                filterEventsByCommunity();
                renderCalendar();
                updateMiniCalendar();
                updateRecentAppointments();
            } catch (error) {
                console.error('Erro ao criar evento:', error);
                if (typeof showToast === 'function') showToast('Erro ao criar evento', 'error');
            }
        };
    </script>
    
    <script>
        // Variáveis globais
        let currentDate = new Date();
        let events = [];
        let allEvents = []; // Todos os eventos (sem filtro)
        let editingEvent = null;
        let miniCalendarDate = new Date();
        let currentView = 'semana'; // 'semana' | 'mês'
        let selectedCommunityId = null; // ID da comunidade selecionada

        // Funções para controlar o spinner da agenda
        function mostrarSpinnerAgenda() {
            const spinner = document.getElementById('loader-agenda');
            if (spinner) {
                spinner.style.display = 'flex';
            }
        }
        
        function ocultarSpinnerAgenda() {
            const spinner = document.getElementById('loader-agenda');
            if (spinner) {
                spinner.style.display = 'none';
            }
        }

        // Inicializar aplicação
        document.addEventListener('DOMContentLoaded', async function() {
            // Mostrar spinner ao iniciar carregamento
            mostrarSpinnerAgenda();
            
            initializeApp();
            
            // Carregar dados em paralelo para otimizar performance
            try {
                await Promise.all([
                    loadCommunities(),
                    loadEventsFromApi()
                ]);
            } catch (error) {
                console.error('❌ Erro ao carregar dados:', error);
            } finally {
                // Ocultar spinner após carregamento (sucesso ou erro)
                ocultarSpinnerAgenda();
            }
            
            setupEventListeners();
        });

        function initializeApp() {
            updateMiniCalendar();
            renderCalendar();
            updateCurrentWeekRange();
            updateRecentAppointments();
            
            // Atualizar linha de tempo a cada minuto
            setInterval(() => {
                if (currentView === 'semana') {
                    updateWeeklyCalendar();
                }
            }, 60000); // 60 segundos
        }

        function renderCalendar() {
            if (currentView === 'dia') {
                updateDailyCalendar();
            } else if (currentView === 'mês') {
                updateMonthlyCalendar();
            } else if (currentView === 'ano') {
                updateYearlyCalendar();
            } else {
                updateWeeklyCalendar();
            }
        }

        function setupEventListeners() {
            // Toggle online removido

            // Seletor de visualização (dropdown igual ao de relatórios)
            const viewDropdownItems = document.querySelectorAll('.view-dropdown-item');
            viewDropdownItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const selectedView = this.getAttribute('data-view');
                    
                    // Atualizar texto do trigger
                    const currentViewText = document.getElementById('currentViewText');
                    if (currentViewText) {
                        currentViewText.textContent = selectedView.charAt(0).toUpperCase() + selectedView.slice(1);
                    }
                    
                    // Atualizar visualização
                    currentView = selectedView;
                    renderCalendar();
                    updateCurrentWeekRange();
                    
                    if (typeof showToast === 'function') {
                        showToast(`Visualização alterada para ${selectedView}`, 'info');
                    }
                });
            });

            // Formulário de evento - Removido (modal não disponível)

            // Event listeners removidos - modais não disponíveis

            // Fechar modal ao clicar fora - Removido (modal não disponível)

            // Presets de duração removidos - modal não disponível

            // Event listeners de status e horários removidos - modal não disponível
        }

        function updateMiniCalendar() {
            const title = document.getElementById('miniCalendarTitle');
            const daysContainer = document.getElementById('miniCalendarDays');
            
            title.textContent = miniCalendarDate.toLocaleDateString('pt-BR', { 
                month: 'long', 
                year: 'numeric' 
            });

            daysContainer.innerHTML = '';

            const year = miniCalendarDate.getFullYear();
            const month = miniCalendarDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'mini-day';
                
                if (date.getMonth() !== month) {
                    dayElement.classList.add('other-month');
                }
                
                if (isToday(date)) {
                    dayElement.classList.add('selected');
                }
                
                if (hasEventsOnDate(date)) {
                    dayElement.classList.add('has-events');
                }
                
                dayElement.textContent = date.getDate();
                dayElement.addEventListener('click', () => {
                    currentDate = new Date(date);
                    renderCalendar();
                });
                
                daysContainer.appendChild(dayElement);
            }
        }

        function navigateMiniCalendar(direction) {
            miniCalendarDate.setMonth(miniCalendarDate.getMonth() + direction);
            updateMiniCalendar();
        }

        function updateWeeklyCalendar() {
            const calendarBody = document.getElementById('calendarBody');
            calendarBody.innerHTML = '';

            // Reconstruir cabeçalhos dos dias (DOM-SAB) com IDs esperados
            const header = document.querySelector('.calendar-header');
            if (header) {
                header.innerHTML = `
                    <div class="time-column-header">Hora</div>
                    <div class="day-header" id="day0"><div class="day-name">DOM</div><div class="day-number">-</div></div>
                    <div class="day-header" id="day1"><div class="day-name">SEG</div><div class="day-number">-</div></div>
                    <div class="day-header" id="day2"><div class="day-name">TER</div><div class="day-number">-</div></div>
                    <div class="day-header" id="day3"><div class="day-name">QUA</div><div class="day-number">-</div></div>
                    <div class="day-header" id="day4"><div class="day-name">QUI</div><div class="day-number">-</div></div>
                    <div class="day-header" id="day5"><div class="day-name">SEX</div><div class="day-number">-</div></div>
                    <div class="day-header" id="day6"><div class="day-name">SAB</div><div class="day-number">-</div></div>
                `;
            }

            // Calcular início da semana usando objetos Date (mais confiável)
            const weekStart = new Date(currentDate);
            weekStart.setDate(currentDate.getDate() - currentDate.getDay());
            
            console.log('🔧 Debug semana (usando Date):');
            console.log('  - currentDate:', currentDate.toDateString());
            console.log('  - weekStart:', weekStart.toDateString());

            // Atualizar cabeçalhos dos dias
            const dayNames = ['DOM', 'SEG', 'TER', 'QUA', 'QUI', 'SEX', 'SAB'];
            for (let i = 0; i < 7; i++) {
                // Criar data para cada dia da semana
                const dayDate = new Date(weekStart);
                dayDate.setDate(weekStart.getDate() + i);
                
                const dayHeader = document.getElementById(`day${i}`);
                
                dayHeader.querySelector('.day-name').textContent = dayNames[i];
                dayHeader.querySelector('.day-number').textContent = dayDate.getDate();
                
                // Remover classe today de todos
                dayHeader.classList.remove('today');
                // Adicionar classe today se for hoje
                if (isToday(dayDate)) {
                    dayHeader.classList.add('today');
                }
            }

            // Gerar horários (01:00 - 23:00)
            for (let hour = 1; hour <= 23; hour++) {
                // Coluna de hora
                const timeSlot = document.createElement('div');
                timeSlot.className = 'time-slot';
                timeSlot.textContent = `${hour.toString().padStart(2, '0')}:00`;
                calendarBody.appendChild(timeSlot);

                // Colunas dos dias
                for (let day = 0; day < 7; day++) {
                    // Criar data para cada dia da semana
                    const dayDate = new Date(weekStart);
                    dayDate.setDate(weekStart.getDate() + day);
                    
                    // Criar string da data
                    const dayString = `${dayDate.getFullYear()}-${String(dayDate.getMonth() + 1).padStart(2, '0')}-${String(dayDate.getDate()).padStart(2, '0')}`;
                    
                    if (day === 0) { // Log apenas para o primeiro dia para não poluir
                        console.log('🔧 Debug calendário (usando Date):');
                        console.log('  - weekStart:', weekStart.toDateString());
                        console.log('  - dayDate (dia 0):', dayDate.toDateString());
                        console.log('  - dayString (dia 0):', dayString);
                    }
                    
                    const daySlot = document.createElement('div');
                    daySlot.className = 'day-slot';
                    
                    // Verificar se é hoje
                    if (isToday(dayDate)) {
                        daySlot.classList.add('today');
                    }
                    
                    // Adicionar eventos para este horário usando string
                    const hourEvents = getEventsForHourByString(dayString, hour);
                    hourEvents.forEach((event, index) => {
                        const eventElement = document.createElement('div');
                        eventElement.className = 'event-block';
                        
                        // Criar estrutura do card do evento
                        const titleElement = document.createElement('div');
                        titleElement.className = 'event-title';
                        
                        // Remover horário do título se houver (para eventos antigos salvos)
                        let cleanTitle = event.title || 'Agendamento';
                        // Remover padrão antigo de horário no título: "Titulo (13:00 - 14:00)"
                        cleanTitle = cleanTitle.replace(/\s*\(\d{2}:\d{2}\s*-\s*\d{2}:\d{2}\)$/, '');
                        
                        // Adicionar ícone de paroquial se for evento paroquial
                        if (event.evento_paroquial || event.eventoParoquial) {
                            titleElement.innerHTML = `<i class="fas fa-church" style="color: #1e3a8a; margin-right: 4px;"></i>${cleanTitle}`;
                        } else {
                            titleElement.textContent = cleanTitle;
                        }
                        
                        // Elemento para data e hora
                        const datetimeElement = document.createElement('div');
                        datetimeElement.className = 'event-datetime';
                        
                        const startTime = new Date(event.startTime);
                        const endTime = new Date(event.endTime || event.startTime);
                        
                        // Formatar data usando componentes diretos
                        const dateString = `${String(startTime.getDate()).padStart(2, '0')}/${String(startTime.getMonth() + 1).padStart(2, '0')}`;
                        
                        // Formatar horários usando componentes diretos
                        const startTimeString = `${String(startTime.getHours()).padStart(2, '0')}:${String(startTime.getMinutes()).padStart(2, '0')}`;
                        const endTimeString = `${String(endTime.getHours()).padStart(2, '0')}:${String(endTime.getMinutes()).padStart(2, '0')}`;
                        
                        datetimeElement.innerHTML = `
                            <div class="event-date">${dateString}</div>
                            <div class="event-time">${startTimeString} - ${endTimeString}</div>
                        `;
                        
                        const communityElement = document.createElement('div');
                        communityElement.className = 'event-community';
                        
                        // Avatar da comunidade (foto real ou primeira letra)
                        const avatarElement = document.createElement('div');
                        avatarElement.className = 'event-avatar';
                        const communityName = event.comunidade_nome || 'Comunidade';
                        
                        // Verificar se a comunidade tem foto
                        if (event.comunidades?.foto) {
                            avatarElement.style.backgroundImage = `url(${event.comunidades.foto})`;
                            avatarElement.textContent = ''; // Remove texto quando tem foto
                        } else {
                            // Fallback para primeira letra se não tiver foto
                            avatarElement.textContent = communityName.charAt(0).toUpperCase();
                        }
                        
                        // Nome da comunidade
                        const communityNameElement = document.createElement('span');
                        communityNameElement.textContent = communityName;
                        
                        communityElement.appendChild(avatarElement);
                        communityElement.appendChild(communityNameElement);
                        
                        // Adicionar elementos ao card
                        eventElement.appendChild(titleElement);
                        eventElement.appendChild(communityElement);
                        eventElement.appendChild(datetimeElement);
                        
                        // Aplicar cor da comunidade no card (borda esquerda)
                        if (event.color) {
                            eventElement.style.borderLeft = `4px solid ${event.color}`;
                        }
                        
                        // Calcular posição e altura baseada no horário
                        const startMinutes = startTime.getMinutes();
                        const durationMinutes = (endTime.getTime() - startTime.getTime()) / (1000 * 60);
                        
                        // Calcular posição vertical (baseada nos minutos da hora)
                        const topPosition = (startMinutes / 60) * 100;
                        
                        // Calcular deslocamento horizontal para eventos simultâneos
                        let leftOffset = 0;
                        let widthPercent = 100;
                        if (hourEvents.length > 1) {
                            // Calcular largura e deslocamento baseado no índice
                            const numEvents = hourEvents.length;
                            widthPercent = 100 / numEvents;
                            leftOffset = index * widthPercent;
                        }
                        
                        // Calcular altura máxima permitida (até o final do calendário - 23h)
                        const endHour = endTime.getHours();
                        const endMinutes = endTime.getMinutes();
                        
                        console.log('Evento:', event.title, 'Início:', startTimeString, 'Fim:', endTimeString);
                        console.log('End Hour:', endHour, 'End Minutes:', endMinutes);
                        
                        // Se o evento termina após as 23h, limitar até 23:00
                        let maxHeight = (durationMinutes / 60) * 100;
                        
                        if (endHour > 23 || (endHour === 23 && endMinutes > 0)) {
                            console.log('Evento vai além das 23h - limitando altura');
                            
                            // Calcular altura máxima até 23:00
                            const maxEndTime = new Date(startTime);
                            maxEndTime.setHours(23, 0, 0, 0);
                            const maxDurationMinutes = (maxEndTime.getTime() - startTime.getTime()) / (1000 * 60);
                            maxHeight = (maxDurationMinutes / 60) * 100;
                            
                            console.log('Altura original:', (durationMinutes / 60) * 100, '%');
                            console.log('Altura limitada:', maxHeight, '%');
                            
                            // Adicionar indicador visual de que o evento continua
                            eventElement.classList.add('event-truncated');
                        } else {
                            console.log('Evento dentro do horário normal');
                        }
                        
                        eventElement.style.top = `${topPosition}%`;
                        eventElement.style.height = `${maxHeight}%`;
                        eventElement.style.left = `${leftOffset}%`;
                        eventElement.style.width = `${widthPercent}%`;
                        
                        // Marcar como passado se já terminou
                        try {
                            const now = new Date();
                            if (!isNaN(endTime) && endTime < now) {
                                eventElement.classList.add('event-past');
                            }
                        } catch (_) {}

                        eventElement.addEventListener('click', (e) => {
                            e.stopPropagation();
                            editEventModal(event);
                        });
                        
                        daySlot.appendChild(eventElement);
                    });
                    
                    daySlot.addEventListener('click', (e) => {
                        // Verificar se o clique foi diretamente no slot (não em um evento)
                        if (e.target === daySlot) {
                            // Usar a data que está sendo exibida
                            console.log('📅 Data selecionada no calendário:', dayDate.toDateString());
                            console.log('🕐 Hora selecionada:', hour);
                            console.log('📅 Data string:', dayString);
                            
                            // Criar evento para este horário específico
                            createEventForTimeSlot(dayDate, hour);
                        }
                    });
                    
                    calendarBody.appendChild(daySlot);
                }
            }
            
            // Adicionar linha de tempo atual
            addCurrentTimeLine();
        }

        function addCurrentTimeLine() {
            const calendarBody = document.getElementById('calendarBody');
            const now = new Date();
            
            // Calcular início da semana usando objetos Date
            const weekStart = new Date(currentDate);
            weekStart.setDate(currentDate.getDate() - currentDate.getDay());
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            
            // Debug: verificar se estamos na semana atual
            console.log('Data atual:', now.toDateString());
            console.log('Semana atual:', weekStart.toDateString(), 'a', weekEnd.toDateString());
            
            // Comparar usando objetos Date
            const isInCurrentWeek = now >= weekStart && now <= weekEnd;
            
            console.log('Comparação de datas:', {
                hoje: now.toDateString(),
                inicioSemana: weekStart.toDateString(),
                fimSemana: weekEnd.toDateString(),
                dentroDaSemana: isInCurrentWeek
            });
            
            if (isInCurrentWeek) {
                // Calcular posição da linha
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();
                
                console.log('Hora atual:', currentHour + ':' + currentMinute);
                
                // Verificar se está dentro do horário do calendário (1h - 23h)
                if (currentHour >= 1 && currentHour <= 23) {
                    const timeLine = document.createElement('div');
                    timeLine.className = 'current-time-line';
                    
                    // Calcular posição vertical
                    const totalMinutes = (currentHour - 1) * 60 + currentMinute;
                    const totalHours = 23; // 1h às 23h = 23 horas
                    const positionPercent = (totalMinutes / (totalHours * 60)) * 100;
                    
                    console.log('Posição vertical:', positionPercent + '%');
                    
                    timeLine.style.top = `${positionPercent}%`;
                    
                    // Calcular qual coluna do dia (0-6)
                    const dayOfWeek = now.getDay();
                    console.log('Dia da semana:', dayOfWeek);
                    
                    // Encontrar o slot do dia de hoje - corrigir lógica
                    const daySlots = calendarBody.querySelectorAll('.day-slot');
                    console.log('Total de day-slots:', daySlots.length);
                    
                    // A lógica anterior estava incorreta. Vamos encontrar o slot correto
                    // Os slots são organizados por linha (hora) e coluna (dia)
                    // Para cada hora, temos 7 slots (um para cada dia)
                    // Precisamos encontrar o slot da linha atual (hora atual) e coluna do dia
                    const currentHourIndex = currentHour - 1; // Índice da hora atual (0-22)
                    
                    // Calcular índice do slot: (hora * 7) + dia
                    const slotIndex = (currentHourIndex * 7) + dayOfWeek;
                    const targetSlot = daySlots[slotIndex];
                    
                    console.log('Índice da hora:', currentHourIndex);
                    console.log('Índice do slot:', slotIndex);
                    console.log('Slot encontrado:', targetSlot);
                    
                    if (targetSlot) {
                        targetSlot.style.position = 'relative';
                        targetSlot.appendChild(timeLine);
                        console.log('Linha de tempo adicionada!');
                    } else {
                        console.log('Slot não encontrado!');
                    }
                } else {
                    console.log('Fora do horário do calendário (1h-23h)');
                }
            } else {
                console.log('Hoje não está na semana atual');
            }
        }

        function updateMonthlyCalendar() {
            const calendarBody = document.getElementById('calendarBody');
            calendarBody.innerHTML = '';

            // Cabeçalhos dos dias (Dom-Sáb)
            const dayNames = ['DOM','SEG','TER','QUA','QUI','SEX','SAB'];
            const header = document.querySelector('.calendar-header');
            if (header) {
                header.innerHTML = '<div class="time-column-header">Dia</div>' + dayNames.map(n => `<div class="day-header"><div class="day-name">${n}</div></div>`).join('');
            }

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const start = new Date(firstDay);
            start.setDate(1 - firstDay.getDay()); // iniciar no domingo

            // 6 semanas (máximo)
            for (let week = 0; week < 6; week++) {
                // Coluna "hora" vira coluna do número da semana (ou vazia)
                const weekCell = document.createElement('div');
                weekCell.className = 'time-slot';
                weekCell.textContent = '';
                calendarBody.appendChild(weekCell);

                for (let day = 0; day < 7; day++) {
                    const date = new Date(start);
                    date.setDate(start.getDate() + week * 7 + day);

                    const cell = document.createElement('div');
                    cell.className = 'day-slot';
                    if (date.getMonth() !== month) cell.style.background = '#f9fafb';
                    if (isToday(date)) cell.classList.add('today');

                    // Cabeçalho interno: número do dia
                    const label = document.createElement('div');
                    const isTodayFlag = isToday(date);
                    label.className = isTodayFlag ? 'day-badge today-badge' : 'day-badge';
                    label.textContent = date.getDate();
                    cell.appendChild(label);

                    // Eventos do dia (mostrar como chips no topo)
                    const dayEvents = events.filter(ev => {
                        const d = new Date(ev.startTime);
                        return d.toDateString() === date.toDateString();
                    });
                    dayEvents.slice(0, 3).forEach(ev => {
                        const chip = document.createElement('div');
                        chip.style.cssText = `margin:4px; padding:2px 6px; border-radius:10px; font-size:10px; color:#fff; display:inline-block; background:${ev.color || '#1976d2'};`;
                        
                        // Remover horário do título se houver
                        let cleanTitle = ev.title || 'Evento';
                        cleanTitle = cleanTitle.replace(/\s*\(\d{2}:\d{2}\s*-\s*\d{2}:\d{2}\)$/, '');
                        chip.textContent = cleanTitle;
                        cell.appendChild(chip);
                    });

                    cell.addEventListener('click', () => {});
                    calendarBody.appendChild(cell);
                }
            }
        }

        function updateYearlyCalendar() {
            const calendarBody = document.getElementById('calendarBody');
            calendarBody.innerHTML = '';

            // Cabeçalho simples - apenas o ano
            const header = document.querySelector('.calendar-header');
            if (header) {
                header.innerHTML = `
                    <div class="time-column-header"></div>
                    <div class="day-header" style="grid-column: span 3;"><div class="day-name">${currentDate.getFullYear()}</div></div>
                `;
            }

            const year = currentDate.getFullYear();
            const months = [
                'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];

            // Criar grid 3x4 (3 colunas, 4 linhas) como Google Calendar
            for (let row = 0; row < 4; row++) {
                // Linha vazia para espaçamento
                const emptyCell = document.createElement('div');
                emptyCell.className = 'time-slot';
                emptyCell.textContent = '';
                calendarBody.appendChild(emptyCell);

                // 3 meses da linha
                for (let col = 0; col < 3; col++) {
                    const monthIndex = row * 3 + col;
                    const monthDate = new Date(year, monthIndex, 1);
                    
                    const monthCell = document.createElement('div');
                    monthCell.className = 'day-slot';
                    monthCell.style.height = '140px';
                    monthCell.style.padding = '12px';
                    monthCell.style.border = '1px solid #e0e0e0';
                    monthCell.style.cursor = 'pointer';
                    monthCell.style.transition = 'all 0.2s ease';
                    monthCell.style.display = 'flex';
                    monthCell.style.flexDirection = 'column';
                    monthCell.style.position = 'relative';

                    // Título do mês (estilo Google Calendar)
                    const monthTitle = document.createElement('div');
                    monthTitle.style.fontWeight = '500';
                    monthTitle.style.fontSize = '14px';
                    monthTitle.style.marginBottom = '8px';
                    monthTitle.style.color = '#333';
                    monthTitle.style.textAlign = 'left';
                    monthTitle.textContent = months[monthIndex];
                    monthCell.appendChild(monthTitle);

                    // Grid de dias do mês (estilo Google Calendar)
                    const daysGrid = document.createElement('div');
                    daysGrid.style.display = 'grid';
                    daysGrid.style.gridTemplateColumns = 'repeat(7, 1fr)';
                    daysGrid.style.gap = '2px';
                    daysGrid.style.flex = '1';
                    daysGrid.style.fontSize = '11px';

                    // Cabeçalhos dos dias da semana (D S T Q Q S S)
                    const weekDays = ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'];
                    weekDays.forEach(day => {
                        const dayHeader = document.createElement('div');
                        dayHeader.style.textAlign = 'center';
                        dayHeader.style.fontWeight = '500';
                        dayHeader.style.color = '#666';
                        dayHeader.style.padding = '2px';
                        dayHeader.textContent = day;
                        daysGrid.appendChild(dayHeader);
                    });

                    // Dias do mês
                    const firstDay = new Date(year, monthIndex, 1);
                    const lastDay = new Date(year, monthIndex + 1, 0);
                    const startDate = new Date(firstDay);
                    startDate.setDate(startDate.getDate() - firstDay.getDay()); // Começar no domingo

                    for (let i = 0; i < 42; i++) {
                        const date = new Date(startDate);
                        date.setDate(startDate.getDate() + i);
                        
                        const dayCell = document.createElement('div');
                        dayCell.style.textAlign = 'center';
                        dayCell.style.padding = '2px';
                        dayCell.style.cursor = 'pointer';
                        dayCell.style.borderRadius = '2px';
                        dayCell.style.fontSize = '11px';
                        
                        if (date.getMonth() !== monthIndex) {
                            dayCell.style.color = '#ccc';
                        } else {
                            dayCell.style.color = '#333';
                        }
                        
                        if (isToday(date)) {
                            dayCell.style.background = '#1976d2';
                            dayCell.style.color = 'white';
                            dayCell.style.fontWeight = 'bold';
                        }
                        
                        dayCell.textContent = date.getDate();
                        daysGrid.appendChild(dayCell);
                    }

                    monthCell.appendChild(daysGrid);

                    // Contador de eventos (estilo Google Calendar)
                    const monthEvents = events.filter(event => {
                        const eventDate = new Date(event.startTime);
                        return eventDate.getFullYear() === year && eventDate.getMonth() === monthIndex;
                    });

                    if (monthEvents.length > 0) {
                        const eventIndicator = document.createElement('div');
                        eventIndicator.style.cssText = `
                            position: absolute;
                            bottom: 8px;
                            left: 12px;
                            right: 12px;
                            font-size: 10px;
                            color: #1976d2;
                            font-weight: 500;
                            text-align: center;
                            background: rgba(25, 118, 210, 0.1);
                            padding: 2px 4px;
                            border-radius: 4px;
                        `;
                        eventIndicator.textContent = `${monthEvents.length} evento${monthEvents.length !== 1 ? 's' : ''}`;
                        monthCell.appendChild(eventIndicator);
                    }

                    // Hover effect (estilo Google Calendar)
                    monthCell.addEventListener('mouseenter', function() {
                        this.style.background = '#f8f9fa';
                        this.style.borderColor = '#1976d2';
                    });

                    monthCell.addEventListener('mouseleave', function() {
                        this.style.background = 'white';
                        this.style.borderColor = '#e0e0e0';
                    });

                    // Click para ir para o mês
                    monthCell.addEventListener('click', function() {
                        currentDate = new Date(year, monthIndex, 1);
                        currentView = 'mês';
                        renderCalendar();
                        updateCurrentWeekRange();
                    });

                    calendarBody.appendChild(monthCell);
                }
            }
        }

        function updateCurrentWeekRange() {
            const rangeElement = document.getElementById('currentWeekRange');
            if (!rangeElement) return; // Evita erro se o elemento não existir no layout
            
            // Atualizar texto do dropdown
            const currentViewText = document.getElementById('currentViewText');
            if (currentViewText) {
                currentViewText.textContent = currentView.charAt(0).toUpperCase() + currentView.slice(1);
            }
            
            if (currentView === 'dia') {
                rangeElement.textContent = currentDate.toLocaleDateString('pt-BR', { 
                    weekday: 'long',
                    day: 'numeric',
                    month: 'long', 
                    year: 'numeric' 
                });
            } else if (currentView === 'mês') {
                rangeElement.textContent = currentDate.toLocaleDateString('pt-BR', { 
                    month: 'long', 
                    year: 'numeric' 
                });
            } else if (currentView === 'ano') {
                rangeElement.textContent = currentDate.getFullYear().toString();
            } else {
                // Calcular semana usando apenas componentes
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const day = currentDate.getDate();
                const dayOfWeek = currentDate.getDay();
                
                const weekStartDay = day - dayOfWeek;
                const weekEndDay = weekStartDay + 6;
                
                const monthNames = ['janeiro', 'fevereiro', 'março', 'abril', 'maio', 'junho',
                                  'julho', 'agosto', 'setembro', 'outubro', 'novembro', 'dezembro'];
                
                rangeElement.textContent = `${weekStartDay} - ${weekEndDay} ${monthNames[month]} ${year}`;
            }
        }



        function navigateWeek(direction) {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const day = currentDate.getDate();
            
            if (currentView === 'dia') {
                currentDate = new Date(year, month, day + direction);
            } else if (currentView === 'mês') {
                currentDate = new Date(year, month + direction, day);
            } else if (currentView === 'ano') {
                currentDate = new Date(year + direction, month, day);
            } else {
                currentDate = new Date(year, month, day + (direction * 7));
            }
            renderCalendar();
            updateCurrentWeekRange();
        }

        function goToToday() {
            const now = new Date();
            currentDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            renderCalendar();
            updateCurrentWeekRange();
        }

        function isToday(date) {
            const today = new Date();
            return date.getFullYear() === today.getFullYear() &&
                   date.getMonth() === today.getMonth() &&
                   date.getDate() === today.getDate();
        }

        function hasEventsOnDate(date) {
            return events.some(event => {
                const eventDate = new Date(event.startTime);
                return eventDate.getFullYear() === date.getFullYear() &&
                       eventDate.getMonth() === date.getMonth() &&
                       eventDate.getDate() === date.getDate();
            });
        }

        function getEventsForHour(date, hour) {
            return events.filter(event => {
                const eventDate = new Date(event.startTime);
                return eventDate.getFullYear() === date.getFullYear() &&
                       eventDate.getMonth() === date.getMonth() &&
                       eventDate.getDate() === date.getDate() &&
                       eventDate.getHours() === hour;
            });
        }

        function getEventsForHourByString(dateString, hour) {
            return events.filter(event => {
                const eventDate = new Date(event.startTime);
                const eventDateString = `${eventDate.getFullYear()}-${String(eventDate.getMonth() + 1).padStart(2, '0')}-${String(eventDate.getDate()).padStart(2, '0')}`;
                return eventDateString === dateString && eventDate.getHours() === hour;
            });
        }

        function createEventForTimeSlot(selectedDate, selectedHour) {
            // Criar datas usando os componentes diretos (sem conversões)
            const year = selectedDate.getFullYear();
            const month = selectedDate.getMonth();
            const day = selectedDate.getDate();
            
            const eventDate = new Date(year, month, day, selectedHour, 0, 0);
            const endDate = new Date(year, month, day, selectedHour + 1, 0, 0);
            
            // Abrir modal com dados pré-preenchidos
            openEventModalWithTime(eventDate, endDate);
        }

        function createEventForTimeSlotByString(dateString, selectedHour) {
            console.log('🔧 createEventForTimeSlotByString - Data string:', dateString);
            console.log('🔧 createEventForTimeSlotByString - Hora:', selectedHour);
            
            // Extrair componentes da string de data
            const [year, month, day] = dateString.split('-').map(Number);
            
            // Criar datas usando componentes extraídos
            const eventDate = new Date(year, month - 1, day, selectedHour, 0, 0);
            const endDate = new Date(year, month - 1, day, selectedHour + 1, 0, 0);
            
            console.log('🔧 Data final do evento (string):', eventDate.toDateString(), eventDate.getHours() + 'h');
            console.log('🔧 Data final de fim (string):', endDate.toDateString(), endDate.getHours() + 'h');
            
            // Abrir modal com dados pré-preenchidos
            openEventModalWithTime(eventDate, endDate);
        }

        // Função movida para modais_agenda.html

        // Função movida para modais_agenda.html

        // Utilitário: inicializa selects customizados com busca no container
        function initializeCustomSelects(containerSelector) {
            const container = document.querySelector(containerSelector);
            if (!container) {
                return;
            }

            // Aplicar aos selects
            const nativeSelects = container.querySelectorAll('select');
            nativeSelects.forEach(select => {
                makeCustomSelect(select);
            });
            
            // NÃO aplicar aos campos de data - deixar como inputs nativos
            // const dateInputs = container.querySelectorAll('input[type="date"]');
            // dateInputs.forEach(input => makeCustomDateField(input));
            
            // NÃO aplicar aos campos de hora - deixar como inputs nativos
            // const timeInputs = container.querySelectorAll('input[type="time"]');
            // timeInputs.forEach(input => makeCustomTimeField(input));
        }

        // Função para recarregar todos os selects customizados
        function reloadCustomSelects(containerSelector) {
            const container = document.querySelector(containerSelector);
            if (!container) return;
            
            
            // Recarregar todos os campos customizados
            const customFields = container.querySelectorAll('.search-select-field');
            customFields.forEach(field => {
                if (field.reloadItems) {
                    field.reloadItems();
                }
            });
        }

        // Função para carregar dados do formulário
        function loadEventFormData() {
            console.log('📋 Carregando dados do formulário...');
            
            // Carregar dados se ainda não foram carregados
            if (!modalDataCache.comunidades || modalDataCache.comunidades.length === 0) {
                loadCommunities();
            }
            if (!modalDataCache.pastorais || modalDataCache.pastorais.length === 0) {
                loadPastorais();
            }
            if (!modalDataCache.pilares || modalDataCache.pilares.length === 0) {
                loadPilares();
            }
            if (!modalDataCache.acoes || modalDataCache.acoes.length === 0) {
                loadAcoes();
            }
            if (!modalDataCache.locais || modalDataCache.locais.length === 0) {
                loadLocais();
            }
            
            // Popular os selects após um pequeno delay para garantir que os dados foram carregados
            setTimeout(() => {
                populateSelectsFromCache();
            }, 100);
        }

        // Função para popular selects do modal usando dados do cache
        function populateSelectsFromCache() {
            
            // Popular select de comunidades
            const communitySelect = document.getElementById('eventCommunity');
            if (communitySelect && modalDataCache.comunidades.length > 0) {
                communitySelect.innerHTML = '<option value="">Selecione a comunidade</option>';
                modalDataCache.comunidades.forEach(comunidade => {
                    const option = document.createElement('option');
                    option.value = comunidade.id;
                    option.textContent = comunidade.nome;
                    communitySelect.appendChild(option);
                });
            }
            
            // Popular select de pastorais
            const pastoralSelect = document.getElementById('eventPastoral');
            if (pastoralSelect && modalDataCache.pastorais.length > 0) {
                pastoralSelect.innerHTML = '<option value="">Selecione a pastoral</option>';
                modalDataCache.pastorais.forEach(pastoral => {
                    const option = document.createElement('option');
                    option.value = pastoral.id;
                    option.textContent = pastoral.nome;
                    pastoralSelect.appendChild(option);
                });
            }
            
            // Popular select de pilares
            const pilarSelect = document.getElementById('eventPilares');
            if (pilarSelect && modalDataCache.pilares.length > 0) {
                pilarSelect.innerHTML = '<option value="">Selecione o pilar</option>';
                modalDataCache.pilares.forEach(pilar => {
                    const option = document.createElement('option');
                    option.value = pilar.id;
                    option.textContent = pilar.nome;
                    pilarSelect.appendChild(option);
                });
            }
            
            // Popular select de ações
            const acaoSelect = document.getElementById('eventAcao');
            if (acaoSelect && modalDataCache.acoes.length > 0) {
                acaoSelect.innerHTML = '<option value="">Selecione a ação</option>';
                modalDataCache.acoes.forEach(acao => {
                    const option = document.createElement('option');
                    option.value = acao.id;
                    option.textContent = acao.nome;
                    acaoSelect.appendChild(option);
                });
            }
            
            // Popular select de locais
            const localSelect = document.getElementById('eventLocation');
            if (localSelect && modalDataCache.locais.length > 0) {
                localSelect.innerHTML = '<option value="">Selecione o local</option>';
                modalDataCache.locais.forEach(local => {
                    const option = document.createElement('option');
                    option.value = local.id;
                    option.textContent = local.nome;
                    localSelect.appendChild(option);
                });
            }
            
            // Popular select de status
            const statusSelect = document.getElementById('eventStatus');
            if (statusSelect && modalDataCache.status && modalDataCache.status.length > 0) {
                statusSelect.innerHTML = '<option value="">Selecione o status</option>';
                modalDataCache.status.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status.nome; // Usar nome em vez de id
                    option.textContent = status.nome.charAt(0).toUpperCase() + status.nome.slice(1);
                    statusSelect.appendChild(option);
                });
            }
        }

        // Cria um campo de busca/seleção direto (substitui o select)
        function makeCustomSelect(nativeSelect) {
            if (!nativeSelect || nativeSelect.dataset.enhanced === 'true') return;
            

            // Campo de busca direto
            const field = document.createElement('div');
            field.className = 'search-select-field';

            const input = document.createElement('input');
            input.type = 'text';
            const firstOptionText = (nativeSelect.options && nativeSelect.options[0] && nativeSelect.options[0].textContent) || 'Selecione';
            input.placeholder = firstOptionText;
            const selectedOpt = nativeSelect.selectedOptions && nativeSelect.selectedOptions[0];
            input.value = selectedOpt && selectedOpt.value !== '' ? (selectedOpt.textContent || '') : '';

            // Menu de opções
            const menu = document.createElement('div');
            menu.className = 'search-select-menu';

            const list = document.createElement('div');
            list.className = 'search-select-list';

            // Monta itens iniciais
            const buildItems = () => {
                list.innerHTML = '';
                const options = Array.from(nativeSelect.options);
                
                if (options.length <= 1) {
                    // Se não há opções além do placeholder, mostrar mensagem
                    const item = document.createElement('div');
                    item.className = 'search-select-item no-options';
                    item.textContent = 'Nenhuma opção disponível';
                    list.appendChild(item);
                    return;
                }
                
                options.forEach((opt) => {
                    const text = (opt.textContent || '').trim();
                    const isPlaceholder = opt.value === '' || /^\s*selecione/i.test(text);
                    if (isPlaceholder) return;

                    const item = document.createElement('div');
                    item.className = 'search-select-item' + (opt.selected ? ' is-selected' : '');
                    item.dataset.value = opt.value;
                    item.textContent = text;
                    item.addEventListener('click', () => {
                        // Atualiza select nativo
                        nativeSelect.value = opt.value;
                        nativeSelect.dispatchEvent(new Event('change'));
                        // Atualiza UI
                        list.querySelectorAll('.search-select-item').forEach(el => el.classList.remove('is-selected'));
                        item.classList.add('is-selected');
                        input.value = opt.textContent || '';
                        field.classList.remove('open');
                    });
                    list.appendChild(item);
                });
            };
            
            // Aguardar um pouco para garantir que os dados foram carregados
            setTimeout(() => {
                buildItems();
            }, 200);
            
            // Função para recarregar itens (chamada quando dados são carregados)
            const reloadItems = () => {
                buildItems();
            };
            
            // Expor função para recarregamento externo
            field.reloadItems = reloadItems;

            // Máscara de formatação e filtragem
            input.addEventListener('input', (e) => {
                let value = e.target.value;
                
                // Aplicar máscara HH:MM apenas se estiver digitando números
                if (value.length > 0 && /^\d/.test(value)) {
                    // Remover caracteres não numéricos
                    value = value.replace(/\D/g, '');
                    
                    // Aplicar máscara HH:MM
                    if (value.length >= 2) {
                        value = value.substring(0, 2) + ':' + value.substring(2, 4);
                    }
                    
                    // Limitar a 5 caracteres (HH:MM)
                    if (value.length > 5) {
                        value = value.substring(0, 5);
                    }
                    
                    e.target.value = value;
                }
                
                // Filtragem por texto para a lista de horários
                const term = value.trim().toLowerCase();
                list.querySelectorAll('.search-select-item').forEach(item => {
                    const text = item.textContent.toLowerCase();
                    const match = text.includes(term);
                    item.style.display = match ? '' : 'none';
                });
            });

            // Abrir menu
            const openMenu = () => {
                document.querySelectorAll('#eventModal .search-select-field.open').forEach(f => {
                    if (f !== field) f.classList.remove('open');
                });
                if (!field.classList.contains('open')) {
                    field.classList.add('open');
                    list.querySelectorAll('.search-select-item').forEach(item => { item.style.display = ''; });
                    setTimeout(() => input.focus(), 0);
                }
            };

            input.addEventListener('focus', openMenu);
            input.addEventListener('click', (e) => {
                e.stopPropagation();
                openMenu();
            });

            // Fechar ao clicar fora
            document.addEventListener('click', (e) => {
                if (!field.contains(e.target)) {
                    field.classList.remove('open');
                }
            });

            // Sincronizar mudanças
            nativeSelect.addEventListener('change', () => {
                const selectedText = getSelectedOptionText(nativeSelect) || '';
                input.value = selectedText;
                list.querySelectorAll('.search-select-item').forEach(el => {
                    el.classList.toggle('is-selected', el.dataset.value === nativeSelect.value);
                });
            });

            // Substituir o select na DOM
            nativeSelect.parentNode.insertBefore(field, nativeSelect);
            field.appendChild(input);
            menu.appendChild(list);
            field.appendChild(menu);
            
            // Ocultar select original
            nativeSelect.style.display = 'none';
            nativeSelect.dataset.enhanced = 'true';
        }

        // Cria um campo de data customizado com calendário
        function makeCustomDateField(dateInput) {
            if (!dateInput || dateInput.dataset.enhanced === 'true') return;

            // Campo de busca direto
            const field = document.createElement('div');
            field.className = 'search-select-field';

            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'Selecione uma data';
            input.value = dateInput.value ? formatDateForDisplay(dateInput.value) : '';

            // Menu com calendário
            const menu = document.createElement('div');
            menu.className = 'search-select-menu';
            menu.style.width = '320px';

            const calendar = document.createElement('div');
            calendar.className = 'mini-calendar';

            // Gerar calendário
            const buildCalendar = () => {
                calendar.innerHTML = '';
                const today = new Date();
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();
                
                // Cabeçalho do calendário
                const header = document.createElement('div');
                header.className = 'calendar-header';
                
                const prevBtn = document.createElement('button');
                prevBtn.className = 'calendar-nav';
                prevBtn.type = 'button';
                prevBtn.innerHTML = '‹';
                
                const title = document.createElement('span');
                title.className = 'calendar-title';
                title.textContent = `${getMonthName(currentMonth)} ${currentYear}`;
                
                const nextBtn = document.createElement('button');
                nextBtn.className = 'calendar-nav';
                nextBtn.type = 'button';
                nextBtn.innerHTML = '›';
                
                // Navegação de mês
                let currentDisplayMonth = currentMonth;
                let currentDisplayYear = currentYear;
                
                const updateCalendar = () => {
                    title.textContent = `${getMonthName(currentDisplayMonth)} ${currentDisplayYear}`;
                    // Recriar os dias do calendário
                    const daysContainer = calendar.querySelector('.calendar-days');
                    if (daysContainer) {
                        daysContainer.innerHTML = '';
                        
                        const firstDay = new Date(currentDisplayYear, currentDisplayMonth, 1);
                        const startDate = new Date(firstDay);
                        startDate.setDate(startDate.getDate() - firstDay.getDay());

                        for (let i = 0; i < 42; i++) {
                            const day = new Date(startDate);
                            day.setDate(startDate.getDate() + i);
                            
                            const dayElement = document.createElement('div');
                            dayElement.className = 'calendar-day';
                            
                            if (day.getMonth() === currentDisplayMonth) {
                                dayElement.textContent = day.getDate();
                                dayElement.dataset.date = day.toISOString().split('T')[0];
                                
                                // Marcar hoje
                                if (day.toDateString() === today.toDateString()) {
                                    dayElement.classList.add('today');
                                }
                                
                                // Marcar selecionado
                                if (day.toISOString().split('T')[0] === dateInput.value) {
                                    dayElement.classList.add('selected');
                                }
                                
                                // Adicionar evento de clique
                                dayElement.addEventListener('click', () => {
                                    const selectedDate = dayElement.dataset.date;
                                    dateInput.value = selectedDate;
                                    dateInput.dispatchEvent(new Event('change'));
                                    input.value = formatDateForDisplay(selectedDate);
                                    field.classList.remove('open');
                                });
                            } else {
                                dayElement.classList.add('other-month');
                            }
                            
                            daysContainer.appendChild(dayElement);
                        }
                    }
                };
                
                prevBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    currentDisplayMonth--;
                    if (currentDisplayMonth < 0) {
                        currentDisplayMonth = 11;
                        currentDisplayYear--;
                    }
                    updateCalendar();
                });
                
                nextBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    currentDisplayMonth++;
                    if (currentDisplayMonth > 11) {
                        currentDisplayMonth = 0;
                        currentDisplayYear++;
                    }
                    updateCalendar();
                });
                
                header.appendChild(prevBtn);
                header.appendChild(title);
                header.appendChild(nextBtn);
                calendar.appendChild(header);

                // Dias da semana
                const weekdays = document.createElement('div');
                weekdays.className = 'calendar-weekdays';
                weekdays.innerHTML = `
                    <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div>
                    <div>Qui</div><div>Sex</div><div>Sáb</div>
                `;
                calendar.appendChild(weekdays);

                // Dias do mês
                const daysContainer = document.createElement('div');
                daysContainer.className = 'calendar-days';
                
                const firstDay = new Date(currentYear, currentMonth, 1);
                const lastDay = new Date(currentYear, currentMonth + 1, 0);
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - firstDay.getDay());

                for (let i = 0; i < 42; i++) {
                    const day = new Date(startDate);
                    day.setDate(startDate.getDate() + i);
                    
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day';
                    
                    if (day.getMonth() === currentMonth) {
                        dayElement.textContent = day.getDate();
                        dayElement.dataset.date = day.toISOString().split('T')[0];
                        
                        // Marcar hoje
                        if (day.toDateString() === today.toDateString()) {
                            dayElement.classList.add('today');
                        }
                        
                        // Marcar selecionado
                        if (day.toISOString().split('T')[0] === dateInput.value) {
                            dayElement.classList.add('selected');
                        }
                        
                        // Adicionar evento de clique
                        dayElement.addEventListener('click', () => {
                            const selectedDate = dayElement.dataset.date;
                            dateInput.value = selectedDate;
                            dateInput.dispatchEvent(new Event('change'));
                            input.value = formatDateForDisplay(selectedDate);
                            field.classList.remove('open');
                        });
                    } else {
                        dayElement.classList.add('other-month');
                    }
                    
                    daysContainer.appendChild(dayElement);
                }
                
                calendar.appendChild(daysContainer);
            };
            buildCalendar();

            // Máscara de formatação e navegação do calendário
            input.addEventListener('input', (e) => {
                let value = e.target.value;
                
                // Aplicar máscara DD/MM/AAAA apenas se estiver digitando números
                if (value.length > 0 && /^\d/.test(value)) {
                    // Remover caracteres não numéricos
                    value = value.replace(/\D/g, '');
                    
                    // Aplicar máscara DD/MM/AAAA
                    if (value.length >= 2) {
                        value = value.substring(0, 2) + '/' + value.substring(2);
                    }
                    if (value.length >= 5) {
                        value = value.substring(0, 5) + '/' + value.substring(5, 9);
                    }
                    
                    // Limitar a 10 caracteres (DD/MM/AAAA)
                    if (value.length > 10) {
                        value = value.substring(0, 10);
                    }
                    
                    e.target.value = value;
                }
                
                // Se for uma data completa, navegar para ela no calendário
                if (value.length === 10 && /^\d{2}\/\d{2}\/\d{4}$/.test(value)) {
                    const [day, month, year] = value.split('/');
                    const dayNum = parseInt(day);
                    const monthNum = parseInt(month);
                    const yearNum = parseInt(year);
                    
                    // Verificar se é uma data válida
                    if (dayNum >= 1 && dayNum <= 31 && monthNum >= 1 && monthNum <= 12 && yearNum >= 1900 && yearNum <= 2100) {
                        const dateObj = new Date(yearNum, monthNum - 1, dayNum);
                        
                        // Verificar se a data é realmente válida
                        if (dateObj.getDate() === dayNum && dateObj.getMonth() === monthNum - 1 && dateObj.getFullYear() === yearNum) {
                            // Navegar para a data no calendário
                            navigateToDate(calendar, yearNum, monthNum - 1);
                            
                            // Atualizar o input de data original
                            const isoDate = dateObj.toISOString().split('T')[0];
                            dateInput.value = isoDate;
                            dateInput.dispatchEvent(new Event('change'));
                            
                            // Atualizar seleção no calendário
                            calendar.querySelectorAll('.calendar-day').forEach(day => {
                                day.classList.toggle('selected', day.dataset.date === isoDate);
                            });
                            
                            return;
                        }
                    }
                }
                
                // Filtragem por texto para o calendário
                const term = value.trim().toLowerCase();
                const days = calendar.querySelectorAll('.calendar-day');
                days.forEach(day => {
                    if (day.dataset.date) {
                        const dayText = formatDateForDisplay(day.dataset.date).toLowerCase();
                        const match = dayText.includes(term);
                        day.style.display = match ? '' : 'none';
                    }
                });
            });

            // Abrir menu
            const openMenu = () => {
                document.querySelectorAll('#eventModal .search-select-field.open').forEach(f => {
                    if (f !== field) f.classList.remove('open');
                });
                if (!field.classList.contains('open')) {
                    field.classList.add('open');
                    // Mostrar todos os dias ao abrir
                    calendar.querySelectorAll('.calendar-day').forEach(day => { day.style.display = ''; });
                    setTimeout(() => input.focus(), 0);
                }
            };

            input.addEventListener('focus', openMenu);
            input.addEventListener('click', (e) => {
                e.stopPropagation();
                openMenu();
            });

            // Fechar ao clicar fora
            document.addEventListener('click', (e) => {
                if (!field.contains(e.target)) {
                    field.classList.remove('open');
                }
            });

            // Sincronizar mudanças simples
            dateInput.addEventListener('change', () => {
                console.log('🔍 DEBUG - dateInput change event:', {
                    dateInputValue: dateInput.value,
                    timestamp: new Date().getTime()
                });
                const displayValue = dateInput.value ? formatDateForDisplay(dateInput.value) : '';
                input.value = displayValue;
                console.log('🔍 DEBUG - input.value atualizado:', input.value);
                // Atualizar seleção no calendário
                calendar.querySelectorAll('.calendar-day').forEach(day => {
                    day.classList.toggle('selected', day.dataset.date === dateInput.value);
                });
            });

            // Substituir o input de data na DOM
            dateInput.parentNode.insertBefore(field, dateInput);
            field.appendChild(input);
            menu.appendChild(calendar);
            field.appendChild(menu);
            
            // Ocultar input original
            dateInput.style.display = 'none';
            dateInput.dataset.enhanced = 'true';
        }

        function formatDateForDisplay(dateString) {
            if (!dateString) return '';
            // Extrair componentes diretamente da string (sem conversão de timezone)
            const [year, month, day] = dateString.split('-');
            return `${day.padStart(2, '0')}/${month.padStart(2, '0')}/${year}`;
        }

        function getSelectedOptionText(selectEl) {
            const opt = selectEl.selectedOptions && selectEl.selectedOptions[0];
            return opt ? opt.textContent : '';
        }

        // Cria um campo de hora customizado com busca/seleção
        function makeCustomTimeField(timeInput) {
            if (!timeInput || timeInput.dataset.enhanced === 'true') return;

            // Campo de busca direto
            const field = document.createElement('div');
            field.className = 'search-select-field';

            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'Selecione um horário';
            input.value = timeInput.value ? formatTimeForDisplay(timeInput.value) : '';

            // Menu de opções (horários sugeridos)
            const menu = document.createElement('div');
            menu.className = 'search-select-menu';

            const list = document.createElement('div');
            list.className = 'search-select-list';

            // Gerar opções de horário
            const buildTimeOptions = () => {
                list.innerHTML = '';
                const options = [];
                
                // Gerar horários de 01:00 às 23:00 em intervalos de 30 minutos
                for (let hour = 1; hour <= 23; hour++) {
                    for (let minute = 0; minute < 60; minute += 30) {
                        const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                        options.push({
                            value: timeString,
                            text: formatTimeForDisplay(timeString)
                        });
                    }
                }

                options.forEach(opt => {
                    const item = document.createElement('div');
                    item.className = 'search-select-item' + (opt.value === timeInput.value ? ' is-selected' : '');
                    item.dataset.value = opt.value;
                    item.textContent = opt.text;
                    item.addEventListener('click', () => {
                        // Atualiza input de hora original
                        timeInput.value = opt.value;
                        timeInput.dispatchEvent(new Event('change'));
                        // Atualiza UI
                        list.querySelectorAll('.search-select-item').forEach(el => el.classList.remove('is-selected'));
                        item.classList.add('is-selected');
                        input.value = opt.text;
                        field.classList.remove('open');
                    });
                    list.appendChild(item);
                });
            };
            buildTimeOptions();

            // Máscara de formatação e filtragem
            input.addEventListener('input', (e) => {
                let value = e.target.value;
                
                // Aplicar máscara HH:MM apenas se estiver digitando números
                if (value.length > 0 && /^\d/.test(value)) {
                    // Remover caracteres não numéricos
                    value = value.replace(/\D/g, '');
                    
                    // Aplicar máscara HH:MM
                    if (value.length >= 2) {
                        value = value.substring(0, 2) + ':' + value.substring(2, 4);
                    }
                    
                    // Limitar a 5 caracteres (HH:MM)
                    if (value.length > 5) {
                        value = value.substring(0, 5);
                    }
                    
                    e.target.value = value;
                }
                
                // Filtragem por texto para a lista de horários
                const term = value.trim().toLowerCase();
                list.querySelectorAll('.search-select-item').forEach(item => {
                    const text = item.textContent.toLowerCase();
                    const match = text.includes(term);
                    item.style.display = match ? '' : 'none';
                });
            });

            // Abrir menu
            const openMenu = () => {
                document.querySelectorAll('#eventModal .search-select-field.open').forEach(f => {
                    if (f !== field) f.classList.remove('open');
                });
                if (!field.classList.contains('open')) {
                    field.classList.add('open');
                    list.querySelectorAll('.search-select-item').forEach(item => { item.style.display = ''; });
                    setTimeout(() => input.focus(), 0);
                }
            };

            input.addEventListener('focus', openMenu);
            input.addEventListener('click', (e) => {
                e.stopPropagation();
                openMenu();
            });

            // Fechar ao clicar fora
            document.addEventListener('click', (e) => {
                if (!field.contains(e.target)) {
                    field.classList.remove('open');
                }
            });

            // Sincronizar mudanças
            timeInput.addEventListener('change', () => {
                const displayValue = timeInput.value ? formatTimeForDisplay(timeInput.value) : '';
                input.value = displayValue;
                list.querySelectorAll('.search-select-item').forEach(el => {
                    el.classList.toggle('is-selected', el.dataset.value === timeInput.value);
                });
            });

            // Substituir o input de hora na DOM
            timeInput.parentNode.insertBefore(field, timeInput);
            field.appendChild(input);
            menu.appendChild(list);
            field.appendChild(menu);
            
            // Ocultar input original
            timeInput.style.display = 'none';
            timeInput.dataset.enhanced = 'true';
        }

        function formatTimeForDisplay(timeString) {
            if (!timeString) return '';
            const [hours, minutes] = timeString.split(':');
            const hour = parseInt(hours);
            const minute = parseInt(minutes);
            
            if (hour === 0 && minute === 0) return 'Meia-noite';
            if (hour === 12 && minute === 0) return 'Meio-dia';
            
            const period = hour < 12 ? 'AM' : 'PM';
            const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
            const displayMinute = minute === 0 ? '' : `:${minutes}`;
            
            return `${displayHour}${displayMinute} ${period}`;
        }

        function getMonthName(monthIndex) {
            const months = [
                'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];
            return months[monthIndex];
        }

        // Navegar para uma data específica no calendário
        function navigateToDate(calendar, year, month) {
            const header = calendar.querySelector('.calendar-header');
            const title = header.querySelector('.calendar-title');
            const daysContainer = calendar.querySelector('.calendar-days');
            
            if (!header || !title || !daysContainer) return;
            
            // Atualizar título
            title.textContent = `${getMonthName(month)} ${year}`;
            
            // Recriar os dias do calendário
            daysContainer.innerHTML = '';
            
            const firstDay = new Date(year, month, 1);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            for (let i = 0; i < 42; i++) {
                const day = new Date(startDate);
                day.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                if (day.getMonth() === month) {
                    dayElement.textContent = day.getDate();
                    dayElement.dataset.date = day.toISOString().split('T')[0];
                    
                    // Marcar hoje
                    const today = new Date();
                    if (day.toDateString() === today.toDateString()) {
                        dayElement.classList.add('today');
                    }
                    
                    // Adicionar evento de clique
                    dayElement.addEventListener('click', () => {
                        const selectedDate = dayElement.dataset.date;
                        const dateInput = calendar.closest('.search-select-field').querySelector('input[type="date"]');
                        if (dateInput) {
                            dateInput.value = selectedDate;
                            dateInput.dispatchEvent(new Event('change'));
                        }
                        calendar.closest('.search-select-field').classList.remove('open');
                    });
                } else {
                    dayElement.classList.add('other-month');
                }
                
                daysContainer.appendChild(dayElement);
            }
        }



        // Cache para dados dos selects
        let modalDataCache = {
            comunidades: [],
            pastorais: [],
            pilares: [],
            acoes: [],
            locais: []
        };

        // Função para carregar comunidades (com cache)
        // Removido: loadEventCommunities (usar AgendaCache)

        // Função para carregar pastorais (com cache)
        // Removido: loadEventPastorals (usar AgendaCache)

        // Função para carregar pilares (com cache)
        // Removido: loadEventPilares (usar AgendaCache)

        // Função para obter ID do status pelo nome
        function getStatusIdByName(statusName) {
            if (!modalDataCache.status || !statusName) {
                console.log('⚠️ Status não encontrado, usando padrão (1)');
                return 1; // Padrão: agendado
            }
            
            const status = modalDataCache.status.find(s => s.nome === statusName);
            console.log(`🔍 Buscando status: "${statusName}", encontrado:`, status);
            return status ? status.id : 1;
        }

        // Função para carregar status (com cache)
        // Removido: loadEventStatus (usar AgendaCache)

        // Função para carregar ações (com cache)
        // Removido: loadEventAcoes (usar AgendaCache)

        // Função para carregar locais (com cache)
        // Removido: loadEventLocais (usar AgendaCache)

        // Função movida para modais_agenda.html

        function clearEventForm() {
            // Limpar todos os campos do formulário
            const form = document.getElementById('eventForm');
            if (form) {
                form.reset();
                
                // Limpar campos específicos
                const fields = [
                    'eventTitle', 'eventCommunity', 'eventPastoral', 'eventPilares',
                    'eventLocation', 'eventAcao', 'eventObjetivo', 'eventDateStart',
                    'eventStatus', 'eventVisibility', 'eventReminder', 'eventCapacity'
                ];
                
                fields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.value = '';
                    }
                });

                // Limpar períodos adicionados
                clearAllPeriods();
                
                // Limpar formulário de adicionar período
                clearPeriodForm();
                
                // Limpar checkbox
                const checkbox = document.getElementById('eventParoquial');
                if (checkbox) {
                    checkbox.checked = false;
                }
                
                // Limpar toggle de status
                const toggle = document.querySelector('.status-toggle');
                if (toggle) {
                    toggle.checked = true;
                }
            }
        }

        // Função movida para modais_agenda.html

        // Removido: handleEventSubmit duplicado (usa override com módulos)

        // Removido: deleteEvent duplicado (usa override com módulos)

        async function loadCommunities() {
            try {
                const { data, error } = await window.api.get(window.endpoints.comunidades.list);
                if (error) throw error;
                const lista = Array.isArray(data) ? data : [];
                
                // Atualizar dropdown de comunidades
                const communityDropdownMenu = document.querySelector('.community-dropdown-menu');
                const currentCommunityText = document.getElementById('currentCommunityText');
                
                if (communityDropdownMenu && currentCommunityText) {
                    // Criar opção "Todas as comunidades"
                    let menuHTML = '<a href="#" class="community-dropdown-item" data-community-id="">Todas as comunidades</a>';
                    
                    // Adicionar comunidades
                    menuHTML += lista.map(comunidade => 
                        `<a href="#" class="community-dropdown-item" data-community-id="${comunidade.id}">${comunidade.nome}</a>`
                    ).join('');
                    
                    communityDropdownMenu.innerHTML = menuHTML;
                    currentCommunityText.textContent = 'Todas as comunidades';
                    
                    // Event listeners para os itens do dropdown
                    const communityItems = document.querySelectorAll('.community-dropdown-item');
                    communityItems.forEach(item => {
                        item.addEventListener('click', function(e) {
                            e.preventDefault();
                            const communityId = this.getAttribute('data-community-id');
                            const communityName = this.textContent;
                            
                            // Atualizar texto do trigger
                            currentCommunityText.textContent = communityName;
                            
                            // Atualizar filtro
                            selectedCommunityId = communityId ? parseInt(communityId) : null;
                            filterEventsByCommunity();
                            
                            if (typeof showToast === 'function') {
                                showToast(`Filtrando por: ${communityName}`, 'info');
                            }
                        });
                    });
                }
            } catch (err) {
                console.error('Erro ao carregar comunidades:', err);
                const currentCommunityText = document.getElementById('currentCommunityText');
                if (currentCommunityText) {
                    currentCommunityText.textContent = 'Erro ao carregar';
                }
            }
        }

        // Removido: loadEventsFromApi duplicado (usa override com módulos)

        function filterEventsByCommunity() {
            if (selectedCommunityId === null) {
                // Mostrar todos os eventos
                events = [...allEvents];
            } else {
                // Filtrar eventos por comunidade
                events = allEvents.filter(event => {
                    // Verificar se o evento tem vínculo com a comunidade selecionada
                    if (event.vinculos && Array.isArray(event.vinculos)) {
                        return event.vinculos.some(vinculo => 
                            vinculo.comunidade_id === selectedCommunityId
                        );
                    }
                    // Se não tem vinculos, verificar se tem comunidade_id diretamente
                    if (event.comunidade_id) {
                        return event.comunidade_id === selectedCommunityId;
                    }
                    return false;
                });
            }
            
            // Atualizar calendário
            renderCalendar();
            updateMiniCalendar();
            updateRecentAppointments();
        }

        // Removido: updateRecentAppointments duplicado (usa AgendaUI)


        // Carregar opções dos selects (Comunidade, Pastoral, Pilar, Local, Ação)
        // Removido: loadSelectOptions duplicado (usar AgendaCache/implementação central)

        // Carregar opções para um select específico (elemento já existente)
        // Removido: loadSelectOptionsForElement duplicado (usar AgendaCache/implementação central)











            







            
            
            

        // Removido: showToast duplicado (usar AgendaUI)

        function goToToday() {
            currentDate = new Date();
            currentView = 'dia';
            renderCalendar();
            updateCurrentWeekRange();
        }

        function updateDailyCalendar() {
            const calendarBody = document.getElementById('calendarBody');
            calendarBody.innerHTML = '';

            // Cabeçalho do dia (igual ao estilo da semana)
            const header = document.querySelector('.calendar-header');
            if (header) {
                const dayNames = ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado'];
                const dayName = dayNames[currentDate.getDay()];
                const dayNumber = currentDate.getDate();
                const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                const monthName = monthNames[currentDate.getMonth()];
                const year = currentDate.getFullYear();
                
                header.innerHTML = `
                    <div class="time-column-header">Hora</div>
                    <div class="day-header today" style="grid-column: span 1;">
                        <div class="day-name">${dayName}</div>
                        <div class="day-number">${dayNumber}</div>
                        <div class="day-month">${monthName} ${year}</div>
                    </div>
                `;
            }

            // Gerar horários (01:00 - 23:00) - estilo Google Calendar
            for (let hour = 1; hour <= 23; hour++) {
                // Coluna de hora (primeira coluna) - igual ao estilo da semana
                const timeSlot = document.createElement('div');
                timeSlot.className = 'time-slot';
                timeSlot.textContent = `${hour.toString().padStart(2, '0')}:00`;
                calendarBody.appendChild(timeSlot);

                // Coluna do dia (segunda coluna) - igual ao estilo da semana
                const daySlot = document.createElement('div');
                daySlot.className = 'day-slot';
                
                // Adicionar eventos para este horário - igual ao estilo da semana
                const hourEvents = getEventsForHour(currentDate, hour);
                hourEvents.forEach(event => {
                    const eventElement = document.createElement('div');
                    eventElement.className = 'event-item';
                    // Past marker for daily view
                    try {
                        const endTime = new Date(event.endTime || event.startTime);
                        if (!isNaN(endTime) && endTime < new Date()) {
                            eventElement.classList.add('event-past');
                        }
                    } catch (_) {}
                    eventElement.textContent = event.title || 'Evento';
                    eventElement.title = `${event.title || 'Evento'}\n${event.time || ''}\n${event.location || ''}`;
                    eventElement.addEventListener('click', (e) => {
                        e.stopPropagation();
                        editEvent(event);
                    });
                    daySlot.appendChild(eventElement);
                });

                // Adicionar click para criar evento
                daySlot.addEventListener('click', (e) => {
                    if (e.target === daySlot) {
                    }
                });

                calendarBody.appendChild(daySlot);
            }
        }

        // Adicionar estilos de animação
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Função para toggle da sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('leftSidebar');
            const toggle = document.getElementById('sidebarToggle');
            
            if (sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
                toggle.innerHTML = '<i class="fas fa-bars"></i>';
            } else {
                sidebar.classList.add('open');
                toggle.innerHTML = '<i class="fas fa-times"></i>';
            }
        }

        // Função para toggle do calendário sidebar
        function toggleCalendarSidebar() {
            const calendarContainer = document.querySelector('.calendar-sidebar-container');
            const leftSidebar = document.getElementById('leftSidebar');
            const mainArea = document.querySelector('.main-area');
            const collapseIcon = document.getElementById('calendarCollapseIcon');
            
            if (calendarContainer.classList.contains('collapsed')) {
                calendarContainer.classList.remove('collapsed');
                leftSidebar.classList.remove('calendar-collapsed');
                if (mainArea) mainArea.classList.remove('calendar-collapsed');
                collapseIcon.className = 'fas fa-chevron-left';
            } else {
                calendarContainer.classList.add('collapsed');
                leftSidebar.classList.add('calendar-collapsed');
                if (mainArea) mainArea.classList.add('calendar-collapsed');
                collapseIcon.className = 'fas fa-chevron-right';
            }
        }

        // Fechar sidebar ao clicar fora dela em mobile
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('leftSidebar');
            const toggle = document.getElementById('sidebarToggle');
            
            if (window.innerWidth <= 768 && 
                !sidebar.contains(event.target) && 
                !toggle.contains(event.target) &&
                sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
                toggle.innerHTML = '<i class="fas fa-bars"></i>';
            }
        });

        // Ajustar sidebar ao redimensionar a janela
        window.addEventListener('resize', function() {
            const sidebar = document.getElementById('leftSidebar');
            const toggle = document.getElementById('sidebarToggle');
            
            if (window.innerWidth > 768) {
                sidebar.classList.remove('open');
                toggle.innerHTML = '<i class="fas fa-bars"></i>';
            }
        });

        // Carregar modais da agenda
        async function loadModaisAgenda() {
            try {
                console.log('🔄 Carregando modais da agenda...');
                const response = await fetch('modais_agenda.html');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const html = await response.text();
                const container = document.getElementById('modais-agenda-container');
                
                if (container) {
                    container.innerHTML = html;
                    console.log('✅ Modais da agenda carregados com sucesso');
                    
                    // Executar o JavaScript dos modais
                    executeModalScripts();
                    // Pré-carregar selects do modal assim que os modais estiverem no DOM
                    if (window.AgendaSelects && typeof window.AgendaSelects.populateSelectsForModal === 'function') {
                        window.AgendaSelects.populateSelectsForModal();
                    }
                    
                    // Verificar se as funções dos modais estão disponíveis
                    if (typeof openEventModal === 'function' && typeof closeEventModal === 'function') {
                        console.log('✅ Funções dos modais disponíveis');
                    } else {
                        console.warn('⚠️ Algumas funções dos modais podem não estar disponíveis');
                    }
                } else {
                    console.error('❌ Container de modais não encontrado');
                }
            } catch (error) {
                console.error('❌ Erro ao carregar modais da agenda:', error);
                // Fallback: tentar carregar novamente após um delay
                setTimeout(() => {
                    console.log('🔄 Tentando carregar modais novamente...');
                    loadModaisAgenda();
                }, 2000);
            }
        }

        // Executar scripts dos modais
        function executeModalScripts() {
            console.log('🔧 Executando scripts dos modais...');
            
            // Definir as funções dos modais no escopo global
            window.openEventModalWithTime = function(startTime, endTime) {
                console.log('🔄 Abrindo modal com horário:', startTime, endTime);
                
                // Usar o modal padrão
                openEventModal();
                
                // Preencher e adicionar período após o modal estar aberto
                setTimeout(() => {
                    // Extrair componentes das datas recebidas (sem conversões)
                    const startYear = startTime.getFullYear();
                    const startMonth = startTime.getMonth();
                    const startDay = startTime.getDate();
                    const startHour = startTime.getHours();
                    const startMinute = startTime.getMinutes();
                    
                    const endHour = endTime.getHours();
                    const endMinute = endTime.getMinutes();
                    
                    // Criar strings diretamente dos componentes
                    const dateString = `${startYear}-${String(startMonth + 1).padStart(2, '0')}-${String(startDay).padStart(2, '0')}`;
                    const startTimeString = `${String(startHour).padStart(2, '0')}:${String(startMinute).padStart(2, '0')}`;
                    const endTimeString = `${String(endHour).padStart(2, '0')}:${String(endMinute).padStart(2, '0')}`;
                    
                    const dateInput = document.getElementById('newPeriodDate');
                    const startTimeInput = document.getElementById('newPeriodStartTime');
                    const endTimeInput = document.getElementById('newPeriodEndTime');
                    
                    if (dateInput && startTimeInput && endTimeInput) {
                        console.log('🔍 DEBUG - ANTES de preencher:', {
                            dateInputValue: dateInput.value,
                            dateInputDataset: dateInput.dataset.enhanced,
                            dateString: dateString
                        });
                        
                        // Preencher campos do formulário de período
                        dateInput.value = dateString;
                        startTimeInput.value = startTimeString;
                        endTimeInput.value = endTimeString;
                        
                        console.log('🔍 DEBUG - DEPOIS de preencher:', {
                            dateInputValue: dateInput.value,
                            dateInputDataset: dateInput.dataset.enhanced
                        });
                        
                        // Forçar atualização da interface do campo de data customizado
                        console.log('🔍 DEBUG - Verificando enhanced:', dateInput.dataset.enhanced);
                        
                        if (dateInput.dataset.enhanced === 'true') {
                            const displayInput = dateInput.previousElementSibling;
                            if (displayInput && displayInput.type === 'text') {
                                const displayValue = formatDateForDisplay(dateString);
                                displayInput.value = displayValue;
                                console.log('🔍 DEBUG - displayInput atualizado:', displayValue);
                            }
                        } else {
                            // Se não está customizado, forçar evento change para atualizar qualquer campo wrapper
                            console.log('🔍 DEBUG - Campo não enhanced, despachando evento change');
                            dateInput.dispatchEvent(new Event('change', { bubbles: true }));
                            
                            // Aguardar um pouco e verificar o valor final
                            setTimeout(() => {
                                console.log('🔍 DEBUG - Valor final do campo após 50ms:', dateInput.value);
                                const displayInput = dateInput.previousElementSibling;
                                if (displayInput) {
                                    console.log('🔍 DEBUG - displayInput encontrado:', displayInput.type, displayInput.value);
                                }
                            }, 50);
                        }
                        
                        // Adicionar período automaticamente
                        if (window.addPeriod) {
                            setTimeout(() => {
                                window.addPeriod();
                            }, 100);
                        }
                    }
                }, 300);
            };

            window.openEventModal = function(date = null) {
                console.log('🔄 Abrindo modal padrão');
                mostrarSpinnerAgenda();
                
                // Limpar períodos anteriores
                if (window.clearAllPeriods) {
                    window.clearAllPeriods();
                }
                
                const modal = document.getElementById('eventModal');
                if (modal) {
                    modal.style.display = 'flex';
                    
                    if (date) {
                        const dateInput = document.getElementById('eventDateStart');
                        if (dateInput) {
                            dateInput.value = date;
                        }
                    }
                    
                    // Popular selects usando cache centralizado
                    if (window.AgendaSelects && typeof window.AgendaSelects.populateSelectsForModal === 'function') {
                        window.AgendaSelects.populateSelectsForModal();
                    } else if (typeof populateSelectsFromCache === 'function') {
                        // fallback antigo
                        populateSelectsFromCache();
                    }
                    initializeCustomSelects('#eventModal');
                    reloadCustomSelects('#eventModal');
                    ocultarSpinnerAgenda();
                    
                    // Configurar data padrão do período como hoje
                    setTimeout(() => {
                        const today = new Date().toISOString().split('T')[0];
                        const dateInput = document.getElementById('newPeriodDate');
                        if (dateInput) {
                            dateInput.value = today;
                        }
                        
                        // Adicionar event listener ao botão de adicionar período
                        const btnAddPeriod = document.getElementById('btnAddPeriod');
                        if (btnAddPeriod && !btnAddPeriod.hasAttribute('data-listener-added')) {
                            btnAddPeriod.addEventListener('click', function() {
                                console.log('🔘 Botão Adicionar Período clicado');
                                if (window.addPeriod) {
                                    window.addPeriod();
                                }
                            });
                            btnAddPeriod.setAttribute('data-listener-added', 'true');
                            console.log('✅ Event listener adicionado ao btnAddPeriod');
                        }
                        
                        // Desativar validação nativa do formulário; usamos validação customizada
                        const form = document.getElementById('eventForm');
                        if (form) {
                            form.setAttribute('novalidate', 'true');
                        }
                        
                        // Ajustar obrigatoriedade dos campos de período conforme a lista
                        if (typeof window.togglePeriodFieldsRequired === 'function') {
                            window.togglePeriodFieldsRequired();
                        }
                    }, 300);
                }
                
                // Adicionar event listener ao formulário se ainda não tiver
                const form = document.getElementById('eventForm');
                if (form && !form.hasAttribute('data-submit-listener')) {
                    form.addEventListener('submit', function(e) {
                        console.log('📝 Formulário submetido');
                        handleEventSubmit(e);
                    });
                    form.setAttribute('data-submit-listener', 'true');
                    console.log('✅ Event listener de submit adicionado ao formulário');
                }
            };

            window.closeEventModal = function() {
                console.log('🔒 Fechando modal...');
                
                const modal = document.getElementById('eventModal');
                if (modal) {
                    modal.style.display = 'none';
                    console.log('✅ Modal fechado com sucesso');
                }
            };

            window.editEventModal = function(event) {
                console.log('🔄 Abrindo modal de edição:', event);
                
                const modal = document.getElementById('modalEdicaoAgendamento');
                if (modal) {
                    modal.style.display = 'flex';
                    
                    // Preencher dados do evento
                    // Limpar horário do título para exibição
                    let cleanTitle = event.title || 'Sem título';
                    cleanTitle = cleanTitle.replace(/\s*\(\d{2}:\d{2}\s*-\s*\d{2}:\d{2}\)$/, '');
                    
                    const elements = {
                        'editEventTitle': cleanTitle,
                        'editEventDateTime': event.startTime ? new Date(event.startTime).toLocaleString('pt-BR') : 'Não informado',
                        'editEventLocal': event.local_nome || 'Não informado',
                        'editEventAcao': event.acao_nome || 'Não informado',
                        'editEventComunidade': event.comunidade_nome || 'Não informado',
                        'editEventPastoral': event.pastoral_nome || 'Não informado',
                        'editEventPilar': event.pilar_nome || 'Não informado'
                    };
                    
                    Object.entries(elements).forEach(([id, value]) => {
                        const element = document.getElementById(id);
                        if (element) element.textContent = value;
                    });
                    
                    // Mostrar objetivo se existir
                    const objetivoRow = document.getElementById('editEventObjetivoRow');
                    const objetivoSpan = document.getElementById('editEventObjetivo');
                    if (event.objetivo) {
                        if (objetivoSpan) objetivoSpan.textContent = event.objetivo;
                        if (objetivoRow) objetivoRow.style.display = 'block';
                    } else {
                        if (objetivoRow) objetivoRow.style.display = 'none';
                    }
                    
                    // Configurar botão de exclusão
                    const deleteBtn = document.getElementById('btnDeleteEvent');
                    if (deleteBtn) {
                        deleteBtn.onclick = function() {
                            deleteEvent(event.id);
                            modal.style.display = 'none';
                        };
                    }
                }
            };

            // Removido - usando a implementação global handleEventSubmit() da linha 5216
            // que já inclui suporte a múltiplos períodos via getPeriodsData()

            // Funções auxiliares - usar as implementações reais
            window.mostrarSpinnerAgenda = mostrarSpinnerAgenda;
            // Corrigido - usar função correta
            // window.esconderSpinnerAgenda não existe
            window.ocultarSpinnerAgenda = ocultarSpinnerAgenda;

            window.loadEventFormData = loadEventFormData;
            window.populateSelectsFromCache = populateSelectsFromCache;
            window.initializeCustomSelects = initializeCustomSelects;
            window.reloadCustomSelects = reloadCustomSelects;

            window.loadEventsFromApi = loadEventsFromApi;

            // Funções para múltiplos horários
            window.addTimeSlot = function() {
                const container = document.getElementById('timeSlotsContainer');
                const timeSlots = container.querySelectorAll('.time-slot');
                const newSlotIndex = timeSlots.length;
                
                const newSlot = document.createElement('div');
                newSlot.className = 'time-slot';
                newSlot.setAttribute('data-slot', newSlotIndex);
                
                newSlot.innerHTML = `
                    <div class="form-row">
                        <div class="form-group time-group">
                            <label>De: *</label>
                            <input type="time" name="hora_inicio[]" required>
                        </div>
                        <div class="form-group time-group">
                            <label>Até: *</label>
                            <input type="time" name="hora_fim[]" required>
                        </div>
                        <div class="form-group time-actions">
                            <button type="button" class="btn-remove-time">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                container.appendChild(newSlot);
                
                // Mostrar botões de remover em todos os slots
                updateRemoveButtons();
                
                // Adicionar evento de remoção
                const removeBtn = newSlot.querySelector('.btn-remove-time');
                removeBtn.addEventListener('click', function() {
                    removeTimeSlot(newSlotIndex);
                });
            };

            window.removeTimeSlot = function(slotIndex) {
                const container = document.getElementById('timeSlotsContainer');
                const timeSlots = container.querySelectorAll('.time-slot');
                
                if (timeSlots.length <= 1) {
                    alert('É necessário pelo menos um horário.');
                    return;
                }
                
                const slotToRemove = container.querySelector(`[data-slot="${slotIndex}"]`);
                if (slotToRemove) {
                    slotToRemove.remove();
                    updateRemoveButtons();
                }
            };

            window.updateRemoveButtons = function() {
                const container = document.getElementById('timeSlotsContainer');
                const timeSlots = container.querySelectorAll('.time-slot');
                const removeButtons = container.querySelectorAll('.btn-remove-time');
                
                // Mostrar/ocultar botões de remoção baseado na quantidade de slots
                removeButtons.forEach((btn, index) => {
                    if (timeSlots.length > 1) {
                        btn.style.display = 'flex';
                    } else {
                        btn.style.display = 'none';
                    }
                });
            };

            // Funções para múltiplos períodos de agendamento
            let periodsList = [];

            window.addPeriod = function() {
                const date = document.getElementById('newPeriodDate').value;
                const startTime = document.getElementById('newPeriodStartTime').value;
                const endTime = document.getElementById('newPeriodEndTime').value;

                // Validações
                if (!date || !startTime || !endTime) {
                    alert('Por favor, preencha todos os campos do período.');
                    return;
                }

                if (startTime >= endTime) {
                    alert('O horário de início deve ser anterior ao horário de fim.');
                    return;
                }

                // Verificar se já existe um período com a mesma data e horário
                const existingPeriod = periodsList.find(period => 
                    period.date === date && 
                    period.startTime === startTime && 
                    period.endTime === endTime
                );

                if (existingPeriod) {
                    alert('Já existe um período com esta data e horário.');
                    return;
                }

                // Adicionar período à lista
                const period = {
                    id: Date.now(),
                    date: date,
                    startTime: startTime,
                    endTime: endTime
                };

                periodsList.push(period);
                updatePeriodsList();
                clearPeriodForm();

                // Após adicionar o primeiro período, remover obrigatoriedade dos campos de período
                if (typeof window.togglePeriodFieldsRequired === 'function') {
                    window.togglePeriodFieldsRequired();
                }
            };

            window.removePeriod = function(periodId) {
                periodsList = periodsList.filter(period => period.id !== periodId);
                updatePeriodsList();
            };

            window.updatePeriodsList = function() {
                const periodsListElement = document.getElementById('periodsList');
                
                if (periodsList.length === 0) {
                    periodsListElement.innerHTML = `
                        <div class="no-periods-message">
                            <i class="fas fa-calendar-plus"></i>
                            <p>Nenhum período adicionado ainda.</p>
                            <small>Adicione pelo menos um período para continuar.</small>
                        </div>
                    `;
                    return;
                }

                // Ordenar períodos por data e horário (sem conversão de timezone)
                periodsList.sort((a, b) => {
                    if (a.date !== b.date) {
                        return a.date.localeCompare(b.date);
                    }
                    return a.startTime.localeCompare(b.startTime);
                });

                let html = '';
                periodsList.forEach(period => {
                    // Formatar data sem conversão de timezone
                    const formattedDate = formatDateForDisplay(period.date);
                    const formattedStartTime = period.startTime;
                    const formattedEndTime = period.endTime;
                    
                    html += `
                        <div class="period-item">
                            <div class="period-info">
                                <div class="period-date">${formattedDate}</div>
                                <div class="period-time">
                                    <i class="fas fa-clock"></i>
                                    <span class="time-range">${formattedStartTime} - ${formattedEndTime}</span>
                                </div>
                            </div>
                            <div class="period-actions">
                                <span class="periods-count">${periodsList.length}</span>
                                <button type="button" class="btn-remove-period" onclick="removePeriod(${period.id})">
                                    <i class="fas fa-trash"></i>
                                    Remover
                                </button>
                            </div>
                        </div>
                    `;
                });

                periodsListElement.innerHTML = html;
            };

            window.clearPeriodForm = function() {
                document.getElementById('newPeriodDate').value = '';
                document.getElementById('newPeriodStartTime').value = '';
                document.getElementById('newPeriodEndTime').value = '';
            };

            window.getPeriodsData = function() {
                return periodsList;
            };

            window.clearAllPeriods = function() {
                periodsList = [];
                updatePeriodsList();
                if (typeof window.togglePeriodFieldsRequired === 'function') {
                    window.togglePeriodFieldsRequired();
                }
            };

            // Alterna required/disabled nos campos de período conforme a lista
            window.togglePeriodFieldsRequired = function() {
                const dateEl = document.getElementById('newPeriodDate');
                const startEl = document.getElementById('newPeriodStartTime');
                const endEl = document.getElementById('newPeriodEndTime');
                const hasPeriods = Array.isArray(periodsList) && periodsList.length > 0;

                [dateEl, startEl, endEl].forEach((el) => {
                    if (!el) return;
                    if (hasPeriods) {
                        el.removeAttribute('required');
                    } else {
                        el.setAttribute('required', '');
                    }
                });

                // Se existirem campos antigos de data/hora únicos, também remover required deles
                const singleDate = document.getElementById('eventDateStart');
                const singleStart = document.getElementById('eventTimeStart');
                const singleEnd = document.getElementById('eventTimeEnd');
                [singleDate, singleStart, singleEnd].forEach((el) => {
                    if (!el) return;
                    if (hasPeriods) {
                        el.removeAttribute('required');
                    }
                });
            };

            // Event listeners são configurados no openEventModal() agora

            // Adicionar evento ao botão de adicionar horário
            setTimeout(() => {
                const addTimeBtn = document.getElementById('btnAddTime');
                if (addTimeBtn) {
                    addTimeBtn.addEventListener('click', window.addTimeSlot);
                }
            }, 100);

            console.log('✅ Scripts dos modais executados com sucesso');
        }

        // Função de teste para verificar se os modais estão funcionando
        function testModais() {
            console.log('🧪 Testando modais...');
            
            // Verificar se as funções existem
            const funcoes = ['openEventModal', 'closeEventModal', 'openEventModalWithTime', 'editEventModal'];
            funcoes.forEach(funcao => {
                if (typeof window[funcao] === 'function') {
                    console.log(`✅ ${funcao} está disponível`);
                } else {
                    console.log(`❌ ${funcao} NÃO está disponível`);
                }
            });
            
            // Verificar se os modais existem no DOM
            const modais = ['eventModal', 'modalNovoAgendamentoComHorario', 'modalEdicaoAgendamento'];
            modais.forEach(modal => {
                const elemento = document.getElementById(modal);
                if (elemento) {
                    console.log(`✅ Modal ${modal} encontrado no DOM`);
                } else {
                    console.log(`❌ Modal ${modal} NÃO encontrado no DOM`);
                }
            });
            
            // Testar abertura do modal
            try {
                console.log('🧪 Tentando abrir modal de teste...');
                openEventModal();
                console.log('✅ Modal aberto com sucesso!');
            } catch (error) {
                console.error('❌ Erro ao abrir modal:', error);
            }
        }

        // Carregar modais quando a página estiver pronta
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📄 DOM carregado, iniciando carregamento dos modais...');
            loadModaisAgenda();
        });
    </script>
</body>
</html>
